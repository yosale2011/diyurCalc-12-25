{% extends "base.html" %}
{% block content %}
<style>
  /* Print styles for compact A4 layout */
  @media print {
    @page {
      size: A4;
      margin: 0.5cm;

      @bottom-center {
        content: "×¢××•×“ " counter(page) " ××ª×•×š " counter(pages);
        font-size: 8pt;
        color: #666;
      }
    }

    /* Page counter for browsers that don't support @page footer */
    .page-number::after {
      content: "×¢××•×“ " counter(page) " ××ª×•×š " counter(pages);
    }

    /* Hide navigation and controls */
    .no-print,
    .tabs input[type="radio"],
    .tabs label,
    .controls,
    .header-line .muted,
    button,
    form,
    #toggleStandbyBtn {
      display: none !important;
    }

    /* Show only the chains panel and force hide others */
    .tab-panels .panel {
      display: none !important;
    }

    .tab-panels .panel-chains {
      display: block !important;
    }

    /* Compact layout */
    body {
      font-size: 9pt;
      line-height: 1.2;
      margin: 0;
      padding: 0;
    }

    .card {
      margin: 0;
      padding: 0;
      box-shadow: none;
      border: none;
    }

    /* Print header - already visible, just ensure it stays */
    .print-header {
      display: block !important;
      margin-bottom: 8px;
    }

    /* Compact header */
    .header-line {
      display: none;
    }

    .section-title {
      font-size: 14pt;
      margin: 0;
    }

    /* Compact day headers */
    .day-header {
      font-size: 10pt !important;
      margin: 2px 0 1px 0 !important;
      padding: 0 !important;
      page-break-after: avoid;
    }

    /* Hide h2 title in print (only show print header) */
    .panel-chains h2 {
      display: none;
    }

    /* Compact tables */
    table {
      width: 100%;
      font-size: 6.5pt;
      border-collapse: collapse;
      margin-bottom: 3px;
      page-break-inside: avoid;
    }

    table th {
      padding: 1px 2px;
      font-size: 6.5pt;
      font-weight: bold;
      background: #e0e0e0 !important;
      border: 0.5px solid #000;
      text-align: center;
      line-height: 1.1;
    }

    table td {
      padding: 1px 2px;
      font-size: 6.5pt;
      border: 0.5px solid #ccc;
      text-align: center;
      line-height: 1.1;
    }

    /* Make table fit better */
    table th:nth-child(1),
    table td:nth-child(1) {
      width: 8%;
    }

    table th:nth-child(2),
    table td:nth-child(2) {
      width: 8%;
    }

    table th:nth-child(3),
    table td:nth-child(3) {
      width: 10%;
    }

    table th:nth-child(4),
    table td:nth-child(4) {
      width: 8%;
    }

    table th:nth-child(5),
    table td:nth-child(5) {
      width: 7%;
    }

    table th:nth-child(6),
    table td:nth-child(6) {
      width: 8%;
    }

    table th:nth-child(7),
    table td:nth-child(7) {
      width: 15%;
    }

    table th:nth-child(8),
    table td:nth-child(8),
    table th:nth-child(9),
    table td:nth-child(9),
    table th:nth-child(10),
    table td:nth-child(10),
    table th:nth-child(11),
    table td:nth-child(11),
    table th:nth-child(12),
    table td:nth-child(12) {
      width: 6%;
    }

    table th:nth-child(13),
    table td:nth-child(13) {
      width: 7%;
    }

    /* Summary row in table */
    .panel-chains table tbody tr:last-child {
      background-color: #e0e0e0 !important;
      font-weight: bold;
      border-top: 1px solid #000 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .panel-chains table tbody tr:last-child td {
      padding: 2px 3px;
      font-size: 6.5pt;
      font-weight: bold;
      border: 0.5px solid #000;
    }

    /* Highlight the total payment cell in summary row */
    .panel-chains table tbody tr:last-child td:nth-child(4) {
      font-size: 7.5pt !important;
      color: #1a365d !important;
    }

    /* Compact cancelled standbys */
    .panel-chains>div>div[style*="background: #fef2f2"] {
      font-size: 5.5pt;
      padding: 1px 3px;
      margin-top: 1px;
      margin-bottom: 2px;
      line-height: 1.2;
    }

    /* Reduce spacing between days */
    .panel-chains .day-section {
      margin-bottom: 2px !important;
      page-break-inside: avoid;
    }

    /* Compact day headers in print */
    .panel-chains .day-header {
      font-size: 10pt !important;
      margin: 1px 0 0 0 !important;
      padding: 0 !important;
      line-height: 1.1;
    }

    /* Hide icons and emojis in print */
    span[title],
    .icon-arrow-up,
    .icon-break {
      display: none;
    }

    /* Remove emojis from print */
    .panel-chains *::before,
    .panel-chains *::after {
      content: none !important;
    }

    /* Ensure text fits */
    td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Compact segment details */
    td div {
      font-size: 6pt;
      line-height: 1.1;
      margin: 0;
      padding: 0;
    }

    /* Print-friendly colors */
    .row-standby {
      background-color: #f0f0f0 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .row-vacation {
      background-color: #e0f0f0 !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Monthly summary */
    .panel-chains>div:last-child {
      margin-top: 8px;
      page-break-before: auto;
    }

    .panel-chains>div:last-child .day-header {
      font-size: 8pt !important;
      border-bottom: 1px solid #000 !important;
      padding-bottom: 2px !important;
      margin-bottom: 2px !important;
    }

    /* Page breaks */
    .panel-chains .day-section:nth-child(3n) {
      page-break-after: auto;
    }
  }

  /* Chain row styles */
  .row-standby {
    background-color: #f8f9fa;
    color: #6c757d;
  }

  .row-vacation {
    background-color: #e6fffa;
    color: #006644;
  }

  .cell-standby-active {
    background-color: #f0f9ff;
    color: #0369a1;
  }

  .cell-standby-cancelled {
    background-color: #fef2f2;
    color: #991b1b;
  }

  /* Screen styles for summary row */
  .panel-chains table tbody tr:last-child {
    background-color: #f2f4f7;
    font-weight: bold;
  }

  .panel-chains table tbody tr:last-child td {
    border-top: 2px solid #666;
    padding: 8px 6px;
  }

  /* Compact day headers on screen */
  .panel-chains .day-header {
    font-size: 13pt;
    margin-bottom: 4px;
    color: #333;
    font-weight: bold;
  }

  /* Reduce spacing between days on screen */
  .panel-chains .day-section {
    margin-bottom: 8px;
  }
</style>
<div class="card">
  <div class="header-line">
    <h2 class="section-title">{{ person['name'] }}</h2>
    <div class="muted">
      ×¡×•×’:
      {% if person['type'] == 'permanent' %}×§×‘×•×¢
      {% elif person['type'] == 'substitute' %}××—×œ×™×£
      {% else %}{{ person['type'] or '-' }}{% endif %}
      |
      ×˜×œ×¤×•×Ÿ: {{ person['phone'] or '-' }} |
      ××™××™×™×œ: {{ person['email'] or '-' }} |
      ××¤×¢×œ: {{ person['employer_code'] or '001' }} |
      ××™×¨×‘: {{ person['meirav_code'] or '-' }}
    </div>
  </div>

  <form method="get" class="controls no-print" style="margin: 12px 0;">
    <label for="month">×—×•×“×©:</label>
    <select id="month" name="month">
      {% for m in months %}
      <option value="{{ m.month }}" {% if m.month==selected_month and m.year==selected_year %}selected{% endif %}>{{
        m.label }}</option>
      {% endfor %}
    </select>
    <label for="year">×©× ×”:</label>
    <select id="year" name="year">
      {% for y in years %}
      <option value="{{ y }}" {% if y==selected_year %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
    <button type="submit">×¢×“×›×Ÿ</button>
    {% if selected_month and selected_year %}
    <span class="muted">×—×•×“×© ××•×¦×’: {{ "%02d"|format(selected_month) }}/{{ selected_year }}</span>
    {% endif %}
  </form>

  <div class="tabs">
    <div class="no-print"
      style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border: 1px solid #cbd5e1; padding: 10px 14px; border-radius: 8px; margin-bottom: 12px;">
      <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
        <!-- Main stats -->
        <div style="display: flex; align-items: center; gap: 6px;">
          <span style="font-size: 12px; color: #64748b;">×©×¢×•×ª:</span>
          <span style="font-size: 16px; font-weight: 700; color: #1e293b;">{{ (monthly_totals.total_hours | float / 60)
            | round(1) }}</span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
          <span style="font-size: 12px; color: #64748b;">×›×•× × ×•×™×•×ª:</span>
          <span style="font-size: 16px; font-weight: 700; color: #7c3aed;">{{ total_standby_count }}</span>
        </div>
        <div style="background: #059669; border-radius: 6px; padding: 4px 10px;">
          <span style="font-size: 12px; color: rgba(255,255,255,0.85);">×œ×ª×©×œ×•×:</span>
          <span style="font-size: 16px; font-weight: 700; color: white;">{{ "{:,.2f}".format((monthly_totals.payment or
            0) + (monthly_totals.travel or 0) + (monthly_totals.extras or 0)) }}</span>
        </div>

        <div style="height: 20px; border-left: 1px solid #cbd5e1;"></div>

        <!-- Hours breakdown inline -->
        {% set hours_data = [
        ('100%', monthly_totals.calc100, '#3b82f6'),
        ('125%', monthly_totals.calc125, '#8b5cf6'),
        ('150%', monthly_totals.calc150, '#f59e0b'),
        ('175%', monthly_totals.calc175, '#ef4444'),
        ('200%', monthly_totals.calc200, '#ec4899')
        ] %}
        {% for label, minutes, color in hours_data %}
        {% set hours = (minutes | float / 60) | round(1) %}
        {% if hours > 0 %}
        <div style="
          display: flex;
          align-items: center;
          gap: 4px;
          background-color: {{ color }}15;
          border: 1px solid {{ color }}30;
          border-radius: 4px;
          padding: 2px 8px;
        ">
          <span style="font-size: 11px; color: {{ color }}; font-weight: 600;">{{ label }}</span>
          <span style="font-size: 13px; font-weight: 700; color: #1e293b;">{{ hours }}</span>
        </div>
        {% endif %}
        {% endfor %}
        {% if monthly_totals.calc_variable and monthly_totals.calc_variable > 0 %}
        <div
          style="display: flex; align-items: center; gap: 4px; background: #14b8a615; border: 1px solid #14b8a630; border-radius: 4px; padding: 2px 8px;">
          <span style="font-size: 11px; color: #14b8a6; font-weight: 600;">××©×ª× ×”</span>
          <span style="font-size: 13px; font-weight: 700; color: #1e293b;">{{ (monthly_totals.calc_variable | float /
            60) | round(1) }}</span>
        </div>
        {% endif %}
      </div>
    </div>

    <input type="radio" id="tab-shifts" name="tabset" checked>
    <label for="tab-shifts">××©××¨×•×ª</label>
    <input type="radio" id="tab-chains" name="tabset">
    <label for="tab-chains">×¤×™×¨×•×˜ ×¨×¦×¤×™×</label>
    <input type="radio" id="tab-monthly" name="tabset">
    <label for="tab-monthly">×¡×™×›×•× ×—×•×“×©×™</label>
    <input type="radio" id="tab-merav" name="tabset">
    <label for="tab-merav">×™×™×¦×•× ×©×›×¨</label>
    <input type="radio" id="tab-simple" name="tabset">
    <label for="tab-simple">×—×™×©×•×‘ ×™×©×Ÿ</label>

    <div class="tab-panels">
      <section class="panel panel-simple">
        <h2 style="margin: 0 0 20px; font-size: 20px;">×¡×™×›×•× ×œ×¤×™ ×—×™×©×•×‘ ×™×©×Ÿ</h2>
        {% set standby_per = simple_summary.standby.payment_per if simple_summary.standby.count > 0 else 0 %}
        <table style="width: 100%; max-width: 700px; font-size: 1.1em;">
          <thead>
            <tr>
              <th>×¡×•×’</th>
              <th>×›××•×ª</th>
              <th>××—×™×¨ ×œ××©××¨×ª</th>
              <th>××—×™×¨ ×›×•×œ×œ ×›×•× × ×•×ª</th>
              <th>×¡×”"×›</th>
            </tr>
          </thead>
          <tbody>
            {% set weekday_per = (simple_summary.weekday.payment / simple_summary.weekday.count) if
            simple_summary.weekday.count > 0 else 0 %}
            {% if simple_summary.weekday.count > 0 %}
            <tr style="background-color: #f8f9fa;">
              <td>××©××¨×•×ª ×—×•×œ</td>
              <td>{{ simple_summary.weekday.count }}</td>
              <td>{{ (weekday_per - standby_per) | round(0) | int }}</td>
              <td style="color: #1f6feb;">{{ weekday_per | round(0) | int }}</td>
              <td>{{ simple_summary.weekday.payment | format_currency }}</td>
            </tr>
            {% endif %}

            {% set friday_per = (simple_summary.friday.payment / simple_summary.friday.count) if
            simple_summary.friday.count > 0 else 0 %}
            {% if simple_summary.friday.count > 0 %}
            <tr style="background-color: #fff3e0;">
              <td>××©××¨×•×ª ×©×™×©×™</td>
              <td>{{ simple_summary.friday.count }}</td>
              <td>{{ (friday_per - standby_per) | round(0) | int }}</td>
              <td style="color: #1f6feb;">{{ friday_per | round(0) | int }}</td>
              <td>{{ simple_summary.friday.payment | format_currency }}</td>
            </tr>
            {% endif %}

            {% set saturday_per = (simple_summary.saturday.payment / simple_summary.saturday.count) if
            simple_summary.saturday.count > 0 else 0 %}
            {% if simple_summary.saturday.count > 0 %}
            <tr style="background-color: #e8f5e9;">
              <td>××©××¨×•×ª ×©×‘×ª</td>
              <td>{{ simple_summary.saturday.count }}</td>
              <td>{{ (saturday_per - standby_per) | round(0) | int }}</td>
              <td style="color: #1f6feb;">{{ saturday_per | round(0) | int }}</td>
              <td>{{ simple_summary.saturday.payment | format_currency }}</td>
            </tr>
            {% endif %}

            {% set night_per = (simple_summary.night.payment / simple_summary.night.count) if simple_summary.night.count
            > 0 else 0 %}
            {% if simple_summary.night.count > 0 %}
            <tr style="background-color: #e0e7ff;">
              <td>××©××¨×•×ª ×œ×™×œ×”</td>
              <td>{{ simple_summary.night.count }}</td>
              <td>{{ (night_per - standby_per) | round(0) | int }}</td>
              <td style="color: #1f6feb;">{{ night_per | round(0) | int }}</td>
              <td>{{ simple_summary.night.payment | format_currency }}</td>
            </tr>
            {% endif %}

            {% set hours_per = (simple_summary.hours.payment / simple_summary.hours.count) if simple_summary.hours.count
            > 0 else 0 %}
            {% if simple_summary.hours.count > 0 %}
            <tr style="background-color: #fef9c3;">
              <td>×©×¢×•×ª ××¢×‘×¨</td>
              <td>{{ simple_summary.hours.count }}</td>
              <td>{{ (hours_per - standby_per) | round(0) | int }}</td>
              <td style="color: #1f6feb;">{{ hours_per | round(0) | int }}</td>
              <td>{{ simple_summary.hours.payment | format_currency }}</td>
            </tr>
            {% endif %}

            {% if simple_summary.travel > 0 %}
            <tr style="background-color: #fef3c7;">
              <td>× ×¡×™×¢×•×ª</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>{{ simple_summary.travel | format_currency }}</td>
            </tr>
            {% endif %}

            {% if simple_summary.extras > 0 %}
            <tr style="background-color: #fce7f3;">
              <td>×ª×•×¡×¤×•×ª</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>{{ simple_summary.extras | format_currency }}</td>
            </tr>
            {% endif %}

            <tr style="font-weight: bold; border-top: 2px solid #333; font-size: 1.2em; background: #dbeafe;">
              <td>×¡×”"×›</td>
              <td>{{ simple_summary.weekday.count + simple_summary.friday.count + simple_summary.saturday.count +
                simple_summary.night.count + simple_summary.hours.count }}</td>
              <td>-</td>
              <td>-</td>
              <td>{{ (simple_summary.weekday.payment + simple_summary.friday.payment + simple_summary.saturday.payment +
                simple_summary.night.payment + simple_summary.hours.payment + simple_summary.travel +
                simple_summary.extras) | format_currency }}</td>
            </tr>
          </tbody>
        </table>

        <div style="margin-top: 20px; font-size: 0.9em; color: #666;">
          * ×”×—×™×©×•×‘ ××¦×™×’ ×¡×™×›×•× ×œ×¤×™ ×¡×•×’ ×”××©××¨×ª (×—×•×œ, ×©×™×©×™, ×©×‘×ª, ×œ×™×œ×”, ×©×¢×•×ª ××¢×‘×¨).<br>
          * ××—×™×¨ ×œ××©××¨×ª × ×œ×§×— ××”×ª×©×œ×•× ×”×›×•×œ×œ ×‘×“×•×— ×œ×¤×™ ×¡×•×’ ×”××©××¨×ª.<br>
          * ××—×™×¨ ×›×•×œ×œ ×›×•× × ×•×ª ××•×¡×™×£ ××ª ×ª×©×œ×•× ×”×›×•× × ×•×ª ×”×××•×¦×¢ ×œ××©××¨×ª.
        </div>
      </section>
      <section class="panel panel-shifts">
        {% if reports %}
        <table>
          <thead>
            <tr>
              <th>×ª××¨×™×š</th>
              <th>×ª×—×œ×”</th>
              <th>×¡×™×•×</th>
              <th>×¡×•×’ ××©××¨×ª</th>
              <th>×“×™×¨×”</th>
              <th>××™×©×•×¨</th>
              <th>×”×–×›××•×ª ×œ×ª×©×œ×•×</th>
            </tr>
          </thead>
          <tbody>
            {% for shift in shift_segments %}
            <tr>
              <td>{{ shift['report']['date']|human_date }}</td>
              <td>{{ shift['report']['start_time'] or '-' }}</td>
              <td>{{ shift['report']['end_time'] or '-' }}</td>
              <td>{{ shift['report']['shift_name'] or shift['report']['shift_type'] or '-' }}</td>
              <td>{{ shift['report']['apartment_name'] or shift['report']['apartment_id'] or '-' }}</td>
              <td>{{ '×××•×©×¨' if shift['report']['is_approved'] else '×××ª×™×Ÿ' }}</td>
              <td>{{ "%.2f"|format(shift['payment']) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="muted">××™×Ÿ ××©××¨×•×ª ×œ×—×•×“×© ×–×”.</div>
        {% endif %}
      </section>

      <section class="panel panel-chains">
        <div class="print-header">
          <!-- Single row: Logo on right, Title in center, Meirav code on left -->
          <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1.5px solid #000; padding-bottom: 3px; margin-bottom: 4px;">
            <!-- Right side: Logo (RTL: First child is Right) -->
            <img src="/static/logo_tzohar.jpg" style="height: 30px; width: auto;" alt="Logo" />

            <!-- Center: Title -->
            <h1 style="margin: 0; font-size: 16pt; text-align: center; flex-grow: 1;">×“×•×— ×¤×™×¨×•×˜ ×¨×¦×¤×™× - {{ person['name'] }}</h1>

            <!-- Left side: Meirav code or spacer -->
            {% if person['meirav_code'] %}
            <div style="font-size: 13pt; font-weight: bold; border: 2px solid #000; padding: 2px 8px; min-width: 80px; text-align: center;">
              ××™×¨×‘: {{ person['meirav_code'] }}
            </div>
            {% else %}
            <div style="width: 80px;"></div>
            {% endif %}
          </div>

          <!-- Second row: Month and page number -->
          <div style="display: flex; justify-content: space-between; align-items: center; font-size: 10pt; margin-bottom: 8px;">
            <div>×—×•×“×©: {{ "%02d"|format(selected_month) }}/{{ selected_year }}</div>
            <div style="font-size: 7pt; color: #888;" class="page-number"></div>
          </div>
        </div>
        <div class="no-print" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; font-size: 20px;">×“×•×— ×¤×™×¨×•×˜ ×¨×¦×¤×™×</h2>
          <div style="display: flex; gap: 8px;">
            <button type="button" id="toggleStandbyBtn" onclick="toggleStandby()"
              style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">×”×¡×ª×¨
              ×›×•× × ×•×™×•×ª</button>
            <button type="button" onclick="printReport()" class="no-print"
              style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">ğŸ–¨ï¸
              ×”×“×¤×¡ ×“×•×—</button>
            <button type="button" id="sendEmailBtn" onclick="sendEmail()" class="no-print"
              style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">ğŸ“§
              ×©×œ×— ×‘××™×™×œ</button>
          </div>
        </div>
        {% if daily_segments %}
        {% for day in daily_segments %}
        {% if day.chains and day.chains|length > 0 %}
        <div class="day-section" style="margin-bottom: 8px;">
          <div class="day-header" style="margin-bottom: 4px; font-size: 12pt; color: #333; font-weight: bold;">
            {{ day.day }} ({{ day.day_name }}, {{ day.hebrew_date }})
          </div>
          <table>
            <thead>
              <tr>
                <th>×ª×—×™×œ×ª ×¨×¦×£</th>
                <th>×¡×™×•× ×¨×¦×£</th>
                <th>×“×™×¨×”</th>
                <th>×¡×•×’</th>
                <th>×¡×”"×› ×©×¢×•×ª</th>
                <th>×ª×©×œ×•× ×¢×‘×•×“×”</th>
                <th>×¤×™×¨×•×˜ ××§×˜×¢×™×</th>
                <th>100% ××—×•×©×‘</th>
                <th>125% ××—×•×©×‘</th>
                <th>150% ××—×•×©×‘</th>
                <th>175% ××—×•×©×‘</th>
                <th>200% ××—×•×©×‘</th>
                <th>×”×¢×¨×•×ª / ×¡×™×‘×” ×œ×©×‘×™×¨×”</th>
              </tr>
            </thead>
            <tbody>
              {% for chain in day.chains %}
              <tr
                class="{% if chain.type == 'standby' %}row-standby{% elif chain.type == 'vacation' %}row-vacation{% endif %}">
                <td>
                  {{ chain.start_time }}
                  {% if chain.from_prev_day %}
                  <span title="×”××©×š ×××ª××•×œ" style="cursor: help;">â®ï¸</span>
                  {% endif %}
                </td>
                <td>{{ chain.end_time }}</td>
                <td style="font-size: 0.85em; color: #666;">{{ chain.apartment_name or '-' }}</td>
                <td>
                  {% if chain.shift_type %}
                  <strong>{{ chain.shift_type }}</strong>
                  {% elif chain.type == 'standby' %}
                  <strong>×›×•× × ×•×ª</strong>
                  {% elif chain.type == 'vacation' %}
                  <strong>×—×•×¤×©×”</strong>
                  {% else %}
                  ×¢×‘×•×“×”
                  {% endif %}
                </td>
                <td>{{ (chain.total_minutes | float / 60) | round(2) }}</td>
                <td>
                  {% if chain.type == 'standby' %}
                  -
                  {% else %}
                  {{ "%.2f"|format(chain.payment) }}
                  {% endif %}
                </td>

                {# ×¢××•×“×ª ×¤×™×¨×•×˜ ××§×˜×¢×™× #}
                <td style="font-size: 0.9em;">
                  {% if chain.type == 'standby' %}
                  -
                  {% else %}
                  {% for seg_start, seg_end, seg_label in chain.segments %}
                  <div style="white-space: nowrap;">
                    {{ seg_start }}-{{ seg_end }}
                    <span style="color: #666;">({{ seg_label }})</span>
                  </div>
                  {% endfor %}
                  {% endif %}
                </td>

                {% if chain.type == 'standby' %}
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                {% elif chain.type == 'vacation' %}
                <td colspan="5" style="text-align: center; color: #999;">-</td>
                {% else %}
                <td>{{ (chain.calc100 | float / 60) | round(2) }}</td>
                <td>{{ (chain.calc125 | float / 60) | round(2) }}</td>
                <td>{{ (chain.calc150 | float / 60) | round(2) }}</td>
                <td>{{ (chain.calc175 | float / 60) | round(2) }}</td>
                <td>{{ (chain.calc200 | float / 60) | round(2) }}</td>
                {% endif %}

                <td>
                  {% if chain.break_reason and chain.break_reason != '×›×•× × ×•×ª' and chain.break_reason != '×—×•×¤×©×”' %}
                  {{ chain.break_reason }}
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
              <!-- ×©×•×¨×ª ×¡×™×›×•× ×™×•××™ -->
              <tr style="background-color: #f2f4f7; font-weight: bold; border-top: 2px solid #666;">
                <td colspan="3" style="text-align: right; padding: 4px 6px;">
                  <strong>×¡×™×›×•×:</strong>
                </td>
                <td style="text-align: center; padding: 4px 6px; font-weight: bold; font-size: 1.1em; color: #1a365d;">
                  {{ "%.2f"|format((day.payment or 0) + (day.standby_payment or 0)) }}
                </td>
                <td style="text-align: center; padding: 4px 6px;">
                  {{ (day.total_minutes_no_standby | float / 60) | round(2) }}
                </td>
                <td style="text-align: center; padding: 4px 6px; font-size: 0.85em;">
                  {{ "%.2f"|format(day.payment or 0) }}
                </td>
                <td style="text-align: center; padding: 4px 6px; font-size: 0.85em;">
                  {{ "%.2f"|format(day.standby_payment or 0) }}
                </td>
                <td style="text-align: center; padding: 4px 6px;">{{ (day.calc100 | float / 60) | round(2) }}</td>
                <td style="text-align: center; padding: 4px 6px;">{{ (day.calc125 | float / 60) | round(2) }}</td>
                <td style="text-align: center; padding: 4px 6px;">{{ (day.calc150 | float / 60) | round(2) }}</td>
                <td style="text-align: center; padding: 4px 6px;">{{ (day.calc175 | float / 60) | round(2) }}</td>
                <td style="text-align: center; padding: 4px 6px;">{{ (day.calc200 | float / 60) | round(2) }}</td>
                <td style="text-align: center; padding: 4px 6px;">-</td>
              </tr>
            </tbody>
          </table>
          {% if day.cancelled_standbys and day.cancelled_standbys|length > 0 %}
          <div class="no-print"
            style="margin-top: 8px; padding: 8px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; font-size: 13px; color: #991b1b;">
            <strong>âš ï¸ ×›×•× × ×•×ª ×‘×•×˜×œ×”:</strong>
            {% for cs in day.cancelled_standbys %}
            ×›×•× × ×•×ª {{ cs.start // 60 }}:{{ "%02d"|format(cs.start % 60) }}-{{ cs.end // 60 }}:{{ "%02d"|format(cs.end %
            60) }}
            ×‘×•×˜×œ×” ×¢×§×‘ {{ cs.reason }}
            {% if not loop.last %} | {% endif %}
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% endif %}
        {% endfor %}

        <!-- ×¡×™×›×•× ×—×•×“×©×™ -->
        {% if daily_segments %}
        <div style="margin-top: 16px; page-break-before: auto;">
          <div class="day-header"
            style="margin-bottom: 4px; font-size: 13pt; color: #000; font-weight: bold; border-bottom: 2px solid #000;">
            ×¡×™×›×•× ×—×•×“×©×™ - {{ person['name'] }}
          </div>
          <table>
            <thead>
              <tr>
                <th>×ª×—×™×œ×ª ×¨×¦×£</th>
                <th>×¡×™×•× ×¨×¦×£</th>
                <th>×“×™×¨×”</th>
                <th>×¡×•×’</th>
                <th>×¡×”"×› ×©×¢×•×ª</th>
                <th>×ª×©×œ×•× ×¢×‘×•×“×”</th>
                <th>×¤×™×¨×•×˜ ××§×˜×¢×™×</th>
                <th>100% ××—×•×©×‘</th>
                <th>125% ××—×•×©×‘</th>
                <th>150% ××—×•×©×‘</th>
                <th>175% ××—×•×©×‘</th>
                <th>200% ××—×•×©×‘</th>
                <th>×”×¢×¨×•×ª / ×¡×™×‘×” ×œ×©×‘×™×¨×”</th>
              </tr>
            </thead>
            <tbody>
              {# ×—×™×©×•×‘ ×¡×™×›×•× ×—×•×œ ×•×©×‘×ª #}
              {% set calc100_hours = (monthly_totals.calc100 or 0) / 60 %}
              {% set calc125_hours = (monthly_totals.calc125 or 0) / 60 %}
              {% set calc150_overtime_hours = (monthly_totals.calc150_overtime or 0) / 60 %}
              {% set calc150_shabbat_hours = (monthly_totals.calc150_shabbat or 0) / 60 %}
              {% set calc175_hours = (monthly_totals.calc175 or 0) / 60 %}
              {% set calc200_hours = (monthly_totals.calc200 or 0) / 60 %}

              {% set weekday_total_hours = calc100_hours + calc125_hours + calc150_overtime_hours %}
              {% set shabbat_total_hours = calc150_shabbat_hours + calc175_hours + calc200_hours %}

              {# ×—×™×©×•×‘ ×ª×©×œ×•× ×—×•×œ ×•×©×‘×ª - ×©×™××•×© ×‘×ª×©×œ×•× ×”××—×•×©×‘ ×× ×™×©, ××—×¨×ª ×—×™×©×•×‘ ×œ×¤×™ ×©×›×¨ ××™× ×™××•× #}
              {% set payment_calc100 = monthly_totals.get('payment_calc100', 0) or 0 %}
              {% set payment_calc125 = monthly_totals.get('payment_calc125', 0) or 0 %}
              {% set payment_calc150 = monthly_totals.get('payment_calc150', 0) or 0 %}
              {% set payment_calc175 = monthly_totals.get('payment_calc175', 0) or 0 %}
              {% set payment_calc200 = monthly_totals.get('payment_calc200', 0) or 0 %}

              {# ×—×™×©×•×‘ ×ª×©×œ×•× ×—×•×œ - calc100 + calc125 + calc150_overtime (×—×œ×§ ×-calc150) #}
              {% set total_calc150_hours = calc150_overtime_hours + calc150_shabbat_hours %}
              {% if total_calc150_hours > 0 %}
              {% set calc150_overtime_ratio = calc150_overtime_hours / total_calc150_hours %}
              {% set payment_calc150_overtime = payment_calc150 * calc150_overtime_ratio %}
              {% set payment_calc150_shabbat = payment_calc150 * (1 - calc150_overtime_ratio) %}
              {% else %}
              {% set payment_calc150_overtime = 0 %}
              {% set payment_calc150_shabbat = 0 %}
              {% endif %}

              {% set weekday_payment = payment_calc100 + payment_calc125 + payment_calc150_overtime %}
              {% set shabbat_payment = payment_calc150_shabbat + payment_calc175 + payment_calc200 %}

              {# ×—×™×©×•×‘ ×›×•× × ×•×™×•×ª ×œ×¤×™ ×—×•×œ/×©×‘×ª - ×©×™××•×© ×‘-namespace ×›×™ Jinja2 ×œ× ××¢×“×›×Ÿ ××©×ª× ×™× ×‘×œ×•×œ××” #}
              {% set ns_standby = namespace(weekday=0, shabbat=0) %}
              {% if daily_segments %}
              {% for day in daily_segments %}
              {% if day.date_obj %}
              {% set day_of_week = day.date_obj.weekday() %}
              {% set day_standby = day.standby_payment or 0 %}
              {% if day_of_week == 4 or day_of_week == 5 %}
              {# ×™×•× ×©×™×©×™ (4) ××• ×©×‘×ª (5) - ×©×‘×ª #}
              {% set ns_standby.shabbat = ns_standby.shabbat + day_standby %}
              {% else %}
              {# ×—×•×œ #}
              {% set ns_standby.weekday = ns_standby.weekday + day_standby %}
              {% endif %}
              {% endif %}
              {% endfor %}
              {% endif %}
              {% set weekday_standby_payment = ns_standby.weekday %}
              {% set shabbat_standby_payment = ns_standby.shabbat %}

              {# ×©×•×¨×” ×¨××©×•× ×” - ×¡×™×›×•× ×—×•×œ #}
              <tr style="background-color: #e8f4f8; font-weight: bold; border-top: 2px solid #000;">
                <td colspan="3" style="text-align: right; padding: 6px 8px;">
                  <strong>×¡×™×›×•× ×—×•×œ:</strong>
                </td>
                <td style="text-align: center; padding: 6px 8px; font-weight: bold;">
                  {{ "%.2f"|format(weekday_payment + weekday_standby_payment) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">
                  {{ weekday_total_hours | round(2) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">
                  {{ "%.2f"|format(weekday_payment) }}
                </td>
                <td style="text-align: center; padding: 6px 8px; font-size: 0.85em;">
                  {{ "%.2f"|format(weekday_standby_payment) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">{{ calc100_hours | round(2) }}</td>
                <td style="text-align: center; padding: 6px 8px;">{{ calc125_hours | round(2) }}</td>
                <td style="text-align: center; padding: 6px 8px;">{{ calc150_overtime_hours | round(2) }}</td>
                <td style="text-align: center; padding: 6px 8px;">-</td>
                <td style="text-align: center; padding: 6px 8px;">-</td>
                <td style="text-align: center; padding: 6px 8px;">-</td>
              </tr>

              {# ×©×•×¨×” ×©× ×™×™×” - ×¡×™×›×•× ×©×‘×ª #}
              <tr style="background-color: #fff4e6; font-weight: bold; border-top: 1px solid #ccc;">
                <td colspan="3" style="text-align: right; padding: 6px 8px;">
                  <strong>×¡×™×›×•× ×©×‘×ª:</strong>
                </td>
                <td style="text-align: center; padding: 6px 8px; font-weight: bold;">
                  {{ "%.2f"|format(shabbat_payment + shabbat_standby_payment) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">
                  {{ shabbat_total_hours | round(2) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">
                  {{ "%.2f"|format(shabbat_payment) }}
                </td>
                <td style="text-align: center; padding: 6px 8px; font-size: 0.85em;">
                  {{ "%.2f"|format(shabbat_standby_payment) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">-</td>
                <td style="text-align: center; padding: 6px 8px;">-</td>
                <td style="text-align: center; padding: 6px 8px;">{{ calc150_shabbat_hours | round(2) }}</td>
                <td style="text-align: center; padding: 6px 8px;">{{ calc175_hours | round(2) }}</td>
                <td style="text-align: center; padding: 6px 8px;">{{ calc200_hours | round(2) }}</td>
                <td style="text-align: center; padding: 6px 8px;">-</td>
              </tr>

              {# ×©×•×¨×” ×©×œ×™×©×™×ª - ×¡×™×›×•× ×›×œ×œ×™ #}
              <tr style="background-color: #e0e0e0; font-weight: bold; border-top: 2px solid #000;">
                <td colspan="3" style="text-align: right; padding: 6px 8px;">
                  <strong>×¡×™×›×•× ×›×œ×œ×™:</strong>
                </td>
                <td style="text-align: center; padding: 6px 8px; font-weight: bold;">
                  {{ "%.2f"|format((monthly_totals.payment or 0) + (monthly_totals.travel or 0) + (monthly_totals.extras
                  or 0)) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">
                  {{ (monthly_totals.total_hours | float / 60) | round(2) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">
                  {{ "%.2f"|format((monthly_totals.payment or 0) - (monthly_totals.standby_payment or 0)) }}
                </td>
                <td style="text-align: center; padding: 6px 8px; font-size: 0.85em;">
                  {{ "%.2f"|format(monthly_totals.standby_payment or 0) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">{{ (monthly_totals.calc100 | float / 60) | round(2) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">{{ (monthly_totals.calc125 | float / 60) | round(2) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">{{ (monthly_totals.calc150 | float / 60) | round(2) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">{{ (monthly_totals.calc175 | float / 60) | round(2) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">{{ (monthly_totals.calc200 | float / 60) | round(2) }}
                </td>
                <td style="text-align: center; padding: 6px 8px;">-</td>
              </tr>

              {# ×©×•×¨×” × ×¤×¨×“×ª ×œ×¤×™×¨×•×˜ ××§×˜×¢×™× - ×¨×§ × ×¡×™×¢×•×ª ×•×ª×•×¡×¤×•×ª #}
              <tr style="background-color: #f5f5f5; border-top: 1px solid #ccc;">
                <td colspan="6" style="text-align: right; padding: 4px 8px; font-weight: bold; font-size: 0.9em;">
                  ×¤×™×¨×•×˜ ××§×˜×¢×™×:
                </td>
                <td colspan="7" style="text-align: right; padding: 4px 8px; font-size: 0.85em;">
                  {% if monthly_totals.travel or monthly_totals.extras %}
                  {% if monthly_totals.travel %}
                  × ×¡×™×¢×•×ª: {{ "%.2f"|format(monthly_totals.travel or 0) }}
                  {% endif %}
                  {% if monthly_totals.travel and monthly_totals.extras %} | {% endif %}
                  {% if monthly_totals.extras %}
                  ×ª×•×¡×¤×•×ª: {{ "%.2f"|format(monthly_totals.extras or 0) }}
                  {% endif %}
                  {% else %}
                  -
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        {% endif %}

        {% else %}
        <div class="muted">××™×Ÿ × ×ª×•× ×™× ×œ×—×•×“×© ×”× ×‘×—×¨.</div>
        {% endif %}
      </section>

      <section class="panel panel-monthly">
        <h2 style="margin: 0 0 20px; font-size: 20px;">×¡×™×›×•× ×—×•×“×©×™ ××¨×•×›×–</h2>
        <div
          style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
          <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">×¡×”"×› ×›×•× × ×•×™×•×ª ×—×•×“×©×™: {{
            total_standby_count }}</div>
          {% set total_cancelled = daily_segments | selectattr('cancelled_standbys') |
          map(attribute='cancelled_standbys') | map('length') | sum %}
          {% if total_cancelled > 0 %}
          <div style="font-size: 14px; margin-bottom: 10px; color: #dc2626;">
            âŒ ×›×•× × ×•×™×•×ª ×©×‘×•×˜×œ×• (×—×¤×™×¤×” ××¢×œ 70%): <strong>{{ total_cancelled }}</strong>
          </div>
          {% endif %}
          <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #6c757d;">×ª×©×œ×•× ×›×•× × ×•×™×•×ª: {{
            (monthly_totals.standby_payment or 0) | format_currency }} â‚ª</div>
          <div style="font-size: 16px; font-weight: bold; color: #1f6feb;">×¡×”"×› ×œ×ª×©×œ×•× (×¢×‘×•×“×” ×‘×œ×‘×“): {{
            (monthly_totals.payment or 0) | format_currency }} â‚ª</div>
        </div>
        {% if daily_segments %}
        <table>
          <thead>
            <tr>
              <th>×ª××¨×™×š</th>
              <th>×™×•×</th>
              <th>×¡×”"×› ×©×¢×•×ª</th>
              <th>×›×•× × ×•×ª</th>
              <th>×¡×”"×› ×œ×ª×©×œ×•×</th>
              <th>100%</th>
              <th>125%</th>
              <th>150%</th>
              <th>175%</th>
              <th>200%</th>
            </tr>
          </thead>
          <tbody>
            {% for day in daily_segments %}
            <tr>
              <td>{{ day.day }}</td>
              <td>{{ day.day_name }}</td>
              <td>{{ (day.total_minutes_no_standby | float / 60) | round(2) }}</td>
              <td
                class="{% if day.standby_payment and day.standby_payment > 0 %}cell-standby-active{% elif day.cancelled_standbys and day.cancelled_standbys|length > 0 %}cell-standby-cancelled{% endif %}">
                {% if day.standby_payment and day.standby_payment > 0 %}
                {{ "%.2f"|format(day.standby_payment) }}
                {% elif day.cancelled_standbys and day.cancelled_standbys|length > 0 %}
                <span title="×›×•× × ×•×ª ×‘×•×˜×œ×” ×¢×§×‘ ×—×¤×™×¤×” ××¢×œ 70% ×¢× ×¢×‘×•×“×”" style="cursor: help;">
                  âŒ ×‘×•×˜×œ ({{ day.cancelled_standbys|length }})
                </span>
                {% else %}
                -
                {% endif %}
              </td>
              <td>{{ "%.2f"|format(day.payment or 0) }}</td>
              <td>{{ (day.calc100 | float / 60) | round(2) }}</td>
              <td>{{ (day.calc125 | float / 60) | round(2) }}</td>
              <td>{{ (day.calc150 | float / 60) | round(2) }}</td>
              <td>{{ (day.calc175 | float / 60) | round(2) }}</td>
              <td>{{ (day.calc200 | float / 60) | round(2) }}</td>
            </tr>
            {% endfor %}
            <tr style="background-color: #e7f5ff; font-weight: bold; border-top: 2px solid #bce3ff;">
              <td colspan="2">×¡×”"×› ×›×œ×œ×™</td>
              <td>{{ (monthly_totals.total_hours | float / 60) | round(2) }}</td>
              <td style="background-color: #dbeafe;">{{ (monthly_totals.standby_payment or 0) | format_currency }}</td>
              <td>{{ "%.2f"|format(monthly_totals.payment or 0) }}</td>
              <td>{{ (monthly_totals.calc100 | float / 60) | round(2) }}</td>
              <td>{{ (monthly_totals.calc125 | float / 60) | round(2) }}</td>
              <td>{{ (monthly_totals.calc150 | float / 60) | round(2) }}</td>
              <td>{{ (monthly_totals.calc175 | float / 60) | round(2) }}</td>
              <td>{{ (monthly_totals.calc200 | float / 60) | round(2) }}</td>
            </tr>
          </tbody>
        </table>
        {% else %}
        <div class="muted">××™×Ÿ × ×ª×•× ×™× ×œ×—×•×“×© ×”× ×‘×—×¨.</div>
        {% endif %}
      </section>

      <section class="panel panel-merav">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
          <h2 style="margin: 0; font-size: 18px;">×™×™×¦×•× ×©×›×¨ ×•× ×ª×•× ×™×</h2>
          <!-- ×›×¤×ª×•×¨ ×™×™×¦×•× ×œ×’×©×¨ -->
          <a href="/export/gesher/person/{{ person.id }}?year={{ selected_year }}&month={{ selected_month }}"
            class="button"
            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; padding: 6px 14px; border-radius: 6px; font-weight: bold; font-size: 13px;">
            ğŸ“¥ ×”×•×¨×“ ×§×•×‘×¥ ×’×©×¨
          </a>
        </div>

        {% if daily_segments %}
        {% set hourly_rate = minimum_wage %}

        {# Create a lookup map for payment codes #}
        {% set codes_map = {} %}
        {% if payment_codes %}
        {% for c in payment_codes %}
        {% set _ = codes_map.update({c.internal_key: c.merav_code}) %}
        {% endfor %}
        {% endif %}

        <!-- ×©×ª×™ ×˜×‘×œ××•×ª ×–×• ×œ×¦×“ ×–×• -->
        <div
          style="display: grid; grid-template-columns: minmax(280px, 1fr) minmax(400px, 2fr); gap: 16px; align-items: start;">

          <!-- ×˜×‘×œ×” ××™× ×¤×•×¨××˜×™×‘×™×ª -->
          <div style="background: #fff; border: 1px solid #e1e4e8; border-radius: 6px; padding: 12px;">
            <h3 style="margin: 0 0 8px; font-size: 14px; color: #24292e;">× ×ª×•× ×™× ×›×œ×œ×™×™× ×•×¦×‘×™×¨×•×ª</h3>
            <table style="width: 100%; font-size: 12px;">
              <thead>
                <tr style="background-color: #f6f8fa;">
                  <th style="text-align: right;">× ×ª×•×Ÿ</th>
                  <th style="text-align: center;">×§×•×“ ××™×¨×‘</th>
                  <th style="text-align: left;">×¢×¨×š</th>
                </tr>
              </thead>
              <tbody>
                {% if payment_codes %}
                {% for code in payment_codes %}
                {% if code.display_order >= 200 %}
                {% set key = code.internal_key %}
                {% set val = monthly_totals[key] %}
                <tr>
                  <td>
                    {{ code.display_name }}
                    {% if key == 'sick_days_accrued' %}
                    <div style="font-size: 0.8em; color: #666; font-weight: normal;">
                      (×œ×¤×™ {{ monthly_totals.actual_work_days }} ×™××™ ×¢×‘×•×“×” / 21.66 * 1.5)
                    </div>
                    {% elif key == 'vacation_days_accrued' %}
                    <div style="font-size: 0.8em; color: #666; font-weight: normal;">
                      (×•×ª×§: ×©× ×” {{ monthly_totals.vacation_details.seniority }}, ×–×›××•×ª ×©× ×ª×™×ª: {{
                      monthly_totals.vacation_details.annual_quota }}, ×”×™×§×£: {{
                      monthly_totals.vacation_details.job_scope_pct }}%)
                    </div>
                    {% endif %}
                  </td>
                  <td style="text-align: center;">{{ code.merav_code or '' }}</td>
                  <td style="text-align: left; font-weight: bold;">
                    {% if key == 'actual_work_days' or key == 'vacation_days_taken' or key == 'sick_days_taken' %}
                    {{ val }}
                    {% elif key == 'total_hours' %}
                    {{ (val | float / 60) | round(2) }}
                    {% else %}
                    {{ "%.2f"|format(val or 0) }}
                    {% endif %}
                  </td>
                </tr>
                {% endif %}
                {% endfor %}
                {% else %}
                <tr>
                  <td>×¡×”"×› ×™××™ ×¢×‘×•×“×” ×‘×¤×•×¢×œ (×§×œ× ×“×¨×™×™×)</td>
                  <td style="text-align: center;"></td>
                  <td style="text-align: left; font-weight: bold;">{{ monthly_totals.actual_work_days }}</td>
                </tr>
                <tr>
                  <td>×¡×”"×› ×©×¢×•×ª ×œ×ª×©×œ×•× (×œ×œ× ×›×•× × ×•×ª)</td>
                  <td style="text-align: center;"></td>
                  <td style="text-align: left; font-weight: bold;">{{ (monthly_totals.total_hours | float / 60) |
                    round(2) }}</td>
                </tr>
                <tr>
                  <td>
                    ×–×›××•×ª ×™××™ ××—×œ×” (×—×•×“×©×™×ª)
                    <div style="font-size: 0.8em; color: #666; font-weight: normal;">
                      (×œ×¤×™ {{ monthly_totals.actual_work_days }} ×™××™ ×¢×‘×•×“×” / 21.66 * 1.5)
                    </div>
                  </td>
                  <td style="text-align: center;"></td>
                  <td style="text-align: left; font-weight: bold; color: #0366d6;">{{
                    "%.2f"|format(monthly_totals.sick_days_accrued) }}</td>
                </tr>
                <tr>
                  <td>
                    ×–×›××•×ª ×™××™ ×—×•×¤×©×” (×—×•×“×©×™×ª)
                    <div style="font-size: 0.8em; color: #666; font-weight: normal;">
                      (×•×ª×§: ×©× ×” {{ monthly_totals.vacation_details.seniority }}, ×–×›××•×ª ×©× ×ª×™×ª: {{
                      monthly_totals.vacation_details.annual_quota }}, ×”×™×§×£: {{
                      monthly_totals.vacation_details.job_scope_pct }}%)
                    </div>
                  </td>
                  <td style="text-align: center;"></td>
                  <td style="text-align: left; font-weight: bold; color: #28a745;">{{
                    "%.2f"|format(monthly_totals.vacation_days_accrued) }}</td>
                </tr>
                <tr>
                  <td>× ×™×¦×•×œ ×™××™ ×—×•×¤×©×” (×‘×¤×•×¢×œ)</td>
                  <td style="text-align: center;"></td>
                  <td style="text-align: left; font-weight: bold; color: #d73a49;">{{ monthly_totals.vacation_days_taken
                    }}</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <!-- ×˜×‘×œ×ª ×¤×™×¨×•×˜ ×¨×›×™×‘×™ ×©×›×¨ -->
          <div style="background: #fff; border: 1px solid #e1e4e8; border-radius: 6px; padding: 12px;">
            <h3 style="margin: 0 0 8px; font-size: 14px; color: #24292e;">×¤×™×¨×•×˜ ×¨×›×™×‘×™ ×©×›×¨ ×œ×ª×©×œ×•×</h3>
            {% set total_cancelled = daily_segments | selectattr('cancelled_standbys') |
            map(attribute='cancelled_standbys') | map('length') | sum %}
            <table style="width: 100%; font-size: 12px;">
              <thead>
                <tr>
                  <th>×ª×™××•×¨ ×¨×›×™×‘</th>
                  <th>×§×•×“ ××™×¨×‘</th>
                  <th>×›××•×ª (×©×¢×•×ª/×™×—×™×“×•×ª)</th>
                  <th>×ª×¢×¨×™×£ / ××—×•×–</th>
                  <th>×¡×”"×› ×œ×ª×©×œ×•×</th>
                </tr>
              </thead>
              <tbody>
                {% if payment_codes %}
                {% for code in payment_codes if code.display_order < 200 %} {% set key=code.internal_key %} {% set
                  val=monthly_totals[key] or 0 %} {# Decide if to show the row #} {% set should_show=false %} {% if
                  key=='calc150_shabbat' %} {# Show combined shabbat only if split codes don't have values or don't
                  exist #} {% if val> 0 and not (monthly_totals.calc150_shabbat_100 and
                  monthly_totals.calc150_shabbat_100 > 0 and codes_map.get('calc150_shabbat_100')) %}
                  {% set should_show = true %}
                  {% endif %}
                  {% elif val > 0 %}
                  {% set should_show = true %}
                  {% endif %}

                  {% if should_show %}
                  {% set row_style = "" %}
                  {% if key == 'calc150_shabbat_100' %}{% set row_style = "background-color: #e8f5e9;" %}
                  {% elif key == 'calc150_shabbat_50' %}{% set row_style = "background-color: #fff3e0;" %}
                  {% endif %}

                  <tr style="{{ row_style }}">
                    <td>{{ code.display_name }}</td>
                    <td>{{ code.merav_code or '' }}</td>

                    {% if key == 'standby' %}
                    {% set net_count = val - total_cancelled %}
                    <td>{{ net_count }}</td>
                    <td>
                      {% if net_count > 0 %}
                      {{ "%.2f"|format((monthly_totals.standby_payment or 0) / net_count) }} â‚ª
                      {% else %}
                      0.00 â‚ª
                      {% endif %}
                    </td>
                    <td>{{ (monthly_totals.standby_payment or 0) | format_currency }}</td>
                    {% elif key == 'vacation' %}
                    <td>{{ (val | float / 60) | round(2) }}</td>
                    <td>{{ "%.2f"|format(hourly_rate) }} â‚ª</td>
                    <td>{{ monthly_totals.vacation_payment | format_currency }}</td>
                    {% elif key == 'travel' %}
                    {# × ×¡×™×¢×•×ª - ×¡×›×•× ×™×©×™×¨ ×‘×©×§×œ×™×, ×œ× ×©×¢×•×ª #}
                    <td>-</td>
                    <td>-</td>
                    <td>{{ val | format_currency }}</td>
                    {% elif key == 'extras' %}
                    {# ×ª×•×¡×¤×•×ª - ×¡×›×•× ×™×©×™×¨ ×‘×©×§×œ×™× #}
                    <td>-</td>
                    <td>-</td>
                    <td>{{ val | format_currency }}</td>
                    {% elif key == 'calc_variable' %}
                    {# ×©×¢×•×ª ×‘×ª×¢×¨×™×£ ××©×ª× ×” - ×ª×¢×¨×™×£ ×©×•× ×” ××©×›×¨ ××™× ×™××•× #}
                    <td>{{ (val | float / 60) | round(2) }}</td>
                    <td>{{ "%.2f"|format(monthly_totals.variable_rate_value or 0) }} â‚ª</td>
                    <td>{{ (monthly_totals.payment_calc_variable or 0) | format_currency }}</td>
                    {% else %}
                    <td>{{ (val | float / 60) | round(2) }}</td>

                    {% set multiplier = 1.0 %}
                    {% if key == 'calc150_shabbat_100' %}{% set multiplier = 1.0 %}
                    {% elif key == 'calc150_shabbat_50' %}{% set multiplier = 0.5 %}
                    {% elif '125' in key %}{% set multiplier = 1.25 %}
                    {% elif '150' in key %}{% set multiplier = 1.5 %}
                    {% elif '175' in key %}{% set multiplier = 1.75 %}
                    {% elif '200' in key %}{% set multiplier = 2.0 %}
                    {% endif %}

                    {# For regular hours, always use minimum wage #}
                    <td>{{ "%.2f"|format(hourly_rate * multiplier) }} â‚ª</td>
                    {% set payment_key = 'payment_' ~ key %}

                    {# Special handling for split shabbat payments if not directly in monthly_totals #}
                    {% if key == 'calc150_shabbat_100' %}
                    <td>{{ ((val | float / 60) * hourly_rate * 1.0) | format_currency }}</td>
                    {% elif key == 'calc150_shabbat_50' %}
                    <td>{{ ((val | float / 60) * hourly_rate * 0.5) | format_currency }}</td>
                    {% elif monthly_totals[payment_key] is defined and monthly_totals[payment_key] > 0 %}
                    <td>{{ monthly_totals[payment_key] | format_currency }}</td>
                    {% else %}
                    <td>{{ ((val | float / 60) * hourly_rate * multiplier) | format_currency }}</td>
                    {% endif %}
                    {% endif %}
                  </tr>
                  {% endif %}
                  {% endfor %}
                  {% endif %}
                  {% if not payment_codes %}
                  <!-- 100% -->
                  <tr>
                    <td>×©×¢×•×ª ×¨×’×™×œ×•×ª (100%)</td>
                    <td>{{ codes_map.get('calc100', '') }}</td>
                    <td>{{ (monthly_totals.calc100 | float / 60) | round(2) }}</td>
                    <td>34.40 â‚ª</td>
                    <td>{{ ((monthly_totals.calc100 | float / 60) * hourly_rate * 1.0) | format_currency }}</td>
                  </tr>
                  <!-- 125% -->
                  <tr>
                    <td>×©×¢×•×ª × ×•×¡×¤×•×ª (125%)</td>
                    <td>{{ codes_map.get('calc125', '') }}</td>
                    <td>{{ (monthly_totals.calc125 | float / 60) | round(2) }}</td>
                    <td>43.00 â‚ª</td>
                    <td>{{ ((monthly_totals.calc125 | float / 60) * hourly_rate * 1.25) | format_currency }}</td>
                  </tr>
                  <!-- 150% overtime (not Shabbat) -->
                  <tr>
                    <td>×©×¢×•×ª × ×•×¡×¤×•×ª (150%)</td>
                    <td>{{ codes_map.get('calc150_overtime', '') }}</td>
                    <td>{{ (monthly_totals.calc150_overtime | float / 60) | round(2) }}</td>
                    <td>{{ "%.2f"|format(hourly_rate * 1.5) }} â‚ª</td>
                    <td>
                      {% if monthly_totals.get('payment_calc150_overtime') %}
                      {{ monthly_totals.payment_calc150_overtime | format_currency }}
                      {% else %}
                      {{ ((monthly_totals.calc150_overtime | float / 60) * hourly_rate * 1.5) | format_currency }}
                      {% endif %}
                    </td>
                  </tr>
                  <!-- 150% Shabbat -->
                  {% set calc150_shabbat_minutes = monthly_totals.get('calc150_shabbat', 0) or 0 %}
                  {% set calc150_shabbat_hours_val = (calc150_shabbat_minutes | float) / 60 %}
                  {% if calc150_shabbat_hours_val > 0.01 %}
                  <tr>
                    <td>×©×¢×•×ª ×©×‘×ª (150%)</td>
                    <td>{{ codes_map.get('calc150_shabbat', '') }}</td>
                    <td>{{ calc150_shabbat_hours_val | round(2) }}</td>
                    <td>{{ "%.2f"|format(hourly_rate * 1.5) }} â‚ª</td>
                    <td>
                      {% if monthly_totals.get('payment_calc150_shabbat') and monthly_totals.payment_calc150_shabbat > 0
                      %}
                      {{ monthly_totals.payment_calc150_shabbat | format_currency }}
                      {% else %}
                      {{ (calc150_shabbat_hours_val * hourly_rate * 1.5) | format_currency }}
                      {% endif %}
                    </td>
                  </tr>
                  {% endif %}
                  <!-- 175% -->
                  <tr>
                    <td>×©×¢×•×ª ×©×‘×ª (175%)</td>
                    <td>{{ codes_map.get('calc175', '') }}</td>
                    <td>{{ (monthly_totals.calc175 | float / 60) | round(2) }}</td>
                    <td>60.20 â‚ª</td>
                    <td>{{ ((monthly_totals.calc175 | float / 60) * hourly_rate * 1.75) | format_currency }}</td>
                  </tr>
                  <!-- 200% -->
                  <tr>
                    <td>×©×¢×•×ª ×©×‘×ª (200%)</td>
                    <td>{{ codes_map.get('calc200', '') }}</td>
                    <td>{{ (monthly_totals.calc200 | float / 60) | round(2) }}</td>
                    <td>68.80 â‚ª</td>
                    <td>{{ ((monthly_totals.calc200 | float / 60) * hourly_rate * 2.0) | format_currency }}</td>
                  </tr>

                  <!-- ×›×•× × ×•×™×•×ª -->
                  {% if total_standby_count > 0 %}
                  <tr style="background-color: #f8f9fa;">
                    <td>×›×•× × ×•×™×•×ª</td>
                    <td>{{ codes_map.get('standby', '') }}</td>
                    <td>{{ total_standby_count }}</td>
                    <td>
                      {% if total_standby_count > 0 %}
                      {{ "%.2f"|format((monthly_totals.standby_payment or 0) / total_standby_count) }} â‚ª
                      {% else %}
                      0.00 â‚ª
                      {% endif %}
                    </td>
                    <td>{{ (monthly_totals.standby_payment or 0) | format_currency }}</td>
                  </tr>
                  {% endif %}

                  <!-- ×—×•×¤×©×” -->
                  {% if monthly_totals.vacation_minutes and monthly_totals.vacation_minutes > 0 %}
                  <tr style="background-color: #e6fffa;">
                    <td>×—×•×¤×©×”</td>
                    <td>{{ codes_map.get('vacation', '') }}</td>
                    <td>{{ (monthly_totals.vacation_minutes | float / 60) | round(2) }}</td>
                    <td>{{ hourly_rate }} â‚ª</td>
                    <td>{{ monthly_totals.vacation_payment | format_currency }}</td>
                  </tr>
                  {% endif %}

                  <!-- × ×¡×™×¢×•×ª -->
                  {% if monthly_totals.travel and monthly_totals.travel > 0 %}
                  <tr style="background-color: #fef3c7;">
                    <td>ğŸš— × ×¡×™×¢×•×ª</td>
                    <td>{{ codes_map.get('travel', '') }}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>{{ monthly_totals.travel | format_currency }}</td>
                  </tr>
                  {% endif %}

                  <!-- ×ª×•×¡×¤×•×ª/×”×—×–×¨×™× -->
                  {% if monthly_totals.extras and monthly_totals.extras > 0 %}
                  <tr style="background-color: #fce7f3;">
                    <td>ğŸ’° ×ª×•×¡×¤×•×ª/×”×—×–×¨×™×</td>
                    <td>{{ codes_map.get('extras', '') }}</td>
                    <td>-</td>
                    <td>
                      {% if monthly_totals.extras_details %}
                      <span style="font-size: 11px; color: #666;">
                        {% for ed in monthly_totals.extras_details %}
                        {{ ed.type }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                      </span>
                      {% endif %}
                    </td>
                    <td>{{ monthly_totals.extras | format_currency }}</td>
                  </tr>
                  {% endif %}
                  {% endif %}

                  <tr style="font-weight: bold; border-top: 2px solid #333; background-color: #e7f5ff;">
                    <td>×¡×”"×› ×œ×ª×©×œ×•×</td>
                    <td></td>
                    <td>-</td>
                    <td>-</td>
                    <td>{{ ((monthly_totals.payment or 0) + (monthly_totals.travel or 0) + (monthly_totals.extras or 0))
                      | format_currency }}</td>
                  </tr>
              </tbody>
            </table>
          </div>
        </div><!-- ×¡×•×£ ×”×’×¨×™×“ -->

        <div class="muted" style="margin-top: 8px; font-size: 11px;">
          * ×”×—×™×©×•×‘ ××‘×•×¡×¡ ×¢×œ ×©×›×¨ ×©×¢×” ×©×œ {{ hourly_rate }} â‚ª. ×¡×”"×› ×œ×ª×©×œ×•× ×›×•×œ×œ ×›×•× × ×•×™×•×ª, × ×¡×™×¢×•×ª ×•×ª×•×¡×¤×•×ª.
        </div>
        {% else %}
        <div class="muted">××™×Ÿ × ×ª×•× ×™× ×œ×—×•×“×© ×”× ×‘×—×¨.</div>
        {% endif %}
      </section>
    </div>
  </div>
</div>
<script>
  function toggleStandby() {
    const btn = document.getElementById('toggleStandbyBtn');
    const rows = document.querySelectorAll('.row-standby');

    // Check current state based on button text
    const isHiding = btn.innerText.includes('×”×¡×ª×¨');

    rows.forEach(row => {
      row.style.display = isHiding ? 'none' : 'table-row';
    });

    btn.innerText = isHiding ? '×”×¦×’ ×›×•× × ×•×™×•×ª' : '×”×¡×ª×¨ ×›×•× × ×•×™×•×ª';
    btn.style.opacity = isHiding ? '0.8' : '1';
  }

  function printReport() {
    const url = new URL(window.location.href);
    url.searchParams.set('print', '1');
    // ×¤×ª×™×—×” ×‘×—×œ×•×Ÿ ×—×“×© (×œ× ×˜××‘) ×× ×•×ª×§ ×œ×—×œ×•×˜×™×Ÿ
    const width = 1000;
    const height = 800;
    const left = (window.screen.width / 2) - (width / 2);
    const top = (window.screen.height / 2) - (height / 2);

    // ×©×™××•×© ×‘-windowFeatures ×›×“×™ ×œ×›×¤×•×ª ×—×œ×•×Ÿ × ×¤×¨×“ ×•×œ× ×ª×§ ××ª ×”×§×©×¨
    const newWin = window.open(url.toString(), '_blank', `width=${width},height=${height},top=${top},left=${left},noopener,noreferrer,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`);

    // × ×™×ª×•×§ × ×•×¡×£ ×œ×™×ª×¨ ×‘×™×˜×—×•×Ÿ
    if (newWin) {
      try {
        newWin.opener = null;
      } catch (e) { }
    }
  }

  async function sendEmail() {
    const btn = document.getElementById('sendEmailBtn');
    const originalText = btn.innerText;
    const defaultEmail = '{{ person.email or "" }}';

    // Prompt for email with default value
    const targetEmail = prompt('×œ××™×–×” ××™×™×œ ×œ×©×œ×•×— ××ª ×”×“×•×—?', defaultEmail);

    // User cancelled or empty input
    if (targetEmail === null) {
      return;
    }

    if (!targetEmail.trim()) {
      alert('×™×© ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ××™×™×œ');
      return;
    }

    btn.disabled = true;
    btn.innerText = '×©×•×œ×—...';

    try {
      const personId = {{ person.id }};
      const year = {{ selected_year }};
      const month = {{ selected_month }};

      const response = await fetch(`/api/send-guide-email/${personId}?year=${year}&month=${month}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email: targetEmail.trim() })
      });

      const result = await response.json();

      if (result.success) {
        alert(result.message || '×”××™×™×œ × ×©×œ×— ×‘×”×¦×œ×—×”!');
      } else {
        alert('×©×’×™××”: ' + (result.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
      }
    } catch (error) {
    alert('×©×’×™××ª ×¨×©×ª: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerText = originalText;
  }
  }

  // Auto-print if 'print=1' is in URL
  window.onload = function () {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('print') === '1') {
      // Small delay to ensure styles and tables are fully rendered
      setTimeout(() => {
        window.print();
        // Optional: close the window after print dialog is closed
        // window.onafterprint = () => window.close();
      }, 500);
    }
  }
</script>
{% endblock %}