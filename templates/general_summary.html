{% extends "base.html" %}

{% block content %}
<style>
    main { max-width: 95% !important; }
    tbody a { transition: all 0.2s ease; font-weight: bold; }
    tbody a:hover { color: #0860ca !important; text-decoration: underline !important; }
    tbody tr:hover { background-color: #f6f8fa; }
    .compact-cell { font-size: 12px; white-space: nowrap; }
    .combined-header { font-size: 12px; }
    .combined-header div { font-size: 11px; }
</style>
<div class="card" style="max-width: none; width: 100%;">
    <div class="header-line" style="flex-wrap: wrap; gap: 10px;">
        <h2 class="section-title" style="font-size: 18px; margin: 0;">
            ×¡×™×›×•× ×©×›×¨ ×›×œ×œ×™ - ×›×œ ×”××“×¨×™×›×™×
            <span style="font-size: 0.7em; color: #666; font-weight: normal;">({{ summary_data|length }} ××“×¨×™×›×™×)</span>
        </h2>
        <div class="controls" style="flex-wrap: wrap; gap: 6px;">
            <div style="display: flex; gap: 6px; align-items: center;">
                <input type="text" id="filterInput" value="{{ search_query }}" placeholder="×¡× ×Ÿ ×œ×¤×™ ×©×..." 
                       style="padding: 4px 8px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; min-width: 150px;">
                <button onclick="clearFilter()" style="padding: 4px 10px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">× ×§×”</button>
            </div>
            <form method="get" style="display: flex; gap: 6px; align-items: center;">
                {% if search_query %}<input type="hidden" name="q" value="{{ search_query }}">{% endif %}
                <select name="month" onchange="this.form.submit()" style="padding: 4px 6px; font-size: 13px;">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ "%02d"|format(m) }}</option>
                    {% endfor %}
                </select>
                <select name="year" onchange="this.form.submit()" style="padding: 4px 6px; font-size: 13px;">
                    {% for y in years %}
                    <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </form>
            <button onclick="window.print()" style="padding: 4px 10px; font-size: 12px;">×”×“×¤×¡ ×“×•×—</button>
            <a href="/export/excel?year={{ selected_year }}&month={{ selected_month }}" style="text-decoration: none; padding: 4px 10px; font-size: 12px; background: #28a745; color: white; border-radius: 4px;">×™×™×¦×•× ××§×¡×œ</a>
            <a href="/export/gesher/preview?year={{ selected_year }}&month={{ selected_month }}" style="text-decoration: none; padding: 4px 10px; font-size: 12px; background: #007bff; color: white; border-radius: 4px;">×™×™×¦×•× ×’×©×¨</a>
            <a href="/" style="text-decoration: none; padding: 4px 10px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; color: #333;">×—×–×¨×”</a>
        </div>
    </div>

    <!-- ×—×™×¤×•×© ×§×•×“×™ ××™×¨×‘ ×œ×¢××•×“×•×ª ×”××—×¨×•× ×•×ª - ×©×™××•×© ×‘-namespace ×›×™ Jinja2 ×œ× ×©×•××¨ ××©×ª× ×™× ××œ×•×œ××•×ª -->
    {% set ns = namespace(
        standby='',
        travel='',
        extras=''
    ) %}
    {% for code in payment_codes %}
        {% if code.internal_key == 'standby' %}
            {% set ns.standby = code.merav_code %}
        {% elif code.internal_key == 'travel' %}
            {% set ns.travel = code.merav_code %}
        {% elif code.internal_key == 'extras' %}
            {% set ns.extras = code.merav_code %}
        {% endif %}
    {% endfor %}
    
    <div style="overflow-x: auto; overflow-y: auto; max-height: 75vh; margin-top: 12px; width: 100%;">
        <table id="summaryTable" style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 12px;">
            <thead style="position: sticky; top: 0; z-index: 10;">
                <tr style="background: #f2f4f7; font-size: 11px;">
                    <th onclick="sortTable(0)" style="cursor: pointer; position: sticky; right: 0; top: 0; background: #f2f4f7; z-index: 12; border-left: 2px solid #ddd; padding: 4px 6px; white-space: nowrap; width: 160px;">×©× â‡…</th>
                    <th onclick="sortTable(1)" style="cursor: pointer; padding: 2px 4px; width: 45px; text-align: right;" title="×©×¢×•×ª ×¨×’×™×œ×•×ª 100%">100%<div style="font-size: 9px; color: #888;">360</div></th>
                    <th onclick="sortTable(2)" style="cursor: pointer; padding: 2px 4px; width: 45px; text-align: right;" title="×©×¢×•×ª × ×•×¡×¤×•×ª 125%">125%<div style="font-size: 9px; color: #888;">366</div></th>
                    <th onclick="sortTable(3)" style="cursor: pointer; padding: 2px 4px; width: 45px; text-align: right;" title="×©×¢×•×ª × ×•×¡×¤×•×ª 150%">150%<div style="font-size: 9px; color: #888;">368</div></th>
                    <th onclick="sortTable(4)" style="cursor: pointer; padding: 2px 4px; background: #e8f5e9; width: 50px; text-align: right;" title="×©×‘×ª 150%">ğŸ•¯ï¸150<div style="font-size: 9px; color: #888;">130</div></th>
                    <th onclick="sortTable(5)" style="cursor: pointer; padding: 2px 4px; background: #e8f5e9; width: 45px; text-align: right;" title="×©×‘×ª 175%">175<div style="font-size: 9px; color: #888;">382</div></th>
                    <th onclick="sortTable(6)" style="cursor: pointer; padding: 2px 4px; background: #e8f5e9; width: 45px; text-align: right;" title="×©×‘×ª 200%">200<div style="font-size: 9px; color: #888;">434</div></th>
                    <th onclick="sortTable(7)" style="cursor: pointer; padding: 2px 4px; width: 55px; text-align: right;" title="×©×¢×•×ª ×‘×ª×¢×¨×™×£ ××©×ª× ×”">××©×ª× ×”<div style="font-size: 9px; color: #888;">363</div></th>
                    <th onclick="sortTable(8)" style="cursor: pointer; padding: 2px 4px; width: 40px; text-align: right;" title="×™××™ ×¢×‘×•×“×”">×™××™×<div style="font-size: 9px; color: #888;">767</div></th>
                    <th onclick="sortTable(9)" style="cursor: pointer; padding: 2px 4px; width: 45px; text-align: right;" title="×¡×”×´×› ×©×¢×•×ª">×¡×”×›<div style="font-size: 9px; color: #888;">199</div></th>
                    <th onclick="sortTable(10)" style="cursor: pointer; padding: 2px 4px; width: 50px; text-align: right;" title="×—×•×¤×©×”">×—×•×¤×©×”<div style="font-size: 9px; color: #888;">376</div></th>
                    <th onclick="sortTable(11)" style="cursor: pointer; padding: 2px 4px; background: #dbeafe; width: 55px; text-align: right;" title="×›×•× × ×•×™×•×ª">×›×•× × ×•×™×•×ª<div style="font-size: 9px; color: #888;">{{ ns.standby }}</div></th>
                    <th onclick="sortTable(12)" style="cursor: pointer; padding: 2px 4px; background: #fef3c7; width: 55px; text-align: right;" title="× ×¡×™×¢×•×ª">× ×¡×™×¢×•×ª<div style="font-size: 9px; color: #888;">{{ ns.travel }}</div></th>
                    <th onclick="sortTable(13)" style="cursor: pointer; padding: 2px 4px; background: #f3e8ff; width: 55px; text-align: right;" title="×ª×•×¡×¤×•×ª">×ª×•×¡×¤×•×ª<div style="font-size: 9px; color: #888;">{{ ns.extras }}</div></th>
                    <th onclick="sortTable(14)" style="cursor: pointer; padding: 2px 4px; background: #e7f5ff; font-weight: bold; width: 70px; text-align: right;">×¡×”"×›</th>
                </tr>
            </thead>
            <tbody>
                {% for row in summary_data %}
                <tr class="data-row" data-name="{{ row.name|lower }}">
                    <td style="position: sticky; right: 0; background: #fff; z-index: 1; border-left: 2px solid #eee; font-weight: bold; padding: 2px 6px;">
                        <a href="/guide/{{ row.person_id }}?year={{ selected_year }}&month={{ selected_month }}" style="text-decoration: none; color: #0969da; font-size: 12px;" title="×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×“×•×— ××¤×•×¨×˜">{{ row.name }}</a>
                    </td>
                    <td style="text-align: right; padding: 2px;">{% set v = row.totals.calc100 or 0 %}{% if v > 0 %}{{ (v|float/60)|round(1) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = row.totals.calc125 or 0 %}{% if v > 0 %}{{ (v|float/60)|round(1) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = row.totals.calc150_overtime or 0 %}{% if v > 0 %}{{ (v|float/60)|round(1) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #f0fdf4;">{% set v = row.totals.calc150_shabbat or 0 %}{% if v > 0 %}{{ (v|float/60)|round(1) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #f0fdf4;">{% set v = row.totals.calc175 or 0 %}{% if v > 0 %}{{ (v|float/60)|round(1) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #f0fdf4;">{% set v = row.totals.calc200 or 0 %}{% if v > 0 %}{{ (v|float/60)|round(1) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = row.totals.calc_variable or 0 %}{% if v > 0 %}{{ (v|float/60)|round(1) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = row.totals.actual_work_days or 0 %}{% if v > 0 %}{{ v }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = row.totals.total_hours or 0 %}{% if v > 0 %}{{ (v|float/60)|round(1) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = row.totals.vacation_minutes or 0 %}{% if v > 0 %}{{ (v|float/60)|round(1) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #eff6ff;">{% if row.totals.standby_payment and row.totals.standby_payment > 0 %}{{ "%.0f"|format(row.totals.standby_payment) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #fef3c7;">{% if row.totals.travel and row.totals.travel > 0 %}{{ "%.0f"|format(row.totals.travel) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #f3e8ff;">{% if row.totals.extras and row.totals.extras > 0 %}{{ "%.0f"|format(row.totals.extras) }}{% else %}<span style="color:#ddd;">-</span>{% endif %}</td>
                    <td style="background: #e7f5ff; font-weight: bold; padding: 2px; text-align: right;">{{ "{:,.0f}".format((row.totals.total_payment or row.totals.payment or 0)) }}</td>
                </tr>
                {% endfor %}
                
                <!-- Grand Totals Row -->
                <tr style="background: #333; color: #fff; font-weight: bold; font-size: 11px;">
                    <td style="position: sticky; right: 0; background: #333; z-index: 1; border-left: 2px solid #555; padding: 4px 6px;">×¡×”"×›</td>
                    <td style="text-align: right; padding: 2px;">{% set v = grand_totals.calc100 or 0 %}{% if v > 0 %}{{ (v|float/60)|round(0) }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = grand_totals.calc125 or 0 %}{% if v > 0 %}{{ (v|float/60)|round(0) }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = grand_totals.calc150_overtime or 0 %}{% if v > 0 %}{{ (v|float/60)|round(0) }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #2d4a2d;">{% set v = grand_totals.calc150_shabbat or 0 %}{% if v > 0 %}{{ (v|float/60)|round(0) }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #2d4a2d;">{% set v = grand_totals.calc175 or 0 %}{% if v > 0 %}{{ (v|float/60)|round(0) }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #2d4a2d;">{% set v = grand_totals.calc200 or 0 %}{% if v > 0 %}{{ (v|float/60)|round(0) }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = grand_totals.calc_variable or 0 %}{% if v > 0 %}{{ (v|float/60)|round(0) }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = grand_totals.actual_work_days or 0 %}{% if v > 0 %}{{ v }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = grand_totals.total_hours or 0 %}{% if v > 0 %}{{ (v|float/60)|round(0) }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px;">{% set v = grand_totals.vacation_minutes or 0 %}{% if v > 0 %}{{ (v|float/60)|round(0) }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #1e40af;">{% if grand_totals.standby_payment and grand_totals.standby_payment > 0 %}{{ "%.0f"|format(grand_totals.standby_payment) }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #92400e;">{% if grand_totals.travel and grand_totals.travel > 0 %}{{ "%.0f"|format(grand_totals.travel) }}{% endif %}</td>
                    <td style="text-align: right; padding: 2px; background: #6b21a8;">{% if grand_totals.extras and grand_totals.extras > 0 %}{{ "%.0f"|format(grand_totals.extras) }}{% endif %}</td>
                    <td style="background: #444; padding: 2px; text-align: right;">{{ "{:,.0f}".format(grand_totals.payment or 0) }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
// ×¡×™× ×•×Ÿ ×‘×–××Ÿ ×××ª
document.addEventListener('DOMContentLoaded', function() {
    const filterInput = document.getElementById('filterInput');
    if (filterInput) {
        filterInput.addEventListener('input', function() {
            filterTable(this.value);
        });
        // ×× ×™×© ×¢×¨×š ×”×ª×—×œ×ª×™, ×¡× ×Ÿ ××™×“
        if (filterInput.value) {
            filterTable(filterInput.value);
        }
    }
});

function filterTable(query) {
    const filterValue = query.toLowerCase().trim();
    const rows = document.querySelectorAll('#summaryTable tbody tr.data-row');
    let visibleCount = 0;
    
    rows.forEach(function(row) {
        const name = row.getAttribute('data-name') || '';
        if (filterValue === '' || name.includes(filterValue)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // ×¢×“×›×•×Ÿ ××¡×¤×¨ ×”××“×¨×™×›×™× ×‘×ª×¦×•×’×”
    const titleSpan = document.querySelector('.section-title span');
    if (titleSpan && filterValue) {
        titleSpan.textContent = `(${visibleCount} ××“×¨×™×›×™×${filterValue ? ' ××¡×•× × ×™×' : ''})`;
    } else if (titleSpan) {
        titleSpan.textContent = `({{ summary_data|length }} ××“×¨×™×›×™×)`;
    }
}

function clearFilter() {
    const filterInput = document.getElementById('filterInput');
    if (filterInput) {
        filterInput.value = '';
        filterTable('');
    }
}

function sortTable(n) {
  var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  table = document.getElementById("summaryTable");
  switching = true;
  // Set the sorting direction to ascending:
  dir = "asc";
  
  while (switching) {
    switching = false;
    // Get rows from the first tbody (ignoring the header row which is in thead)
    var body = table.tBodies[0];
    rows = body.rows;
    // Loop through all table rows except the last one (Grand Totals):
    for (i = 0; i < rows.length - 2; i++) {
      shouldSwitch = false;
      
      x = rows[i].getElementsByTagName("TD")[n];
      y = rows[i + 1].getElementsByTagName("TD")[n];
      
      var xVal = parseCellValue(x);
      var yVal = parseCellValue(y);
      
      if (dir == "asc") {
        if (xVal > yVal) {
          shouldSwitch = true;
          break;
        }
      } else if (dir == "desc") {
        if (xVal < yVal) {
          shouldSwitch = true;
          break;
        }
      }
    }
    if (shouldSwitch) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      switchcount ++;
    } else {
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
}

function parseCellValue(td) {
    var val = td.textContent || td.innerText;
    val = val.trim().replace(/[â‚ª,]/g, ""); // Remove currency and commas
    if (val === "" || val === "-") return -Infinity; // Treat empty as minimal
    
    var num = parseFloat(val);
    // If it's a valid number, return it. Otherwise return string for text sorting
    return isNaN(num) ? val.toLowerCase() : num;
}
</script>
{% endblock %}
