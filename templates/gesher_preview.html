{% extends "base.html" %}

{% block content %}
<style>
    main { max-width: 95% !important; }
    .export-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
    .export-table th, .export-table td {
        border: 1px solid #ddd;
        padding: 4px 6px;
        text-align: center;
    }
    .export-table th { background: #f2f4f7; font-size: 11px; }
    .export-table th div { font-size: 9px; color: #666; }
    .export-table tbody tr:hover { background: #f5f5f5; }
    .export-table tbody tr.hidden { display: none; }
    .qty-row { background: #fff; }
    .rate-row { background: #fafafa; font-size: 11px; color: #666; }
    .name-cell {
        position: sticky;
        right: 0;
        background: #fff;
        z-index: 1;
        border-left: 2px solid #ddd;
        font-weight: bold;
        text-align: right !important;
    }
    .rate-row .name-cell { background: #fafafa; font-weight: normal; font-size: 11px; }
    .checkbox-cell { width: 30px; }
    .download-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        text-decoration: none;
        display: inline-block;
    }
    .download-btn:hover { background: #218838; }
    .code-badge {
        display: inline-block;
        padding: 1px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: bold;
        background: #e8f5e9;
        color: #2e7d32;
    }
    .totals-row { background: #333 !important; color: #fff; font-weight: bold; }
    .totals-row td { border-color: #555; }
    .search-box {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        width: 180px;
    }
    .search-box:focus { border-color: #1f6feb; outline: none; }
    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 100;
        justify-content: center;
        align-items: center;
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
        background: white;
        border-radius: 10px;
        padding: 20px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .legend-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .legend-table th, .legend-table td { padding: 6px 10px; border-bottom: 1px solid #eee; text-align: right; }
    .legend-table th { background: #f8f9fa; }
</style>

<div class="card" style="max-width: none; width: 100%;">
    <div class="header-line" style="flex-wrap: wrap; gap: 10px;">
        <h2 class="section-title" style="font-size: 18px; margin: 0;">
            爪 砖专
            <span style="font-size: 0.7em; color: #666; font-weight: normal;">({{ preview|length }} 注)</span>
        </h2>
        <div class="controls" style="flex-wrap: wrap; gap: 6px;">
            <form method="get" style="display: flex; gap: 6px; align-items: center;">
                <select name="month" onchange="this.form.submit()" style="padding: 4px 6px; font-size: 13px;">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ "%02d"|format(m) }}</option>
                    {% endfor %}
                </select>
                <select name="year" onchange="this.form.submit()" style="padding: 4px 6px; font-size: 13px;">
                    {% for y in years %}
                    <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" name="show_zero" value="1" {% if show_zero %}checked{% endif %} onchange="this.form.submit()">
                    爪 0
                </label>
            </form>
            <button onclick="showLegend()" style="padding: 4px 10px; font-size: 12px; background: #6c757d;">拽专 住</button>
            <a href="/summary?year={{ selected_year }}&month={{ selected_month }}" style="text-decoration: none; padding: 4px 10px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; color: #333;">专 住</a>
        </div>
    </div>

    <!-- 爪 驻 驻注 -->
    <div style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px;">
        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <span style="color: white; font-weight: bold;">爪  驻注:</span>
            {% for emp in employers %}
            <a href="/export/gesher?year={{ selected_year }}&month={{ selected_month }}&company={{ emp.code }}"
               style="background: white; color: #667eea; text-decoration: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; font-size: 13px;">
                {{ emp.name }} ({{ emp.code }})
            </a>
            {% endfor %}
        </div>
    </div>

    {% if missing_merav_count and missing_merav_count > 0 %}
    <!-- 注 注 注  拽 专 -->
    <div style="margin-bottom: 10px; padding: 10px 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 18px;">锔</span>
        <span style="font-size: 13px; color: #856404;">
            砖 {{ missing_merav_count }} 注{% if missing_merav_count > 1 %}{% endif %}  拽 专 -  爪 砖专.
        </span>
        <button onclick="showMissingModal()" style="padding: 4px 10px; font-size: 12px; background: #ffc107; border: none; border-radius: 4px; cursor: pointer;">爪</button>
    </div>
    {% endif %}

    {% if preview %}
    <!-- 驻砖 专 -->
    <div style="margin-bottom: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <input type="text" id="searchBox" class="search-box" placeholder="驻砖 砖  拽..." oninput="filterTable()">
        <span id="filterCount" style="font-size: 12px; color: #666;"></span>
        <div style="margin-right: auto;"></div>
        <button onclick="selectAll(true)" style="padding: 4px 10px; font-size: 12px;">专 </button>
        <button onclick="selectAll(false)" style="padding: 4px 10px; font-size: 12px; background: #6c757d;"> 专</button>
        <button onclick="exportSelected()" class="download-btn" style="padding: 6px 12px;">爪 专</button>
    </div>

    <!--  拽驻拽转 -->
    <div style="overflow-x: auto; overflow-y: auto; max-height: 70vh;">
        <table class="export-table" id="exportTable">
            <thead style="position: sticky; top: 0; z-index: 10;">
                <tr>
                    <th class="checkbox-cell"><input type="checkbox" id="selectAllCheckbox" onchange="selectAll(this.checked)"></th>
                    <th style="position: sticky; right: 0; top: 0; background: #f2f4f7; z-index: 12; border-left: 2px solid #ddd; min-width: 120px;">注</th>
                    <th style="min-width: 60px;">拽</th>
                    <th></th>
                    {% for symbol, (key, vtype, display_name) in export_codes.items() %}
                    <th style="min-width: 50px;">{{ symbol }}<div>{{ display_name[:8] }}</div></th>
                    {% endfor %}
                    <th style="min-width: 60px;">专</th>
                </tr>
            </thead>
            <tbody>
                {% for person in preview %}
                <!-- 砖专转 转 -->
                <tr class="qty-row" data-person-id="{{ person.person_id }}">
                    <td class="checkbox-cell" rowspan="2">
                        <input type="checkbox" class="person-checkbox" value="{{ person.person_id }}" data-name="{{ person.name }}">
                    </td>
                    <td class="name-cell" rowspan="2">
                        <a href="/guide/{{ person.person_id }}?year={{ selected_year }}&month={{ selected_month }}"
                           style="text-decoration: none; color: #0969da;">{{ person.name }}</a>
                    </td>
                    <td rowspan="2" style="font-family: monospace;">{{ person.meirav_code }}</td>
                    <td style="font-size: 10px; color: #888;">转</td>
                    {% for symbol, (key, vtype, display_name) in export_codes.items() %}
                    <td>
                        {% set found = namespace(qty=0) %}
                        {% for line in person.lines %}
                            {% if line.symbol == symbol %}
                                {% set found.qty = line.quantity %}
                            {% endif %}
                        {% endfor %}
                        {% if found.qty > 0 %}
                            {{ "%.1f"|format(found.qty) }}
                        {% else %}
                            <span style="color: #ddd;">-</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td rowspan="2">
                        <a href="/export/gesher/person/{{ person.person_id }}?year={{ selected_year }}&month={{ selected_month }}"
                           class="download-btn" title="专 拽抓 砖专"></a>
                    </td>
                </tr>
                <!-- 砖专转 转注专祝 -->
                <tr class="rate-row">
                    <td style="font-size: 10px; color: #888;">转注专祝</td>
                    {% for symbol, (key, vtype, display_name) in export_codes.items() %}
                    <td>
                        {% set found = namespace(rate=0) %}
                        {% for line in person.lines %}
                            {% if line.symbol == symbol %}
                                {% set found.rate = line.payment %}
                            {% endif %}
                        {% endfor %}
                        {% if found.rate > 0 %}
                            {{ "%.1f"|format(found.rate) }}
                        {% else %}
                            <span style="color: #ddd;">-</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #666;">
        <h3> 转 爪</h3>
        <p> 爪 注 注 拽 专 转 砖专 砖 .</p>
    </div>
    {% endif %}
</div>

<!-- Modal 注  拽 专 -->
<div id="missingModal" class="modal-overlay" onclick="if(event.target===this)hideMissingModal()">
    <div class="modal-content" style="max-width: 400px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #856404;">注  拽 专</h3>
            <button onclick="hideMissingModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">注   爪 拽抓 砖专. 砖 住祝  拽 专 专住 注.</p>
        <table class="legend-table">
            <tbody>
                {% for emp in missing_merav_list %}
                <tr>
                    <td>
                        <a href="/guide/{{ emp.id }}?year={{ selected_year }}&month={{ selected_month }}"
                           style="text-decoration: none; color: #0969da; font-weight: bold;">{{ emp.name }}</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal 拽专 住 -->
<div id="legendModal" class="modal-overlay" onclick="if(event.target===this)hideLegend()">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">拽专 住</h3>
            <button onclick="hideLegend()" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
        </div>
        <table class="legend-table">
            <thead>
                <tr>
                    <th>拽</th>
                    <th>转专</th>
                    <th>砖砖</th>
                </tr>
            </thead>
            <tbody>
                {% for symbol, (key, vtype, display_name) in export_codes.items() %}
                {% set usage_count = namespace(count=0) %}
                {% for person in preview %}
                    {% for line in person.lines %}
                        {% if line.symbol == symbol and ((line.type == 'money' and line.payment > 0) or (line.type != 'money' and line.quantity > 0)) %}
                            {% set usage_count.count = usage_count.count + 1 %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                <tr>
                    <td><span class="code-badge">{{ symbol }}</span></td>
                    <td>{{ display_name }}</td>
                    <td style="text-align: center;">{{ usage_count.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function selectAll(checked) {
    // Only select visible (not filtered) checkboxes
    document.querySelectorAll('.qty-row:not(.hidden) .person-checkbox').forEach(cb => cb.checked = checked);
    document.getElementById('selectAllCheckbox').checked = checked;
}

function exportSelected() {
    const selected = [];
    // 专拽 checkboxes 砖 砖专转 转 ( 住转专转)
    document.querySelectorAll('.qty-row:not(.hidden) .person-checkbox:checked').forEach(cb => {
        selected.push(cb.value);
    });

    if (selected.length === 0) {
        alert('砖 专 驻转 注 ');
        return;
    }

    // 爪  注 砖专 拽抓 ZIP 
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/export/gesher/multiple?year={{ selected_year }}&month={{ selected_month }}&person_ids=' + selected.join(',');
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

function filterTable() {
    const searchText = document.getElementById('searchBox').value.toLowerCase().trim();
    const rows = document.querySelectorAll('.qty-row');
    let visibleCount = 0;

    rows.forEach(row => {
        const name = row.querySelector('.name-cell a')?.textContent.toLowerCase() || '';
        const code = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
        const rateRow = row.nextElementSibling;

        if (searchText === '' || name.includes(searchText) || code.includes(searchText)) {
            row.classList.remove('hidden');
            if (rateRow) rateRow.classList.remove('hidden');
            visibleCount++;
        } else {
            row.classList.add('hidden');
            if (rateRow) rateRow.classList.add('hidden');
        }
    });

    const countEl = document.getElementById('filterCount');
    if (searchText) {
        countEl.textContent = `爪 ${visibleCount} 转 {{ preview|length }}`;
    } else {
        countEl.textContent = '';
    }
}

function showLegend() {
    document.getElementById('legendModal').classList.add('show');
}

function hideLegend() {
    document.getElementById('legendModal').classList.remove('show');
}

function showMissingModal() {
    document.getElementById('missingModal').classList.add('show');
}

function hideMissingModal() {
    document.getElementById('missingModal').classList.remove('show');
}

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideLegend();
        hideMissingModal();
    }
});
</script>
{% endblock %}
