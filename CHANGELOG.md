# Changelog - יומן שינויים

כל השינויים בפרויקט DiyurCalc מתועדים כאן.

פורמט: [SemVer](https://semver.org/)

---

## [2.2.7] - 2026-02-04

### שינויים
- **שיפור**: גישה פשוטה לחישוב שכר לפי מערך דיור
- מדריך שעבד בשני מערכים יופיע בשניהם עם כל השכר שלו
- שליפה ישירה מה-DB של מערכי הדיור לפי הדירות שהמדריך עבד בהן
- קבצים: `routes/stats.py`

### סיבה
פישוט הלוגיקה - במקום לחלק את השכר, מדריך שעובד בשני מערכים מופיע בשניהם

---

## [2.2.6] - 2026-02-04

### שינויים
- **תיקון**: הסרת קטגוריית "ללא מערך" מגרף מערכי דיור
- חישוב יחס החלוקה רק לפי רצפי עבודה (work) שיש להם housing_array_name
- רצפי חופשה/מחלה/כוננות לא משפיעים על היחס כי אין להם דירה משויכת
- קבצים: `routes/stats.py`

### סיבה
הופיעה קטגוריית "ללא מערך" עם 171K כי רצפי חופשה/מחלה/כוננות נוצרים ללא housing_array_name

---

## [2.2.5] - 2026-02-04

### שינויים
- **תיקון**: סכום הגרף תואם כעת לסכום הכולל המוצג
- הוספת קטגוריית "ללא מערך" לרצפים ללא מערך דיור מוגדר
- הצגת 2 ספרות אחרי הנקודה בגרפים
- קבצים: `routes/stats.py`, `templates/stats.html`

### סיבה
היה הפרש בין סכום העמודות בגרף לסכום הכולל כי רצפים ללא מערך דיור לא נספרו

---

## [2.2.4] - 2026-02-04

### שינויים
- **תיקון**: שכר לפי מערך דיור - התאמה מלאה לייצוא שכר
- משתמש באותו חישוב כמו ייצוא שכר: total_payment לכל מדריך
- מחלק את total_payment לפי יחס השעות של המדריך בכל מערך דיור
- כולל כעת: עבודה, כוננויות, חופשה, מחלה, נסיעות, תוספות
- קבצים: `routes/stats.py`

### סיבה
הסכום בסטטיסטיקות (310K) לא כלל את כל רכיבי השכר מייצוא (403K):
- כוננויות, נסיעות, תוספות, חופשה ומחלה לא נספרו
- כעת הסכום זהה לייצוא שכר

---

## [2.2.3] - 2026-02-04

### שינויים
- **תיקון קריטי**: חישוב שכר לפי מערך דיור - חישוב מדויק מתוך נתוני הרצפים
- החישוב הקודם חילק לפי יחס משמרות, אבל לא התחשב בתעריפים שונים לדירות שונות
- כעת כל רצף (chain) נסכם לפי מערך הדיור שלו עם התשלום המחושב כולל תוספות
- קבצים: `routes/stats.py`

### סיבה
התשלום לפי מערך דיור לא התאים לייצוא שכר כי:
- משמרות שונות יש להן תעריפים שונים (תוספת שכר לפי סוג דירה)
- החלוקה לפי יחס משמרות לא הייתה מדויקת

---

## [2.2.2] - 2026-02-04

### שינויים
- **תיקון**: חישוב שכר לפי מערך דיור - כעת מחלק נכון אם מדריך עובד ביותר ממערך אחד
- **תיקון**: הוספת קטגוריית "ללא מערך" למדריכים שאינם משויכים למערך דיור
- הצגת סך הכל בכותרת גרף מערכי הדיור
- קבצים: `routes/stats.py`, `templates/stats.html`

### סיבה
הסכום בגרף מערכי דיור לא התאים לסכום בייצוא שכר כי מדריכים שעבדו ביותר ממערך אחד נספרו רק פעם אחת

---

## [2.2.1] - 2026-02-04

### שינויים
- התאמה למבנה DB חדש: הסרת טבלת `person_roles` מסקריפט הסנכרון
- שדה `role_id` עבר ישירות לטבלת `people` במקום טבלת קישור נפרדת
- קבצים: `scripts/db_sync.py`

### סיבה
שינוי מבנה הדאטהבייס - הטבלה `person_roles` הוסרה ובמקומה נוסף שדה `role_id` ישירות בטבלת `people`

---

## [2.2.0] - 2026-02-04

### שינויים
- **פיצ'ר חדש: דשבורד סטטיסטיקות מורחב עם 4 טאבים**
- מבנה חדש עם טאבים מודרניים: מערכי דיור, דירות, דירה, מדריך
- הסרת כרטיסי סיכום (לפי בקשה)
- **טאב מערכי דיור:**
  - גרף השוואת שכר בין כל מערכי הדיור
  - השוואה מורחבת בין 2-5 מערכים (חודש נוכחי וקודם)
  - Top 10 דירות לפי אחוז שכר (100%/125%/150%/175%/200%)
- **טאב דירות:**
  - השוואת כל הדירות במערך דיור - סך שכר
  - פילוח שעות לפי אחוזים (stacked bar)
- **טאב דירה:**
  - שעות ומשמרות לפי סוג משמרת
  - שכר לפי מדריך בדירה
- **טאב מדריך:**
  - מגמת שכר ושעות ב-12 חודשים אחרונים
- APIs חדשים: `compare-arrays`, `top-apartments`, `apartments-in-array`, `apartment-details`, `guide-yearly`
- קבצים: `routes/stats.py`, `templates/stats.html`, `app.py`

### סיבה
שיפור משמעותי בממשק הסטטיסטיקות עם גרפים מותאמים לפי רמת פירוט (מערך → דירות → דירה → מדריך)

---

## [2.1.1] - 2026-02-02

### שינויים
- **שיפור ביצועים: טעינה מהירה של דף סטטיסטיקות**
- מסך טעינה יפה בזמן חישוב הנתונים (loading screen)
- הסרת גרף מגמות מהסקירה הכללית (נטען בנפרד רק בלחיצה)
- הסקירה הכללית מציגה עכשיו: שכר לפי מערך, התפלגות שעות, כוננויות, וסוגי משמרות
- קבצים: `templates/stats.html`

### סיבה
הטעינה הייתה איטית כי גרף מגמות דרש חישוב של 6 חודשים. עכשיו הסקירה נטענת מיידית מהcache.

---

## [2.1.0] - 2026-02-02

### שינויים
- **פיצ'ר חדש: דשבורד סטטיסטיקות ויזואלי**
- עמוד חדש `/stats` עם גרפים אינטראקטיביים באמצעות Chart.js
- 7 סוגי ניתוחים: סקירה כללית, שכר לפי מערך, שכר לפי מדריך, התפלגות שעות, כוננויות ותוספות, סוגי משמרות, מגמות חודשיות
- אפשרות השוואה בין חודשים
- כפתור להחלפה בין גרף קו לעמודות
- כרטיסי סיכום (summary cards) עם נתוני מפתח
- תמיכה מלאה ב-RTL ועיצוב רספונסיבי
- קבצים חדשים: `routes/stats.py`, `templates/stats.html`
- קבצים מעודכנים: `app.py`, `templates/base.html`

### סיבה
תוספת ויזואליזציה לנתוני השכר לצורך ניתוח ומעקב

---

## [2.0.27] - 2026-02-02

### שינויים
- **תיקון פילטר מערך דיור בדף מדריך:** משמרות בדף מדריך מסוננות עכשיו לפי מערך הדיור הנבחר
- הוספת סינון לשאילתת `month_reports` בדף מדריך
- עדכון `get_available_months_for_person()` לסינון לפי מערך דיור
- קבצים: `routes/guide.py`, `core/logic.py`

### סיבה
כשנבחר מערך דיור ספציפי (כמו ASD), דף המדריך הציג משמרות מכל המערכים. עכשיו מוצגות רק משמרות בדירות מהמערך הנבחר.

---

## [2.0.26] - 2026-02-02

### שינויים
- **שיפור פילטר מערך דיור:** רשימת החודשים בדרופדאון מסוננת לפי מערך הדיור הנבחר
- כשנבחר מערך דיור, מוצגים רק חודשים שיש בהם משמרות או רכיבי תשלום מהמערך הזה
- שינוי פונקציית `available_months_from_db()` לקבל פרמטר `housing_array_id`
- קבצים: `utils/utils.py`, `routes/home.py`

### סיבה
כשסוננו לפי מערך דיור, רשימת החודשים הציגה את כל החודשים מכל המערכים. עכשיו מוצגים רק חודשים רלוונטיים.

---

## [2.0.25] - 2026-02-02

### שינויים
- **אופטימיזציית ביצועים משמעותית:** דף סיכום כללי נטען מהר פי 5-10
- שינוי מ-N+1 queries לטעינת Bulk: כל הנתונים נטענים בכמה שאילתות בודדות
- הוספת פרמטרים `preloaded_reports` ו-`preloaded_segments` ל-`get_daily_segments_data()`
- הוספת פרמטרים `preloaded_payment_comps` ו-`person_start_date` ל-`aggregate_daily_segments_to_monthly()`
- `calculate_monthly_summary()` טוען עכשיו את כל הנתונים מראש:
  - כל ה-time_reports לכל המדריכים בשאילתה אחת
  - כל ה-shift_time_segments לכל המשמרות בשאילתה אחת
  - כל ה-payment_components לכל המדריכים בשאילתה אחת
- קבצים: `app_utils.py`, `core/logic.py`

### סיבה
דף הסיכום הכללי היה איטי כי לכל מדריך נעשו 3-4 שאילתות DB נפרדות (N+1 problem). עם 50 מדריכים היו ~200 שאילתות. עכשיו יש ~5 שאילתות בלבד לכל הנתונים.

---

## [2.0.24] - 2026-02-02

### שינויים
- **פיצ'ר חדש:** סינון גלובלי לפי מערך דיור
- הוספת dropdown בכותרת לבחירת מערך דיור ספציפי או "כל המערכים"
- הסינון חל על כל הדפים: דף הבית, דף מדריך, סיכום כללי, וכל הייצואים
- הפילטר נשמר ב-cookie ועובר בין דפים
- כשנבחר מערך דיור, מוצגים רק מדריכים עם משמרות **או** רכיבי תשלום (נסיעות/תוספות) השייכים לדירות מהמערך הנבחר
- קבצים: `core/database.py`, `app.py`, `templates/base.html`, `routes/home.py`, `app_utils.py`, `core/logic.py`

### סיבה
המערכת הורחבה למערכי דיור נוספים ונדרשה אפשרות לראות נתונים רק של מערך דיור מסוים

---

## [2.0.23] - 2026-02-02

### שינויים
- תיקון באג בהיסטוריית תעריפים: NULL בטבלת היסטוריה עכשיו מחזיר שכר מינימום
- שינוי מ-COALESCE ל-CASE WHEN ב-`get_all_housing_rates_for_month()`
- קבצים: `core/history.py`

### סיבה
כשנשמרה רשומת היסטוריה עם ערכי NULL (=שכר מינימום), השאילתה השתמשה ב-`COALESCE(NULL, current_value)` שהחזיר את הערך הנוכחי במקום NULL. עכשיו השאילתה בודקת אם **יש** רשומת היסטוריה - אם כן, משתמשת בערכים שלה (גם אם NULL = שכר מינימום); אם לא, משתמשת בערכים הנוכחיים.

---

## [2.0.22] - 2026-02-02

### שינויים
- הסרת טבלת `shift_types_history` - הוחלפה לחלוטין ע"י `shift_type_housing_rates_history`
- מחיקת קובץ `sql/add_wage_percentage_to_history.sql` (לא רלוונטי יותר)
- עדכון `sql/add_performance_indexes.sql` - שינוי האינדקס לטבלה החדשה `shift_type_housing_rates_history`
- מיגרציית DB: `sql/drop_shift_types_history_table.sql` - מחיקת הטבלה הישנה מהדאטהבייס
- קבצים: `sql/add_performance_indexes.sql`, `PROJECT_DOCUMENTATION.md`

### סיבה
הטבלה `shift_types_history` הייתה שומרת היסטוריה של שדות `rate`, `is_minimum_wage`, `wage_percentage` מטבלת `shift_types`. לאחר המעבר לארכיטקטורה החדשה של תעריפים לפי מערך דיור (`shift_type_housing_rates` + `shift_type_housing_rates_history`), הטבלה הישנה כבר לא בשימוש.

---

## [2.0.21] - 2026-02-02

### שינויים
- הסרת טבלת `shift_time_segments_history` - לא הייתה בשימוש
- מחיקת פונקציות `save_segment_to_history`, `save_all_segments_to_history` מ-`core/history.py`
- מחיקת routes: `PUT /api/shift-segment/{segment_id}`, `POST /api/segments-history`
- מחיקת קובץ `sql/create_segments_history_table.sql`
- מיגרציית DB: `sql/drop_segments_history_table.sql` - מחיקת הטבלה מהדאטהבייס
- קבצים: `core/history.py`, `routes/admin.py`, `app.py`, `sql/drop_wage_percent_column.sql`, `PROJECT_DOCUMENTATION.md`

### סיבה
הטבלה והקוד הקשור לא היו בשימוש בפועל במערכת

---

## [2.0.20] - 2026-01-29

### שינויים
- תיקון באג: שגיאת "Internal Server Error" בדף סיכום חודשי
- הוספת שדות חסרים (`housing_array_id`, `apt_type_name`, `ha_name`) לטופל `early_exit_work_segments`
- קבצים: `app_utils.py`

### סיבה
כוננויות חלקיות שהומרו לשעות עבודה (יציאה מוקדמת) יצרו טופל עם 8 ערכים במקום 11 הנדרשים, מה שגרם לשגיאת `ValueError: not enough values to unpack`

---

## [2.0.19] - 2026-01-29

### שינויים
- הסרת שדה `wage_percent` מטבלת `shift_time_segments` - קוד מת שלא היה בשימוש
- תיקון טאב "סיכום פשוט" - עכשיו מחושב נכון מ-daily_segments (כמו שאר הטאבים)
- הסרת `buckets` מחישוב daily_segments - לא הוצג בשום מקום
- קבצים: `app_utils.py`, `routes/admin.py`, `routes/guide.py`, `core/history.py`, `templates/guide.html`
- מיגרציית DB: `sql/drop_wage_percent_column.sql`

### סיבה
השדה `wage_percent` בטבלת `shift_time_segments` לא היה בשימוש בפועל - אחוזי השכר מחושבים תמיד לפי כללי שעות נוספות (8 שעות ראשונות 100%, עד 10 שעות 125%, מעל 150%, ובשבת +50%). הטאב "סיכום פשוט" (לשעבר "חישוב ישן") השתמש בחישוב שגוי - תוקן להשתמש בנתונים הנכונים מ-daily_segments.

---

## [2.0.18] - 2026-01-29

### שינויים
- מדריכים עם תשלום נוסף (payment_components) מופיעים עכשיו בכל הדפים גם ללא משמרות בחודש
- דף הבית: מדריכים עם רכיבי תשלום מופיעים ברשימה
- דף מדריך: חודשים עם רכיבי תשלום זמינים לבחירה
- דף מדריך: טאבים מציגים נתונים גם כשיש רק רכיבי תשלום (ללא משמרות)
- קבצים: `routes/home.py`, `core/logic.py`, `templates/guide.html`

### סיבה
מדריכים שיש להם רק נסיעות או תוספות בחודש לא הופיעו ברשימה, לא ניתן היה לגשת לדף שלהם, והטאבים הציגו "אין נתונים"

---

## [2.0.17] - 2026-01-22

### שינויים
- ימי עבודה (קוד 767) כוללים עכשיו גם ימי מחלה וחופשה
- קבצים: `app_utils.py`

### סיבה
ימי עבודה צריכים לכלול את כל הימים שבהם העובד נחשב כ"עובד" - כולל מחלה וחופשה

---

## [2.0.16] - 2026-01-22

### שינויים
- קוד 199 (סה"כ שעות) מוצג בתצוגה המקדימה של ייצוא שכר
- קוד 199 לא ייוצא לקובץ גשר (.mrv) - נשאר אינפורמטיבי בלבד
- קבצים: `services/gesher_exporter.py`

### סיבה
קוד 199 הוא מידע אינפורמטיבי (סה"כ שעות) שצריך להיות מוצג בתצוגה המקדימה
אך לא לייצא לקובץ גשר כי מירב לא צריכה אותו.

---

## [2.0.15] - 2026-01-22

### שינויים
- תיקון: שורת ימי מחלה מוצגת בסיכום החודשי גם כשיום ראשון של מחלה (ללא תשלום)
- הכמות מוצגת (שעות וימים), הסכום מוצג 0
- קבצים: `templates/guide.html`

### סיבה
כשיש רק יום מחלה ראשון (שלא משלמים עליו), השורה לא הופיעה בכלל בסיכום.
עכשיו השורה מופיעה עם הכמות והסכום 0.

---

## [2.0.14] - 2026-01-22

### שינויים
- תיקון באג: סה"כ לתשלום מחושב עם עיגול בכל הפרויקט
- חישוב `rounded_total` ב-Python (app_utils.py) - מקור אמת יחיד
- כל השורות מחושבות: שעות מעוגלות × תעריף = סה"כ
- סכום השורות = סה"כ לתשלום בדיוק
- סה"כ מוצג עם 2 ספרות אחרי הנקודה (לדוגמה: 16,035.33)
- הוספת עמודת מחלה (sick_payment) לדף סיכום שכר כללי
- קבצים: `app_utils.py`, `core/logic.py`, `templates/guide.html`, `templates/general_summary.html`

### סיבה
הבאג: סכום השורות לא התאים לסה"כ לתשלום כי חלק מהשורות השתמשו בערכים אמיתיים
וחלק בערכים מעוגלים. עכשיו הכל עם עיגול - סכום השורות = סה"כ בדיוק.

---

## [2.0.13] - 2026-01-22

### שינויים
- הסכום בטבלת ייצוא שכר מחושב לפי שעות מעוגלות - **תואם למה שמירב תשלם בפועל**
- טבלה עם 5 עמודות: תיאור רכיב, קוד מירב, כמות (שעות), תעריף, סה"כ לתשלום
- קבצים: `templates/guide.html`

### סיבה
עקביות עם מערכת מירב - קובץ גשר שולח שעות מעוגלות (2 ספרות),
ומירב מחשבת: שעות × תעריף = סכום. עכשיו guide.html מציג את אותו סכום

---

## [2.0.12] - 2026-01-22

### שינויים
- תיקון באג: דיווחי שעת עבודה בשעות לילה (00:00-08:00) לא הופיעו בחודש הנכון
- דיווח עצמאי שמתחיל אחרי חצות (כמו 02:00-06:30) נשאר ביום שבו דווח
- רק משמרות שהתחילו לפני חצות והמשיכו ללילה משויכות ליום הקודם
- קבצים: `app_utils.py`

### סיבה
דיווח 02:00-06:30 מיום 01/01 היה משויך ליום 31/12 ונעלם מחודש ינואר

---

## [2.0.11] - 2026-01-22

### שינויים
- תיקון באג: כוננות מבוטלת שמתחילה בחצות (00:00) לא הוצגה בדוח
- הסרת תנאי מיותר שמנע הצגת כוננויות מבוטלות בשעות מסוימות
- קבצים: `app_utils.py`

### סיבה
כוננויות שהתבטלו בגלל חפיפה (כמו 22:00-00:00) לא הופיעו בדוח - עכשיו הן מופיעות עם הסיבה לביטול

---

## [2.0.10] - 2026-01-22

### שינויים
- כוננות חלקית בגלל יציאה מוקדמת - תשלום כשעות עבודה במקום תעריף כוננות קבוע
- אם העובד יצא לפני סיום הכוננות המוגדרת (ולא בגלל עבודה), השעות ממשיכות את הרצף
- תעריף שבת/חול נקבע לפי הזמן בפועל (מעבר משבת לחול משנה תעריף)
- קבצים: `app_utils.py`, `tests/test_salary_calculation.py`

### סיבה
כלל עסקי חדש - כוננות חלקית בגלל יציאה מוקדמת צריכה להיות משולמת כשעות עבודה

---

## [2.0.9] - 2026-01-22

### גרסה התחלתית
- תחילת תיעוד שינויים אוטומטי
- גרסה נוכחית של הפרויקט: 2.09

---
