# Changelog - יומן שינויים

כל השינויים בפרויקט DiyurCalc מתועדים כאן.

פורמט: [SemVer](https://semver.org/)

---

## [2.0.23] - 2026-02-02

### שינויים
- תיקון באג בהיסטוריית תעריפים: NULL בטבלת היסטוריה עכשיו מחזיר שכר מינימום
- שינוי מ-COALESCE ל-CASE WHEN ב-`get_all_housing_rates_for_month()`
- קבצים: `core/history.py`

### סיבה
כשנשמרה רשומת היסטוריה עם ערכי NULL (=שכר מינימום), השאילתה השתמשה ב-`COALESCE(NULL, current_value)` שהחזיר את הערך הנוכחי במקום NULL. עכשיו השאילתה בודקת אם **יש** רשומת היסטוריה - אם כן, משתמשת בערכים שלה (גם אם NULL = שכר מינימום); אם לא, משתמשת בערכים הנוכחיים.

---

## [2.0.22] - 2026-02-02

### שינויים
- הסרת טבלת `shift_types_history` - הוחלפה לחלוטין ע"י `shift_type_housing_rates_history`
- מחיקת קובץ `sql/add_wage_percentage_to_history.sql` (לא רלוונטי יותר)
- עדכון `sql/add_performance_indexes.sql` - שינוי האינדקס לטבלה החדשה `shift_type_housing_rates_history`
- מיגרציית DB: `sql/drop_shift_types_history_table.sql` - מחיקת הטבלה הישנה מהדאטהבייס
- קבצים: `sql/add_performance_indexes.sql`, `PROJECT_DOCUMENTATION.md`

### סיבה
הטבלה `shift_types_history` הייתה שומרת היסטוריה של שדות `rate`, `is_minimum_wage`, `wage_percentage` מטבלת `shift_types`. לאחר המעבר לארכיטקטורה החדשה של תעריפים לפי מערך דיור (`shift_type_housing_rates` + `shift_type_housing_rates_history`), הטבלה הישנה כבר לא בשימוש.

---

## [2.0.21] - 2026-02-02

### שינויים
- הסרת טבלת `shift_time_segments_history` - לא הייתה בשימוש
- מחיקת פונקציות `save_segment_to_history`, `save_all_segments_to_history` מ-`core/history.py`
- מחיקת routes: `PUT /api/shift-segment/{segment_id}`, `POST /api/segments-history`
- מחיקת קובץ `sql/create_segments_history_table.sql`
- מיגרציית DB: `sql/drop_segments_history_table.sql` - מחיקת הטבלה מהדאטהבייס
- קבצים: `core/history.py`, `routes/admin.py`, `app.py`, `sql/drop_wage_percent_column.sql`, `PROJECT_DOCUMENTATION.md`

### סיבה
הטבלה והקוד הקשור לא היו בשימוש בפועל במערכת

---

## [2.0.20] - 2026-01-29

### שינויים
- תיקון באג: שגיאת "Internal Server Error" בדף סיכום חודשי
- הוספת שדות חסרים (`housing_array_id`, `apt_type_name`, `ha_name`) לטופל `early_exit_work_segments`
- קבצים: `app_utils.py`

### סיבה
כוננויות חלקיות שהומרו לשעות עבודה (יציאה מוקדמת) יצרו טופל עם 8 ערכים במקום 11 הנדרשים, מה שגרם לשגיאת `ValueError: not enough values to unpack`

---

## [2.0.19] - 2026-01-29

### שינויים
- הסרת שדה `wage_percent` מטבלת `shift_time_segments` - קוד מת שלא היה בשימוש
- תיקון טאב "סיכום פשוט" - עכשיו מחושב נכון מ-daily_segments (כמו שאר הטאבים)
- הסרת `buckets` מחישוב daily_segments - לא הוצג בשום מקום
- קבצים: `app_utils.py`, `routes/admin.py`, `routes/guide.py`, `core/history.py`, `templates/guide.html`
- מיגרציית DB: `sql/drop_wage_percent_column.sql`

### סיבה
השדה `wage_percent` בטבלת `shift_time_segments` לא היה בשימוש בפועל - אחוזי השכר מחושבים תמיד לפי כללי שעות נוספות (8 שעות ראשונות 100%, עד 10 שעות 125%, מעל 150%, ובשבת +50%). הטאב "סיכום פשוט" (לשעבר "חישוב ישן") השתמש בחישוב שגוי - תוקן להשתמש בנתונים הנכונים מ-daily_segments.

---

## [2.0.18] - 2026-01-29

### שינויים
- מדריכים עם תשלום נוסף (payment_components) מופיעים עכשיו בכל הדפים גם ללא משמרות בחודש
- דף הבית: מדריכים עם רכיבי תשלום מופיעים ברשימה
- דף מדריך: חודשים עם רכיבי תשלום זמינים לבחירה
- דף מדריך: טאבים מציגים נתונים גם כשיש רק רכיבי תשלום (ללא משמרות)
- קבצים: `routes/home.py`, `core/logic.py`, `templates/guide.html`

### סיבה
מדריכים שיש להם רק נסיעות או תוספות בחודש לא הופיעו ברשימה, לא ניתן היה לגשת לדף שלהם, והטאבים הציגו "אין נתונים"

---

## [2.0.17] - 2026-01-22

### שינויים
- ימי עבודה (קוד 767) כוללים עכשיו גם ימי מחלה וחופשה
- קבצים: `app_utils.py`

### סיבה
ימי עבודה צריכים לכלול את כל הימים שבהם העובד נחשב כ"עובד" - כולל מחלה וחופשה

---

## [2.0.16] - 2026-01-22

### שינויים
- קוד 199 (סה"כ שעות) מוצג בתצוגה המקדימה של ייצוא שכר
- קוד 199 לא ייוצא לקובץ גשר (.mrv) - נשאר אינפורמטיבי בלבד
- קבצים: `services/gesher_exporter.py`

### סיבה
קוד 199 הוא מידע אינפורמטיבי (סה"כ שעות) שצריך להיות מוצג בתצוגה המקדימה
אך לא לייצא לקובץ גשר כי מירב לא צריכה אותו.

---

## [2.0.15] - 2026-01-22

### שינויים
- תיקון: שורת ימי מחלה מוצגת בסיכום החודשי גם כשיום ראשון של מחלה (ללא תשלום)
- הכמות מוצגת (שעות וימים), הסכום מוצג 0
- קבצים: `templates/guide.html`

### סיבה
כשיש רק יום מחלה ראשון (שלא משלמים עליו), השורה לא הופיעה בכלל בסיכום.
עכשיו השורה מופיעה עם הכמות והסכום 0.

---

## [2.0.14] - 2026-01-22

### שינויים
- תיקון באג: סה"כ לתשלום מחושב עם עיגול בכל הפרויקט
- חישוב `rounded_total` ב-Python (app_utils.py) - מקור אמת יחיד
- כל השורות מחושבות: שעות מעוגלות × תעריף = סה"כ
- סכום השורות = סה"כ לתשלום בדיוק
- סה"כ מוצג עם 2 ספרות אחרי הנקודה (לדוגמה: 16,035.33)
- הוספת עמודת מחלה (sick_payment) לדף סיכום שכר כללי
- קבצים: `app_utils.py`, `core/logic.py`, `templates/guide.html`, `templates/general_summary.html`

### סיבה
הבאג: סכום השורות לא התאים לסה"כ לתשלום כי חלק מהשורות השתמשו בערכים אמיתיים
וחלק בערכים מעוגלים. עכשיו הכל עם עיגול - סכום השורות = סה"כ בדיוק.

---

## [2.0.13] - 2026-01-22

### שינויים
- הסכום בטבלת ייצוא שכר מחושב לפי שעות מעוגלות - **תואם למה שמירב תשלם בפועל**
- טבלה עם 5 עמודות: תיאור רכיב, קוד מירב, כמות (שעות), תעריף, סה"כ לתשלום
- קבצים: `templates/guide.html`

### סיבה
עקביות עם מערכת מירב - קובץ גשר שולח שעות מעוגלות (2 ספרות),
ומירב מחשבת: שעות × תעריף = סכום. עכשיו guide.html מציג את אותו סכום

---

## [2.0.12] - 2026-01-22

### שינויים
- תיקון באג: דיווחי שעת עבודה בשעות לילה (00:00-08:00) לא הופיעו בחודש הנכון
- דיווח עצמאי שמתחיל אחרי חצות (כמו 02:00-06:30) נשאר ביום שבו דווח
- רק משמרות שהתחילו לפני חצות והמשיכו ללילה משויכות ליום הקודם
- קבצים: `app_utils.py`

### סיבה
דיווח 02:00-06:30 מיום 01/01 היה משויך ליום 31/12 ונעלם מחודש ינואר

---

## [2.0.11] - 2026-01-22

### שינויים
- תיקון באג: כוננות מבוטלת שמתחילה בחצות (00:00) לא הוצגה בדוח
- הסרת תנאי מיותר שמנע הצגת כוננויות מבוטלות בשעות מסוימות
- קבצים: `app_utils.py`

### סיבה
כוננויות שהתבטלו בגלל חפיפה (כמו 22:00-00:00) לא הופיעו בדוח - עכשיו הן מופיעות עם הסיבה לביטול

---

## [2.0.10] - 2026-01-22

### שינויים
- כוננות חלקית בגלל יציאה מוקדמת - תשלום כשעות עבודה במקום תעריף כוננות קבוע
- אם העובד יצא לפני סיום הכוננות המוגדרת (ולא בגלל עבודה), השעות ממשיכות את הרצף
- תעריף שבת/חול נקבע לפי הזמן בפועל (מעבר משבת לחול משנה תעריף)
- קבצים: `app_utils.py`, `tests/test_salary_calculation.py`

### סיבה
כלל עסקי חדש - כוננות חלקית בגלל יציאה מוקדמת צריכה להיות משולמת כשעות עבודה

---

## [2.0.9] - 2026-01-22

### גרסה התחלתית
- תחילת תיעוד שינויים אוטומטי
- גרסה נוכחית של הפרויקט: 2.09

---
