# תיעוד שינויים - DiyurClock

---

## גירסה 2.17 - 28/01/2026

### ניקוי קוד - העברת ערכים hardcoded לקבועים

**שינוי**: העברת ערכי זמן hardcoded לקובץ `core/constants.py` והסרת הגדרות מקומיות משוכפלות.

**קבועים חדשים שנוספו**:
- `TAGBUR_FRIDAY_PRE_ENTRY_MINUTES = 60` - שעה לפני כניסת שבת (תגבור שישי)
- `TAGBUR_SHABBAT_POST_EXIT_MINUTES = 120` - שעתיים אחרי צאת שבת (תגבור שבת)

**שינויים ב-app_utils.py**:
- הוספת imports לקבועים: `NIGHT_SHIFT_WORK_FIRST_MINUTES`, `NIGHT_SHIFT_STANDBY_END`, `NIGHT_SHIFT_MORNING_END`, `NOON_MINUTES`, `TAGBUR_FRIDAY_PRE_ENTRY_MINUTES`, `TAGBUR_SHABBAT_POST_EXIT_MINUTES`
- הסרת הגדרות מקומיות משוכפלות (WORK_FIRST_HOURS, STANDBY_END, MORNING_WORK_START, MORNING_WORK_END)
- החלפת 720 ב-`NOON_MINUTES` (4 מופעים)
- החלפת 60 ב-`TAGBUR_FRIDAY_PRE_ENTRY_MINUTES`
- החלפת 120 ב-`TAGBUR_SHABBAT_POST_EXIT_MINUTES`

**קבצים שהשתנו**: `core/constants.py`, `app_utils.py`

---

## גירסה 2.16 - 28/01/2026

### תיקון - תעריף שבת לליווי בי"ח מגיע מטבלת shift_type_housing_rates

**שינוי**: הסרת לוגיקה קבועה בקוד שהגדירה שכר מינימום למשמרת ליווי בי"ח (120) בשבת.

**רקע**: בעבר הוגדר בקוד שמשמרת ליווי בי"ח בשבת תמיד מחושבת לפי שכר מינימום. עם הרחבת המערכת והוספת טבלת `shift_type_housing_rates` שמאפשרת הגדרת תעריפי שבת ספציפיים, יש לקחת את התעריף מהטבלה במקום מהקוד.

**התיקון**:
- הסרת התנאי המיוחד ל-`is_hospital_escort_shift` בחישוב `seg_rate`
- התעריף נלקח כעת מ-`seg_rates_dict["shabbat"]` (שמגיע מטבלת `shift_type_housing_rates`)
- הסרת import לא בשימוש: `is_hospital_escort_shift`

**קבצים שהשתנו**: `app_utils.py`

---

## גירסה 2.15 - 28/01/2026

### הוספת עמודות "מערך דיור", "סוג דירה" ו"בסיס תעריף" לדוח פירוט רצפים

**שינוי**: הוספת שלוש עמודות חדשות לטבלת פירוט הרצפים בדף המדריך:
- **מערך** - שם מערך הדיור (housing_array_name)
- **סוג דירה** - שם סוג הדירה (apartment_type_name)
- **בסיס** - בסיס התעריף השעתי (effective_rate) - מציג 40₪, 50₪, שכר מינימום וכו'

**שינויים בקוד**:

1. **app_utils.py - שאילתת SQL**:
   - הוספת JOIN לטבלת `housing_arrays` לקבלת שם המערך
   - הוספת `at.name AS apartment_type_name` לקבלת שם סוג הדירה
   - הוספת `ha.name AS housing_array_name` לקבלת שם מערך הדיור

2. **app_utils.py - מעבר נתונים**:
   - הוספת `apartment_type_name` ו-`housing_array_name` ל-tuple של סגמנטים (15 שדות במקום 13)
   - עדכון unpacking של סגמנטים בכל המקומות הרלוונטיים
   - הוספת השדות ל-`work_segments`, `all_events`, `current_chain_segments`
   - הוספת השדות לכל dictionaries של chains (work, standby, vacation, sick)
   - **תיקון**: שימוש ב-`seg_rate` (התעריף הנכון לפי שבת/חול) במקום `effective_rate` (שתמיד היה תעריף חול)

3. **templates/guide.html**:
   - הוספת שלוש עמודות חדשות לכותרת הטבלה (מערך, סוג דירה, בסיס)
   - הוספת תאים תואמים לשורות הנתונים
   - הוספת השדות החדשים ל-`new_group` בלוגיקת האיחוד
   - עדכון colspan של שורת הסיכום היומי מ-4 ל-7

**קבצים שהשתנו**: `app_utils.py`, `templates/guide.html`

---

## גירסה 2.14 - 28/01/2026

### תיקון באג - תעריף שגוי כשאותו shift_type_id מופיע עם housing_array_id שונים

**רקע**: נמצא באג שבו תעריף השבת של משמרת 138 (שעת עבודה) חושב לפי שכר מינימום (51.60₪) במקום לפי הערך בטבלה (75₪).

**הבעיה**: מילון `shift_rates` היה מאונדקס רק לפי `shift_id`. כאשר משמרת מסוימת מופיעה בדיווחים עם `housing_array_id` שונים (לדוגמה: דירה עם housing_array=1 ודירה עם housing_array=2), רק התעריף של הדירה הראשונה נשמר. דירות עם housing_array אחר קיבלו תעריף שגוי.

**דוגמה**: משמרת 138 עם housing_array_id=1 יש shabbat_rate=NULL, אבל עם housing_array_id=2 יש shabbat_rate=50₪. אם הדיווח הראשון היה מדירה עם housing_array=1, גם דיווחים מדירה עם housing_array=2 קיבלו את התעריף השגוי (שכר מינימום).

**התיקון**: שינוי מפתח `shift_rates` מ-`shift_id` ל-`(shift_id, housing_array_id)`:

| מקום | לפני | אחרי |
|------|------|------|
| מפתח shift_rates | `shift_id` | `(shift_id, housing_array_id)` |
| חיפוש תעריף | `shift_rates.get(shift_id)` | `shift_rates.get((shift_id, housing_array_id))` |

**שינויים בקוד**:
- הוספת `housing_array_id` ל-tuple של סגמנטים (10 שדות במקום 9)
- עדכון unpacking של סגמנטים בכל המקומות
- הוספת `housing_array_id` ל-`work_segments` ו-`all_events`
- עדכון `_calculate_previous_month_carryover` להחזיר ולעקוב אחרי `housing_array_id`
- תיקון `close_chain_and_record` - חישוב תשלום לכל שורה לפי התעריף הנכון:
  - חילוץ `housing_array_id` מכל סגמנט
  - בניית `rate_key = (shift_id, housing_array_id)` לכל סגמנט
  - שימוש בתעריף שבת או חול לפי `is_shabbat`
- הוספת `housing_array_id` ל-`split_segment_by_apartments`
- הצגת תוספת סוג דירה בפירוט: אם יש `hourly_wage_supplement` בטבלת `apartment_types`, מוצג `(100% +X.XX)` במקום `(100%)`

**קבצים שהשתנו**: `app_utils.py`

---

## גירסה 2.13 - 28/01/2026

### תיקון עקביות חישוב תשלום - סכום השורות = סה"כ

**רקע**: נמצאו שני פערים:
1. פער בין תשלום שורה לבין חישוב ידני מהשעות המוצגות
2. פער בין סכום תשלומי השורות לבין הסה"כ החודשי

**הבעיות**:
- **שורה בודדת**: שעות מוצגות 9.43, תשלום 649.01, אבל 9.43 × 2 × 34.40 = 648.78
- **סה"כ חודשי**: סכום השורות ≠ הסה"כ (כי `round(a) + round(b) ≠ round(a+b)`)

**התיקון** - כל התשלומים מחושבים משעות מעוגלות:

| מקום | לפני | אחרי |
|------|------|------|
| תשלום סגמנט | `(minutes/60) × rate` | `round(minutes/60, 2) × rate` |
| תשלום רצף | סכום דקות → תשלום | סכום תשלומי סגמנטים |
| חופשה/מחלה | `(minutes/60) × rate` | `round(minutes/60, 2) × rate` |
| סה"כ חודשי | חישוב מחדש מסך הדקות | סכום התשלומים היומיים |

**תוצאה**: חישוב ידני מהשעות המוצגות = התשלום המוצג, וסכום השורות = הסה"כ

**קבצים שהשתנו**: `app_utils.py`

---

## גירסה 2.12 - 28/01/2026

### ניקוי קוד - הסרת לוגיקת תעריפים ישנה

**רקע**: לאחר המעבר לטבלה החדשה `shift_type_housing_rates`, הקוד הישן שהשתמש בשדות `rate`, `is_minimum_wage`, `wage_percentage` מטבלת `shift_types` הפך למיותר.

#### קוד שנמחק

**[core/history.py](../core/history.py)**
*   פונקציה `get_shift_rate_for_month()` - הוחלפה ע"י `get_all_housing_rates_for_month()`
*   פונקציה `save_shift_rate_to_history()` - לא נדרשת יותר
*   פונקציה `get_all_shift_rates_for_month()` - הוחלפה ע"י `get_all_housing_rates_for_month()`

**[app_utils.py](../app_utils.py)**
*   הוסר פרמטר `shift_rates_cache` מ-`get_daily_segments_data()`
*   הוסר קוד שהחליף `shift_rate` ו-`shift_is_minimum_wage` מ-cache היסטורי
*   הוסרו שדות `st.rate AS shift_rate`, `st.is_minimum_wage AS shift_is_minimum_wage` משאילתות SQL

**[core/logic.py](../core/logic.py)**
*   הוסר ייבוא `get_all_shift_rates_for_month`
*   הוסר בניית `shift_rates_cache`
*   הוסר העברת `shift_rates_cache` ל-`get_daily_segments_data()`

**[routes/admin.py](../routes/admin.py)**
*   נמחקה פונקציה `update_shift_type_rate()` - API ישן לעדכון תעריף

**[app.py](../app.py)**
*   הוסר route `/api/shift-types/{shift_type_id}/rate`

**סקריפטים שנמחקו**
*   `scripts/check_all_rates.py` - סקריפט בדיקה ישן
*   `scripts/update_demo_rates.py` - סקריפט עדכון demo ישן

#### תמיכה בהיסטוריה

`get_all_housing_rates_for_month()` עודכנה לתמוך בטבלת היסטוריה `shift_type_housing_rates_history`:
*   אם מסופקים `year` ו-`month`, מחפשת רשומות היסטוריות לפי לוגיקת "valid until"
*   רשומות היסטוריה מחליפות את הערכים הנוכחיים עבור חודשים קודמים

#### הערה חשובה
**השדות והטבלאות הבאים לא נמחקו מ-DB** (אפשר למחוק בעתיד):
*   `shift_types.rate`
*   `shift_types.is_minimum_wage`
*   `shift_types.wage_percentage`
*   טבלה `shift_types_history`

---

## גירסה 2.11 - 28/01/2026

### תעריפי משמרות לפי מערך דיור

**רקע**: הרחבת המערכת לתמיכה במערכי דיור נוספים, כאשר לכל מערך דיור יכולים להיות תעריפים שונים.

#### שינויים בבסיס הנתונים
*   **טבלה חדשה `housing_arrays`**: מערכי דיור (id, name)
*   **טבלה חדשה `shift_type_housing_rates`**: תעריפים לפי סוג משמרת + מערך דיור
    - `shift_type_id`: סוג המשמרת
    - `housing_array_id`: מערך הדיור
    - `weekday_single_rate` / `weekday_single_wage_percentage`: תעריף חול לרווק
    - `weekday_married_rate` / `weekday_married_wage_percentage`: תעריף חול לנשוי
    - `shabbat_rate` / `shabbat_wage_percentage`: תעריף שבת/חג
*   **שדה חדש `housing_array_id`** בטבלאות `apartments` ו-`people`

#### שינויים בקוד

**[core/history.py](../core/history.py)**
*   פונקציה חדשה `get_all_housing_rates_for_month()` - טוענת תעריפי מערכי דיור

**[app_utils.py](../app_utils.py)**
*   פונקציה חדשה `calculate_rate_from_housing_rates()` - חישוב תעריף לפי:
    - שבת → `shabbat_rate` או `shabbat_wage_percentage × מינימום`
    - חול נשוי → `weekday_married_rate` או `weekday_married_wage_percentage × מינימום`
    - חול רווק → `weekday_single_rate` או `weekday_single_wage_percentage × מינימום`
    - הכל ריק → שכר מינימום
*   עדכון `get_effective_hourly_rate()` - תמיכה בפרמטרים `is_shabbat` ו-`housing_rates_cache`
*   עדכון `get_daily_segments_data()`:
    - שליפת `ap.housing_array_id` מהדירה (לא מהמדריך)
    - שמירת שני תעריפים לכל משמרת: `{"weekday": rate, "shabbat": rate}`
*   עדכון `_calculate_previous_month_carryover()` - אותם שינויים

#### לוגיקת חישוב התעריף
```
1. קבלת housing_array_id מהדירה (apartments.housing_array_id)
2. חיפוש ב-shift_type_housing_rates לפי (shift_type_id, housing_array_id)
3. בחירת תעריף לפי:
   - שבת/חג → shabbat_rate או shabbat_wage_percentage
   - חול + נשוי → weekday_married_rate או weekday_married_wage_percentage
   - חול + רווק → weekday_single_rate או weekday_single_wage_percentage
4. אם אין תעריף מוגדר → שכר מינימום + תוספת סוג דירה
```

#### תוספת שעתית לפי סוג דירה
*   **שדה חדש `hourly_wage_supplement`** בטבלת `apartment_types` (באגורות)
*   כאשר אין תעריף ספציפי בטבלת `shift_type_housing_rates`, התשלום הוא:
    ```
    שכר מינימום + (hourly_wage_supplement / 100)
    ```
*   שימושי עבור סוגי דירות שדורשים תוספת קבועה לשעה מעבר לשכר מינימום

#### בדיקות
*   עדכון `TestEffectiveHourlyRate` ב-[tests/test_logic.py](../tests/test_logic.py) ללוגיקה החדשה
*   129 בדיקות עברו בהצלחה

---

## Code Review & Clean Code - 15/01/2026

### 1. איחוד קבועים למקור אמת יחיד (DRY)
*   **השינוי**: הסרת כפילות של קבועי Shift IDs ופונקציות helper מ-`app_utils.py` ו-`segments.py`.
*   **הסבר**: קבועים כמו `FRIDAY_SHIFT_ID`, `SHABBAT_SHIFT_ID`, `TAGBUR_SHIFT_IDS` וכו' היו מוגדרים ב-3 מקומות שונים. עכשיו כולם מוגדרים רק ב-`core/constants.py` ומיובאים משם.
*   **קבצים שהושפעו**:
    - `app_utils.py` - הוחלפו הגדרות מקומיות בייבוא מ-`core/constants.py`
    - `core/segments.py` - הוחלפו הגדרות מקומיות בייבוא מ-`core/constants.py`
*   **תאימות לאחור**: נשמרו aliases עם קו תחתון (`_is_tagbur_shift` וכו') לתאימות עם קוד קיים.

### 2. העברת סיסמה ל-Environment Variable (אבטחה)
*   **השינוי**: הסרת סיסמה hardcoded מ-`app.py` והעברתה ל-environment variable.
*   **הסבר**: סיסמת מעבר ל-Demo Mode הייתה כתובה בקוד. עכשיו היא נשלפת מ-`DEMO_MODE_PASSWORD` ב-.env.
*   **קבצים שהושפעו**:
    - `app.py:385-391` - שימוש ב-`config.DEMO_MODE_PASSWORD`
    - `core/config.py:44-45` - הוספת הגדרת `DEMO_MODE_PASSWORD`
    - `.env` - הוספת `DEMO_MODE_PASSWORD=8942798`

### 3. הסרת Dead Code מ-logic.py
*   **השינוי**: הסרת פונקציות וקבועים שלא בשימוש.
*   **פרטים**:
    - הוסרה `get_db_connection()` (legacy - הוחלף ע"י `get_conn()`)
    - הוסרה `_calculate_totals_from_data()` (לא בשימוש - החישוב עובר דרך `app_utils`)
    - הוסרו קבועים לא בשימוש: `WAGE_MULTIPLIER_*`, `MORNING_STANDBY_END_MINUTES`, `WORK_DAY_END_NORMALIZED`, `MINIMUM_ESCORT_MINUTES`, `NIGHT_STANDBY_WAGE_PERCENT`
*   **קבצים שהושפעו**: `core/logic.py`

### 4. ניקוי Imports לא בשימוש
*   **השינוי**: הסרת `Optional` מ-typing imports ב-`logic.py`.
*   **קבצים שהושפעו**: `core/logic.py:15`

### סטטוס בדיקות
*   58/60 בדיקות עברו בהצלחה
*   2 בדיקות נכשלו (בעיות קיימות לא קשורות לשינויים אלה)
*   2 בדיקות עם שגיאות fixture (לא קשורות לשינויים אלה)

---

## גירסה 2.10 - 15/01/2026

### 1. תיקון באג חישוב גבולות שבת במשמרות שמסתיימות בחצות
*   **השינוי**: תיקון תנאי בחישוב `day_offset_end` בפונקציית `_calculate_chain_wages`.
*   **הסבר**: כשמשמרת הסתיימה בדיוק בחצות (24:00 = 1440 דקות), התנאי `>= MINUTES_PER_DAY` גרם להוספת offset שגוי. זה גרם לחישוב של 2880 דקות (יום ראשון) במקום 1440 (סוף יום שישי), מה שהוביל לשעות שליליות ו-3 chains במקום 1.
*   **התיקון**: שינוי התנאי מ-`>=` ל-`>` כי 1440 בדיוק (חצות) הוא עדיין סוף היום הנוכחי.
*   **קבצים שהושפעו**: `core/wage_calculator.py:177`.

### 2. תיקון באג העברת סוג דירה לחישוב תגבור משתמע
*   **השינוי**: תיקון העברת פרמטרים ב-`current_chain_segments.append()`.
*   **הסבר**: הפרמטר `apt_type` קיבל בטעות את `apartment_type_id` (הסוג האמיתי) במקום `rate_apt_type` (הסוג לתעריף), מה שגרם לזיהוי שגוי של תגבור משתמע.
*   **קבצים שהושפעו**: `app_utils.py:1400`.

### 3. הוספת הצגת תגבור משתמע בטאב משמרות
*   **השינוי**: הוספת לוגיקה לזיהוי והצגת "תגבור שישי/ערב חג" או "תגבור שבת/חג" בטאב משמרות.
*   **הסבר**: כשמשמרת שישי/שבת (105/106) מתבצעת בדירה טיפולית עם תעריף דירה רגילה, מוצגת כ"תגבור" - בדומה לטאב רצפים.
*   **קבצים שהושפעו**: `routes/guide.py:24,353,461-479`, `templates/guide.html:556`.

### 4. תיקון חישוב שכר כשיש שתי משמרות עם תעריפים שונים
*   **השינוי**: הוספת לוגיקה לשבירת chain כשמשתנה התעריף, תוך שמירת offset לחישוב שעות נוספות.
*   **הסבר**: כשיש משמרת חול (103) עם שכר מינימום ומשמרת עם תעריף קבוע (למשל 149 עם 40₪/שעה) באותו יום, הם היו ממוזגים ל-chain אחד עם תעריף אחיד. עכשיו כל קטע מחושב לפי התעריף שלו, כשה-overtime נמשך על פני כל יום העבודה.
*   **דוגמה**: גבאי יעקב 03/12/2025 - משמרת 103 (08:00-14:30) + משמרת 149 (14:30-22:00) = 2 chains נפרדים, כל אחד לפי התעריף המתאים לו.
*   **קבצים שהושפעו**: `app_utils.py:1325-1335, 1338, 1348-1353, 1425`.

---

## גירסה 2.09 - 15/01/2026

### 1. תיקון באג כוננות כפולה
*   **השינוי**: תיקון חישוב כפול של כוננות כשהיא נפצלת ע"י עבודה באמצע.
*   **הסבר**: כשמשמרת לילה עם כוננות 22:00-06:30 כוללת עבודה באמצע (למשל 00:00-01:00), הכוננות נפצלת לשני חלקים. קודם שני החלקים נספרו ככוננויות נפרדות (140₪ במקום 70₪).
*   **קבצים שהושפעו**: `app_utils.py`, `core/app_utils.py`.

### 2. תיקון Deduplication של משמרות
*   **השינוי**: הוספת `shift_id` למפתח ה-deduplication של סגמנטי עבודה.
*   **הסבר**: שתי משמרות באותם זמנים אך בדירות/סוגי משמרת שונים היו ממוזגות בטעות לאחת. עכשיו כל משמרת נספרת בנפרד.
*   **השפעה**: עובד 211 קיבל +176₪ כוננות (תשלום נכון שחסר קודם).
*   **קבצים שהושפעו**: `app_utils.py:707`, `core/app_utils.py:731`.

### 3. סימון דירה טיפולית בדוח רצפים
*   **השינוי**: הוספת אייקון ❤ ליד שם הדירה אם היא מסוג "טיפולית" (apartment_type_id=2).
*   **הסבר**: מאפשר לזהות במבט מהיר אילו משמרות הן בדירות טיפוליות.
*   **קבצים שהושפעו**: `templates/guide.html`, `app_utils.py`.

### 4. שיפור ולידציה של תעריפים
*   **השינוי**: הוספת בדיקה לתעריפים שליליים או אפס בפונקציית `get_effective_hourly_rate`.
*   **הסבר**: אם יש שגיאה בנתונים והתעריף לא תקין, המערכת תחזור לשכר מינימום ותרשום אזהרה ללוג.
*   **קבצים שהושפעו**: `app_utils.py:21-41`.

### 5. הוספת Logging לדוחות שנדלגים
*   **השינוי**: הוספת רישום ללוג כשדיווחים נדלגים בגלל תאריך מחוץ לחודש הנבחר.
*   **הסבר**: מסייע באיתור בעיות בנתונים כשדיווחים לא מופיעים בדוח.
*   **קבצים שהושפעו**: `app_utils.py:369`, `core/app_utils.py:469`.

### 6. כלי בדיקת רגרסיה
*   **השינוי**: הוספת סקריפט `tests/payroll_snapshot.py` ליצירת "תמונות מצב" של חישובי שכר.
*   **הסבר**: מאפשר להשוות חישובים לפני ואחרי שינויים כדי לוודא שלא נשברו דברים.
*   **שימוש**:
    *   `python tests/payroll_snapshot.py --before --year 2025 --month 12`
    *   `python tests/payroll_snapshot.py --after --year 2025 --month 12`
    *   `python tests/payroll_snapshot.py --compare --year 2025 --month 12`

---

## עדכון 07/01/2026 (המשך)

### 6. שימוש בשכר מינימום היסטורי
*   **השינוי**: תיקון `simple_summary_view` ב-`routes/guide.py` לשימוש בשכר מינימום היסטורי.
*   **הסבר**: הפונקציה השתמשה ב-`get_minimum_wage` שמחזיר את התעריף הנוכחי, במקום `get_minimum_wage_for_month` שמחזיר את התעריף לפי החודש הנבחר.
*   **קבצים שהושפעו**: `routes/guide.py`.

### 7. הסרת ייבוא לא בשימוש
*   **השינוי**: הסרת `get_minimum_wage` מהייבוא ב-`routes/guide.py`.
*   **הסבר**: לאחר המעבר ל-`get_minimum_wage_for_month`, הייבוא הישן הפך למיותר.
*   **קבצים שהושפעו**: `routes/guide.py`.

### 8. תמיכה ב-rate_apartment_type_id לדריסת סוג דירה
*   **השינוי**: הוספת לוגיקה לבדיקת `rate_apartment_type_id` בדיווחים.
*   **הסבר**:
    *   אם שדה `rate_apartment_type_id` מוגדר בדיווח, המערכת תשתמש בו לחישוב תעריף הכוננות.
    *   סדר עדיפויות: `rate_apartment_type_id` > היסטורי > נוכחי.
    *   שימושי כאשר רוצים לחשב תעריף לפי סוג דירה שונה מהדירה בה בוצעה המשמרת בפועל.
*   **קבצים שהושפעו**: `logic.py`, `app_utils.py`.

### 9. תמיכה בתעריפי כוננות היסטוריים
*   **השינוי**: תיקון קריאות ל-`get_standby_rate` ב-`app_utils.py` להעברת פרמטרי year ו-month.
*   **הסבר**:
    *   הפונקציה `get_standby_rate` כבר תמכה בתעריפים היסטוריים, אבל הקריאות אליה לא העבירו את החודש והשנה.
    *   עכשיו תעריפי כוננות משתמשים בלוגיקת "valid until" כמו סוגי דירות ומצב אישי.
    *   לדוגמה: אם שונה תעריף כוננות ל-50 ש"ח מ-01/2026, חודשים קודמים יציגו את התעריף הישן.
*   **קבצים שהושפעו**: `app_utils.py` (שורות 902, 1185).

### 10. עדיפות למשמרת שבת/חג בחישוב כוננות
*   **השינוי**: כשיש משמרת שבת/חג ביום עם כוננות, המערכת תשתמש בתעריף הכוננות של משמרת השבת.
*   **הסבר**:
    *   כשיש משמרת שבת ומשמרת לילה באותו יום (למשל 27/12/2025), הכוננות צריכה להיות לפי תעריף השבת (145 ש"ח) ולא לפי תעריף הלילה (70 ש"ח).
    *   הוספת מעקב אחר `shift_type_id` לכל יום (`day_shift_types`).
    *   הוספת מיפוי `shabbat_standby_seg_ids` שמחזיק את ה-segment_id של סגמנט הכוננות של כל משמרת שבת.
    *   אם ביום יש משמרת שבת, כל הכוננויות באותו יום משתמשות ב-segment_id של משמרת השבת לחישוב התעריף.
*   **קבצים שהושפעו**: `app_utils.py`.

---

בתאריך 07/01/2026 בוצעו העדכונים הבאים במערכת:

## 1. הרחבת מנגנון תעריפי משמרות (wage_percentage)
*   **השינוי**: הוספת תמיכה בשדה "אחוז שכר" (`wage_percentage`) ברמת סוג המשמרת וההיסטוריה שלה.
*   **הסבר**: מעתה המערכת שומרת ומשחזרת מההיסטוריה לא רק את התעריף השעתי אלא גם את האחוז המוגדר למשמרת.
*   **קבצים שהושפעו**: `history.py`, `logic.py`.

## 2. עדיפות לסוג דירה לצורך תעריף (rate_apartment_type_id)
*   **השינוי**: הוספת תמיכה בשדה `rate_apartment_type_id` בדוחות השעות.
*   **הסבר**: במידה ומוגדר סוג דירה ספציפי לדיווח, המערכת תשתמש בו לצורך חישוב התעריף והכוננות, תוך עקיפת סוג הדירה ההיסטורי או הנוכחי של הדירה עצמה.
*   **קבצים שהושפעו**: `logic.py`, `app_utils.py`.

## 3. פישוט לוגיקת בחירת תעריף ב-UI
*   **השינוי**: עדכון הפונקציה `get_effective_hourly_rate` ב-`app_utils.py`.
*   **הסבר**: המערכת תשתמש בתעריף המוגדר למשמרת בכל פעם שהוא קיים, ללא תלות בסימון "שכר מינימום", כדי להבטיח עקביות בין התצוגה לחישובים.
*   **קבצים שהושפעו**: `app_utils.py`.

## 4. שיפור חישוב "תעריף משתנה"
*   **השינוי**: שיפור הלוגיקה שמחשבת את ההפרשים בין תעריף משמרת לשכר המינימום ב-`logic.py`.
*   **הסבר**: הקוד הפך לישיר ומדויק יותר בבניית מפת התעריפים המשתנים לפי הדיווחים בפועל.

## 5. עדכון לוגיקת היסטוריה (המשך)
*   **השינוי**: עדכון לוגיקת השאילתות של "בתוקף עד" (Valid Until).
*   **הסבר**: מעתה, רשומה היסטורית המוגדרת עד חודש X, תקפה **עד ולא כולל** את חודש X.
*   **קבצים שהושפעו**: `history.py`.

## 2. משמרת ליווי רפואי (ID 148) - מינימום שעה לתשלום
*   **השינוי**: הוספת בונוס דקות אוטומטי למשמרות שקצרות מ-60 דקות.
*   **הסבר**: 
    *   חישוב השכר (Payroll) יתבצע על מינימום 60 דקות (במידה והדיווח קצר מכך).
    *   הדיווח ב-UI מציג את השעות המקוריות (זמן אמת) כדי לשמור על דיוק הדיווחים.
    *   סיכום שעות העבודה החודשי כולל רק את דקות העבודה בפועל.
*   **קבצים שהושפעו**: `logic.py`, `app_utils.py`.

## 3. עדכון תעריף משמרת ניקיון (ID 147)
*   **השינוי**: עדכון התעריף ל-50 ש"ח (5000 אגורות) החל מ-01/2026.
*   **הסבר**: 
    *   התעריף הקודם (40 ש"ח) נשמר בטבלת ההיסטוריה עד ל-12/2025.
    *   עודכן בבסיס הנתונים הראשי (Production) ובבסיס הנתונים של הדמו (Demo).

## 4. תיקון עקביות בתצוגת הדוחות (UI)
*   **השינוי**: החלת תעריפים היסטוריים גם בתצוגת "פירוט רצפים".
*   **הסבר**: תוקן באג שבו ה-UI הציג תעריף נוכחי גם עבור חודשי עבר. מעתה, אם קיים תעריף היסטורי בטבלה, הוא יוצג בדוח החודשי המתאים.
*   **קבצים שהושפעו**: `app_utils.py`.

---
**סטטוס אימות**: כל השינויים נבדקו ואומתו מול בסיסי הנתונים (פיתוח ועבודה).
