# תיעוד שינויים - DiyurClock

---

## גירסה 2.09 - 15/01/2026

### 1. תיקון באג כוננות כפולה
*   **השינוי**: תיקון חישוב כפול של כוננות כשהיא נפצלת ע"י עבודה באמצע.
*   **הסבר**: כשמשמרת לילה עם כוננות 22:00-06:30 כוללת עבודה באמצע (למשל 00:00-01:00), הכוננות נפצלת לשני חלקים. קודם שני החלקים נספרו ככוננויות נפרדות (140₪ במקום 70₪).
*   **קבצים שהושפעו**: `app_utils.py`, `core/app_utils.py`.

### 2. תיקון Deduplication של משמרות
*   **השינוי**: הוספת `shift_id` למפתח ה-deduplication של סגמנטי עבודה.
*   **הסבר**: שתי משמרות באותם זמנים אך בדירות/סוגי משמרת שונים היו ממוזגות בטעות לאחת. עכשיו כל משמרת נספרת בנפרד.
*   **השפעה**: עובד 211 קיבל +176₪ כוננות (תשלום נכון שחסר קודם).
*   **קבצים שהושפעו**: `app_utils.py:707`, `core/app_utils.py:731`.

### 3. סימון דירה טיפולית בדוח רצפים
*   **השינוי**: הוספת אייקון ❤ ליד שם הדירה אם היא מסוג "טיפולית" (apartment_type_id=2).
*   **הסבר**: מאפשר לזהות במבט מהיר אילו משמרות הן בדירות טיפוליות.
*   **קבצים שהושפעו**: `templates/guide.html`, `app_utils.py`.

### 4. שיפור ולידציה של תעריפים
*   **השינוי**: הוספת בדיקה לתעריפים שליליים או אפס בפונקציית `get_effective_hourly_rate`.
*   **הסבר**: אם יש שגיאה בנתונים והתעריף לא תקין, המערכת תחזור לשכר מינימום ותרשום אזהרה ללוג.
*   **קבצים שהושפעו**: `app_utils.py:21-41`.

### 5. הוספת Logging לדוחות שנדלגים
*   **השינוי**: הוספת רישום ללוג כשדיווחים נדלגים בגלל תאריך מחוץ לחודש הנבחר.
*   **הסבר**: מסייע באיתור בעיות בנתונים כשדיווחים לא מופיעים בדוח.
*   **קבצים שהושפעו**: `app_utils.py:369`, `core/app_utils.py:469`.

### 6. כלי בדיקת רגרסיה
*   **השינוי**: הוספת סקריפט `tests/payroll_snapshot.py` ליצירת "תמונות מצב" של חישובי שכר.
*   **הסבר**: מאפשר להשוות חישובים לפני ואחרי שינויים כדי לוודא שלא נשברו דברים.
*   **שימוש**:
    *   `python tests/payroll_snapshot.py --before --year 2025 --month 12`
    *   `python tests/payroll_snapshot.py --after --year 2025 --month 12`
    *   `python tests/payroll_snapshot.py --compare --year 2025 --month 12`

---

## עדכון 07/01/2026 (המשך)

### 6. שימוש בשכר מינימום היסטורי
*   **השינוי**: תיקון `simple_summary_view` ב-`routes/guide.py` לשימוש בשכר מינימום היסטורי.
*   **הסבר**: הפונקציה השתמשה ב-`get_minimum_wage` שמחזיר את התעריף הנוכחי, במקום `get_minimum_wage_for_month` שמחזיר את התעריף לפי החודש הנבחר.
*   **קבצים שהושפעו**: `routes/guide.py`.

### 7. הסרת ייבוא לא בשימוש
*   **השינוי**: הסרת `get_minimum_wage` מהייבוא ב-`routes/guide.py`.
*   **הסבר**: לאחר המעבר ל-`get_minimum_wage_for_month`, הייבוא הישן הפך למיותר.
*   **קבצים שהושפעו**: `routes/guide.py`.

### 8. תמיכה ב-rate_apartment_type_id לדריסת סוג דירה
*   **השינוי**: הוספת לוגיקה לבדיקת `rate_apartment_type_id` בדיווחים.
*   **הסבר**:
    *   אם שדה `rate_apartment_type_id` מוגדר בדיווח, המערכת תשתמש בו לחישוב תעריף הכוננות.
    *   סדר עדיפויות: `rate_apartment_type_id` > היסטורי > נוכחי.
    *   שימושי כאשר רוצים לחשב תעריף לפי סוג דירה שונה מהדירה בה בוצעה המשמרת בפועל.
*   **קבצים שהושפעו**: `logic.py`, `app_utils.py`.

### 9. תמיכה בתעריפי כוננות היסטוריים
*   **השינוי**: תיקון קריאות ל-`get_standby_rate` ב-`app_utils.py` להעברת פרמטרי year ו-month.
*   **הסבר**:
    *   הפונקציה `get_standby_rate` כבר תמכה בתעריפים היסטוריים, אבל הקריאות אליה לא העבירו את החודש והשנה.
    *   עכשיו תעריפי כוננות משתמשים בלוגיקת "valid until" כמו סוגי דירות ומצב אישי.
    *   לדוגמה: אם שונה תעריף כוננות ל-50 ש"ח מ-01/2026, חודשים קודמים יציגו את התעריף הישן.
*   **קבצים שהושפעו**: `app_utils.py` (שורות 902, 1185).

### 10. עדיפות למשמרת שבת/חג בחישוב כוננות
*   **השינוי**: כשיש משמרת שבת/חג ביום עם כוננות, המערכת תשתמש בתעריף הכוננות של משמרת השבת.
*   **הסבר**:
    *   כשיש משמרת שבת ומשמרת לילה באותו יום (למשל 27/12/2025), הכוננות צריכה להיות לפי תעריף השבת (145 ש"ח) ולא לפי תעריף הלילה (70 ש"ח).
    *   הוספת מעקב אחר `shift_type_id` לכל יום (`day_shift_types`).
    *   הוספת מיפוי `shabbat_standby_seg_ids` שמחזיק את ה-segment_id של סגמנט הכוננות של כל משמרת שבת.
    *   אם ביום יש משמרת שבת, כל הכוננויות באותו יום משתמשות ב-segment_id של משמרת השבת לחישוב התעריף.
*   **קבצים שהושפעו**: `app_utils.py`.

---

בתאריך 07/01/2026 בוצעו העדכונים הבאים במערכת:

## 1. הרחבת מנגנון תעריפי משמרות (wage_percentage)
*   **השינוי**: הוספת תמיכה בשדה "אחוז שכר" (`wage_percentage`) ברמת סוג המשמרת וההיסטוריה שלה.
*   **הסבר**: מעתה המערכת שומרת ומשחזרת מההיסטוריה לא רק את התעריף השעתי אלא גם את האחוז המוגדר למשמרת.
*   **קבצים שהושפעו**: `history.py`, `logic.py`.

## 2. עדיפות לסוג דירה לצורך תעריף (rate_apartment_type_id)
*   **השינוי**: הוספת תמיכה בשדה `rate_apartment_type_id` בדוחות השעות.
*   **הסבר**: במידה ומוגדר סוג דירה ספציפי לדיווח, המערכת תשתמש בו לצורך חישוב התעריף והכוננות, תוך עקיפת סוג הדירה ההיסטורי או הנוכחי של הדירה עצמה.
*   **קבצים שהושפעו**: `logic.py`, `app_utils.py`.

## 3. פישוט לוגיקת בחירת תעריף ב-UI
*   **השינוי**: עדכון הפונקציה `get_effective_hourly_rate` ב-`app_utils.py`.
*   **הסבר**: המערכת תשתמש בתעריף המוגדר למשמרת בכל פעם שהוא קיים, ללא תלות בסימון "שכר מינימום", כדי להבטיח עקביות בין התצוגה לחישובים.
*   **קבצים שהושפעו**: `app_utils.py`.

## 4. שיפור חישוב "תעריף משתנה"
*   **השינוי**: שיפור הלוגיקה שמחשבת את ההפרשים בין תעריף משמרת לשכר המינימום ב-`logic.py`.
*   **הסבר**: הקוד הפך לישיר ומדויק יותר בבניית מפת התעריפים המשתנים לפי הדיווחים בפועל.

## 5. עדכון לוגיקת היסטוריה (המשך)
*   **השינוי**: עדכון לוגיקת השאילתות של "בתוקף עד" (Valid Until).
*   **הסבר**: מעתה, רשומה היסטורית המוגדרת עד חודש X, תקפה **עד ולא כולל** את חודש X.
*   **קבצים שהושפעו**: `history.py`.

## 2. משמרת ליווי רפואי (ID 148) - מינימום שעה לתשלום
*   **השינוי**: הוספת בונוס דקות אוטומטי למשמרות שקצרות מ-60 דקות.
*   **הסבר**: 
    *   חישוב השכר (Payroll) יתבצע על מינימום 60 דקות (במידה והדיווח קצר מכך).
    *   הדיווח ב-UI מציג את השעות המקוריות (זמן אמת) כדי לשמור על דיוק הדיווחים.
    *   סיכום שעות העבודה החודשי כולל רק את דקות העבודה בפועל.
*   **קבצים שהושפעו**: `logic.py`, `app_utils.py`.

## 3. עדכון תעריף משמרת ניקיון (ID 147)
*   **השינוי**: עדכון התעריף ל-50 ש"ח (5000 אגורות) החל מ-01/2026.
*   **הסבר**: 
    *   התעריף הקודם (40 ש"ח) נשמר בטבלת ההיסטוריה עד ל-12/2025.
    *   עודכן בבסיס הנתונים הראשי (Production) ובבסיס הנתונים של הדמו (Demo).

## 4. תיקון עקביות בתצוגת הדוחות (UI)
*   **השינוי**: החלת תעריפים היסטוריים גם בתצוגת "פירוט רצפים".
*   **הסבר**: תוקן באג שבו ה-UI הציג תעריף נוכחי גם עבור חודשי עבר. מעתה, אם קיים תעריף היסטורי בטבלה, הוא יוצג בדוח החודשי המתאים.
*   **קבצים שהושפעו**: `app_utils.py`.

---
**סטטוס אימות**: כל השינויים נבדקו ואומתו מול בסיסי הנתונים (פיתוח ועבודה).
