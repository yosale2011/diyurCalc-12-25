# מפרט חישוב שכר - DiyurCalc

## סקירה כללית

מערכת חישוב השכר מבוססת על **מקור אמת יחיד** בקובץ `app_utils.py`.
המערכת מחשבת שכר למדריכים בדיור מוגן, עם תמיכה בשעות נוספות, תוספות שבת, כוננויות, ומשמרות מיוחדות.

---

## ארכיטקטורה

```
┌─────────────────────────────────────────────────────────────────┐
│                        core/logic.py                            │
│              (מעטפת API - קורא ל-app_utils)                      │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                       app_utils.py                              │
│                    (מקור האמת היחיד)                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  get_daily_segments_data()     - בניית סגמנטים יומיים   │   │
│  │  aggregate_daily_segments_to_monthly() - צבירה חודשית   │   │
│  │  _calculate_chain_wages()      - חישוב שכר לרצף         │   │
│  │  calculate_wage_rate()         - קביעת אחוז שכר         │   │
│  │  get_standby_rate()            - תעריף כוננות           │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────┬───────────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          ▼               ▼               ▼
┌─────────────────┐ ┌───────────────┐ ┌───────────────────┐
│ core/constants  │ │core/time_utils│ │ core/sick_days.py │
│  (קבועים)       │ │ (זמנים, שבת)  │ │  (ימי מחלה)       │
└─────────────────┘ └───────────────┘ └───────────────────┘
```

---

## טבלת כל סוגי המשמרות

### טבלה מרכזית - סיכום כל המשמרות

| ID | שם המשמרת | קבוע בקוד | סגמנטים | חישוב רצף | בדיקת שעות לילה | ספי 7/9 שעות | תעריף | הערות מיוחדות |
|----|-----------|-----------|---------|-----------|-----------------|--------------|-------|---------------|
| **103** | חול רגיל | - | דינמיים | ✅ | ✅ | ✅ | שכר מינימום | משמרת ברירת מחדל |
| **105** | שישי/ערב חג | `FRIDAY_SHIFT_ID` | דינמיים | ✅ | ✅ | ✅ | שכר מינימום | תוספת שבת 50% |
| **106** | שבת/חג | `SHABBAT_SHIFT_ID` | דינמיים | ✅ | ✅ | ✅ | שכר מינימום | תוספת שבת 50% |
| **107** | לילה | `NIGHT_SHIFT_ID` | **דינמיים מיוחדים** | ✅ | ✅ | ✅ | שכר מינימום | 2שעות עבודה→כוננות→עבודת בוקר |
| **108** | תגבור שישי | `TAGBUR_FRIDAY_SHIFT_ID` | **קבועים** | ❌ | ❌ | ❌ | שכר מינימום | אחוזים קבועים מהסגמנטים |
| **109** | תגבור שבת | `TAGBUR_SHABBAT_SHIFT_ID` | **קבועים** | ❌ | ❌ | ❌ | שכר מינימום | אחוזים קבועים מהסגמנטים |
| **120** | ליווי בי"ח | `HOSPITAL_ESCORT_SHIFT_ID` | דינמיים | ✅ | ✅ | ✅ | **מיוחד** | בשבת = שכר מינימום בלבד |
| **147** | ניקיון | - | דינמיים | ✅ | ✅ | ✅ | **מיוחד (50₪)** | תעריף שעתי קבוע |
| **148** | ליווי רפואי | `MEDICAL_ESCORT_SHIFT_ID` | דינמיים | ✅ | ✅ | ✅ | **מיוחד** | מינימום 60 דקות לתשלום |
| **149** | שמירה על דייר | - | דינמיים | ✅ | ✅ | ✅ | **מיוחד (40₪)** | מבטל כוננות (11-12/2025) |
| - | חופשה | - | **קבועים** | ❌ | ❌ | ❌ | שכר מינימום | 8 שעות קבועות |
| - | מחלה | - | **קבועים** | ❌ | ❌ | ❌ | שכר מינימום | תשלום מדורג לפי חוק |

### מקרא העמודות

| עמודה | הסבר |
|-------|------|
| **סגמנטים** | `דינמיים` = לפי שעות דיווח בפועל, `קבועים` = מוגדרים מראש במשמרת |
| **חישוב רצף** | האם המשמרת משתתפת בחישוב רצפי עבודה (chains) עם carryover |
| **בדיקת שעות לילה** | האם נבדק כמה שעות בטווח 22:00-06:00 |
| **ספי 7/9 שעות** | האם מקבל הטבת ספים מופחתים (7/9 שעות במקום 8/10) כשיש 2+ שעות לילה |
| **תעריף** | `שכר מינימום` = תעריף בסיסי, `מיוחד` = תעריף שעתי קבוע מהגדרת המשמרת |

### פירוט ההבדלים בין מסלולי החישוב

#### מסלול 1: משמרות עם סגמנטים קבועים
**כולל:** תגבור (108/109), חופשה, מחלה

```
❌ לא מחשבים רצפים (chains)
❌ לא בודקים שעות לילה
❌ אין carryover בין ימים
✅ האחוזים נקבעים מראש בהגדרת הסגמנטים
```

#### מסלול 2: משמרות רגילות
**כולל:** חול (103), שישי (105), שבת (106), לילה (107), ליווי (120/148), ניקיון (147), שמירה (149)

```
✅ מחשבים רצפים (chains) עם carryover
✅ בודקים שעות לילה (22:00-06:00)
✅ ספים מופחתים (7/9 שעות) אם יש 2+ שעות לילה ברצף
✅ שעות נוספות מצטברות על פני כל יום העבודה
```

### דוגמאות מעשיות

#### דוגמה 1: משמרת חול עם שעות לילה
```
משמרת: 20:00-06:00 (10 שעות)
שעות לילה: 22:00-06:00 = 8 שעות ✅ (יותר מ-120 דקות)

ספים מופחתים:
  0-7 שעות (420 דק')  → 100%
  7-9 שעות (420-540)  → 125%
  9+ שעות (540+)      → 150%

תוצאה:
  420 דקות @ 100%
  120 דקות @ 125%
   60 דקות @ 150%
```

#### דוגמה 2: משמרת תגבור (לא מושפעת משעות לילה)
```
משמרת תגבור שבת: 15:00-22:00 (7 שעות)

חישוב: לפי סגמנטים קבועים בלבד
  15:00-18:00 → 100% (מוגדר בסגמנט)
  18:00-22:00 → 150% (מוגדר בסגמנט)

שעות לילה: לא נבדק! ❌
```

#### דוגמה 3: ניקיון/שמירה עם שעות לילה
```
שמירה על דייר: 22:00-06:00 (8 שעות)
שעות לילה: 8 שעות ✅

ספים מופחתים (כמו חול רגיל):
  420 דקות @ 100%
   60 דקות @ 125%
```

---

## קבועים (constants.py)

### זיהוי משמרות (Shift IDs)
```python
FRIDAY_SHIFT_ID = 105           # משמרת שישי/ערב חג
SHABBAT_SHIFT_ID = 106          # משמרת שבת/חג
NIGHT_SHIFT_ID = 107            # משמרת לילה
TAGBUR_FRIDAY_SHIFT_ID = 108    # תגבור שישי/ערב חג
TAGBUR_SHABBAT_SHIFT_ID = 109   # תגבור שבת/חג
HOSPITAL_ESCORT_SHIFT_ID = 120  # ליווי בי"ח
MEDICAL_ESCORT_SHIFT_ID = 148   # ליווי רפואי
```

### ספי שעות נוספות (בדקות)
```python
# יום רגיל (8 שעות עבודה)
REGULAR_HOURS_LIMIT = 480       # 8 שעות → 100%
OVERTIME_125_LIMIT = 600        # 10 שעות → 125%
# מעל 10 שעות → 150%

# משמרת לילה (7 שעות עבודה)
NIGHT_REGULAR_HOURS_LIMIT = 420 # 7 שעות → 100%
NIGHT_OVERTIME_125_LIMIT = 540  # 9 שעות → 125%
# מעל 9 שעות → 150%
```

### קבועי כוננות
```python
STANDBY_CANCEL_OVERLAP_THRESHOLD = 0.70  # 70% חפיפה = ביטול
DEFAULT_STANDBY_RATE = 70.0              # תעריף ברירת מחדל
MAX_CANCELLED_STANDBY_DEDUCTION = 70.0   # ניכוי מקסימלי
```

### קבועי רצף עבודה
```python
BREAK_THRESHOLD_MINUTES = 60    # הפסקה > 60 דקות שוברת רצף
```

### זיהוי שעות לילה
```python
NIGHT_HOURS_START = 1320        # 22:00
NIGHT_HOURS_END = 360           # 06:00
NIGHT_HOURS_THRESHOLD = 120     # 2 שעות לפחות = משמרת לילה
```

---

## חישוב אחוזי שכר

### פונקציה: `calculate_wage_rate()`
**מיקום:** `app_utils.py:116`

```python
def calculate_wage_rate(
    minutes_in_chain: int,    # דקות שנצברו ברצף
    is_shabbat: bool,         # האם בשבת הלכתית
    is_night_shift: bool = False  # האם משמרת לילה
) -> str:
    """מחזיר: "100%", "125%", "150%", "175%", או "200%" """
```

### טבלת חישוב - יום חול רגיל

| שעות ברצף | דקות | אחוז שכר |
|-----------|------|----------|
| 0-8       | 0-480 | 100%    |
| 8-10      | 480-600 | 125%  |
| 10+       | 600+  | 150%    |

### טבלת חישוב - משמרת לילה

| שעות ברצף | דקות | אחוז שכר |
|-----------|------|----------|
| 0-7       | 0-420 | 100%    |
| 7-9       | 420-540 | 125%  |
| 9+        | 540+  | 150%    |

### תוספת שבת (+50%)

| בסיס חול | + תוספת שבת | סה"כ שבת |
|----------|-------------|----------|
| 100%     | +50%        | **150%** |
| 125%     | +50%        | **175%** |
| 150%     | +50%        | **200%** |

---

## אלגוריתם חישוב רצף (Chain)

### פונקציה: `_calculate_chain_wages()`
**מיקום:** `app_utils.py:148`

### תרשים זרימה

```
┌────────────────────────────────────────────────────┐
│              קלט: רשימת סגמנטי עבודה               │
│     [(start_min, end_min, shift_id), ...]         │
└───────────────────────┬────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────┐
│    חישוב סה"כ דקות + offset מיום/חודש קודם         │
│    (כולל carryover מהחודש הקודם אם רלוונטי!)       │
└───────────────────────┬────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────┐
│              עיבוד בלוקים לפי גבולות:              │
│    • 480 דקות (מעבר 100% → 125%)                  │
│    • 600 דקות (מעבר 125% → 150%)                  │
│    • גבולות שבת (כניסה/יציאה)                     │
└───────────────────────┬────────────────────────────┘
                        │
          ┌─────────────┴─────────────┐
          ▼                           ▼
┌──────────────────┐        ┌──────────────────┐
│   לא שישי/שבת    │        │    שישי/שבת     │
│  חישוב רגיל      │        │  5 מקרים:        │
│                  │        │  1. לפני שבת     │
│                  │        │  2. בתוך שבת     │
│                  │        │  3. אחרי שבת     │
│                  │        │  4. חוצה כניסה   │
│                  │        │  5. חוצה יציאה   │
└────────┬─────────┘        └────────┬─────────┘
         │                           │
         └─────────────┬─────────────┘
                       ▼
┌────────────────────────────────────────────────────┐
│                    פלט:                            │
│  calc100, calc125, calc150, calc175, calc200      │
│  calc150_shabbat, calc150_overtime                │
│  segments_detail (לתצוגה)                         │
└────────────────────────────────────────────────────┘
```

### מבנה הפלט

```python
{
    "calc100": 480,              # דקות ב-100%
    "calc125": 120,              # דקות ב-125%
    "calc150": 60,               # דקות ב-150%
    "calc175": 0,                # דקות ב-175% (שבת)
    "calc200": 0,                # דקות ב-200% (שבת)
    "calc150_shabbat": 0,        # 150% שבת (בסיס+תוספת)
    "calc150_overtime": 60,      # 150% שעות נוספות (חול)
    "calc150_shabbat_100": 0,    # רכיב בסיס של 150% שבת
    "calc150_shabbat_50": 0,     # רכיב תוספת של 150% שבת
    "segments_detail": [
        (480, 960, "100%", False),      # start, end, label, is_shabbat
        (960, 1080, "125%", False),
        (1080, 1140, "150%", False),
    ]
}
```

---

## מערכת רצפי עבודה (Chains)

### הגדרת רצף

רצף = עבודה רציפה ללא הפסקה. רצף נשבר על ידי:

1. **הפסקה > 60 דקות** - מאפס את הספירה
2. **כוננות** - שוברת רצף (אלא אם עבודה חופפת ≥70%)
3. **שינוי תעריף** - שובר רצף אבל **מעביר offset**

### יום עבודה

```
יום עבודה = 08:00 עד 08:00 למחרת (לא 00:00-24:00!)

דוגמה: דיווח 22:00-06:30
        → שייך ליום העבודה שמתחיל ב-08:00 של אותו יום
        → 22:00 = דקה 840 (ביום העבודה)
        → 06:30 = דקה 1350 (בציר מנורמל)
```

### נרמול זמנים

```
זמנים לפני 08:00 מקבלים +1440 דקות

08:00 = 480 דקות מחצות
זמן מנורמל = זמן + (1440 אם זמן < 480)

דוגמה:
  06:30 = 390 דקות מחצות
  מנורמל = 390 + 1440 = 1830
```

### Carryover (העברה בין ימים וחודשים)

ה-Carryover עובד **גם בין חודשים** - לא רק בין ימים באותו חודש!

```python
# app_utils.py:1321-1326 - אתחול carryover מהחודש הקודם
prev_month_carryover_minutes, prev_month_chain_end, prev_month_chain_shift_id, prev_month_night_minutes = \
    _calculate_previous_month_carryover(conn, person_id, year, month, minimum_wage)

prev_day_carryover_minutes = prev_month_carryover_minutes  # מאתחל את ה-carryover הראשון מהחודש הקודם!
```

**פונקציה:** `_calculate_previous_month_carryover()`
**מיקום:** `app_utils.py:462-790`

```python
def _calculate_previous_month_carryover(conn, person_id, year, month, minimum_wage):
    """
    מחשב carryover מהחודש הקודם - חיפוש איטרטיבי אחורה עד שבירת רצף.

    הפונקציה מחפשת אחורה מהיום האחרון של החודש הקודם, יום אחר יום,
    עד שמוצאת יום ללא דיווחים (שבירת רצף).

    השלבים:
    1. מציאת היום האחרון של החודש הקודם (31/12 אם ינואר)
    2. חיפוש איטרטיבי אחורה - עד יום ללא דיווחים (מקסימום 31 ימים)
    3. שליפת כל הדיווחים מהטווח שנמצא
    4. ארגון הדיווחים לפי ימים עם offset מצטבר
    5. בניית רצפי עבודה לפי כללי שבירת רצף (הפסקה/כוננות/תעריף)
    6. החזרת סה"כ הדקות ברצף האחרון (כולל ימים קודמים!)

    Returns:
        (minutes_in_chain,      # דקות שנצברו ברצף (כולל מימים קודמים!)
         chain_end_time,        # זמן סיום הרצף (דקות מנורמלות)
         last_shift_id,         # shift_id של הרצף האחרון
         night_minutes)         # דקות לילה ברצף (לזיהוי משמרת לילה)
    """
```

**דוגמה - רצף חוצה מספר ימים:**
```
29 בדצמבר: עבודה 08:00-08:00 למחרת (24 שעות = 1440 דקות)
30 בדצמבר: עבודה 08:00-08:00 למחרת (24 שעות = 1440 דקות)
31 בדצמבר: עבודה 08:00-08:00 למחרת (24 שעות = 1440 דקות)
 1 בינואר: עבודה 08:00-12:00 (4 שעות = 240 דקות)

carryover = 4320 דקות (72 שעות מ-3 ימים רצופים!)
יום 1/1 → כל 240 הדקות ב-150% (כי כבר חצינו את סף 600 דקות מזמן)
```

**דוגמה - רצף יום בודד:**
```
31 בדצמבר: עבודה 16:00-08:00 למחרת (16 שעות = 960 דקות)
 1 בינואר: עבודה 08:00-12:00 (4 שעות = 240 דקות)

carryover = 960 דקות
יום 1/1 → 240 דק' ב-150% (כבר צברנו 960 דק' מ-31/12)
```

**תנאי Carryover:**
- הפסקה בין סוף הרצף לתחילת העבודה < 60 דקות
- אותו תעריף שעתי (או מעבר offset בשינוי תעריף)
- רציפות ימים (יום ללא דיווחים שובר רצף)
- מגבלת בטיחות: חיפוש עד 31 ימים אחורה מקסימום

---

## סוגי משמרות מיוחדות

### 1. משמרת לילה (ID: 107)

**סגמנטים דינמיים לפי זמן כניסה:**

```
┌─────────────────────────────────────────────────────────┐
│  כניסה                                         יציאה  │
│    │                                              │    │
│    ├──2 שעות──┬────כוננות────┬──90 דק'──┤    │
│    │   עבודה  │    (24%)     │  עבודה   │         │
│    │          │              │  בוקר    │         │
│    ▼          ▼              ▼          ▼         │
│  entry    entry+120       06:30      08:00       │
└─────────────────────────────────────────────────────────┘
```

**מיקום בקוד:** `app_utils.py:934-1000`

```python
WORK_FIRST_HOURS = 120    # 2 שעות ראשונות = עבודה
STANDBY_END = 390         # 06:30 = סוף כוננות
MORNING_WORK_START = 390  # 06:30 = תחילת עבודת בוקר
MORNING_WORK_END = 480    # 08:00 = סוף עבודת בוקר
```

**זיהוי משמרת לילה:**
```python
def qualifies_as_night_shift(work_segments: list) -> bool:
    """
    משמרת מוכרת כלילה אם 2+ שעות בטווח 22:00-06:00
    """
    total_night = sum(
        calculate_night_hours_in_segment(start, end)
        for start, end in work_segments
    )
    return total_night >= 120  # NIGHT_HOURS_THRESHOLD
```

### 2. משמרות תגבור (IDs: 108, 109)

**מאפיינים:**
- סגמנטים קבועים (לא דינמיים)
- לא תלוי בשעות דיווח בפועל
- ספי שעות רגילים (8 שעות)

**מיקום בקוד:** `app_utils.py:1001-1055`

### 3. תגבור משתמע (Implicit Tagbur)

```python
def is_implicit_tagbur(shift_id, actual_apt_type, rate_apt_type) -> bool:
    """
    תנאי: משמרת שישי (105) או שבת (106)
          בדירה טיפולית (apt_type=2)
          עם תעריף דירה רגילה (rate_type=1)
    """
    is_friday_or_shabbat = shift_id in {105, 106}
    is_therapeutic_apt = (actual_apt_type == 2)
    is_regular_rate = (rate_apt_type == 1)
    return is_friday_or_shabbat and is_therapeutic_apt and is_regular_rate
```

### 4. ליווי בי"ח (ID: 120)

**מיקום בקוד:** `app_utils.py:1554-1559`

```python
# בשבת הלכתית - שכר מינימום (לא התעריף המיוחד)
if is_hospital_escort_shift(sid) and is_shabbat_segment:
    pay_rate = minimum_wage
else:
    pay_rate = effective_rate
```

### 5. ליווי רפואי (ID: 148)

**מיקום בקוד:** `app_utils.py:894-909, 1714-1733`

```python
# מינימום 60 דקות לחיוב
is_medical_escort = (shift_type_id == 148)
if is_medical_escort:
    duration = rep_end_orig - rep_start_orig
    if duration < 60:
        escort_bonus_minutes = 60 - duration
        # בונוס משולם בנפרד - לא נוסף לרצף!
```

---

## מערכת כוננויות (Standby)

### תעריפי כוננות

**פונקציה:** `get_standby_rate()`
**מיקום:** `app_utils.py:66-109`

```python
def get_standby_rate(conn, segment_id, apartment_type_id, is_married, year, month):
    """
    עדיפות 1: תעריף ספציפי לסוג דירה + מצב משפחתי (priority=10)
    עדיפות 2: תעריף כללי למצב משפחתי (priority=0)
    ברירת מחדל: 70₪
    """
```

### לוגיקת ביטול/קיצוץ

**מיקום:** `app_utils.py:1464-1520`

```
┌─────────────────────────────────────────────────────────┐
│                  חפיפה עם עבודה                        │
│                                                         │
│   חפיפה ≥ 70%         │        חפיפה < 70%             │
│        │              │              │                  │
│        ▼              │              ▼                  │
│   ביטול כוננות       │        קיצוץ כוננות             │
│   (CANCEL)           │         (TRIM)                  │
│        │              │              │                  │
│        ▼              │              ▼                  │
│  תשלום חלקי:         │    תשלום מלא על                │
│  max(0, rate - 70)   │    הזמן שנותר                   │
└─────────────────────────────────────────────────────────┘
```

### כלל פעם ביום

```python
# כוננות משולמת מקסימום פעם ביום לכל סוג דירה
standby_key = ("apt", apartment_type_id)
if standby_key in paid_standby_ids:
    continue  # כבר שולם
paid_standby_ids.add(standby_key)
```

---

## ימי מחלה

### זיהוי רצפי מחלה

**פונקציה:** `_identify_sick_day_sequences()`
**מיקום:** `core/sick_days.py:11-64`

```python
# דוגמה:
# 1 בינואר: יום 1 ברצף
# 2 בינואר: יום 2 ברצף
# 3 בינואר: יום 3 ברצף
# 5 בינואר: יום 1 ברצף חדש (הפסקה > יום)
```

### אחוזי תשלום

**פונקציה:** `get_sick_payment_rate()`
**מיקום:** `core/sick_days.py:67-82`

| יום ברצף | אחוז תשלום |
|----------|-----------|
| יום 1    | 0%        |
| יום 2-3  | 50%       |
| יום 4+   | 100%      |

```python
def get_sick_payment_rate(sick_day_number: int) -> float:
    if sick_day_number == 1:
        return 0.0      # יום ראשון - 0%
    elif sick_day_number <= 3:
        return 0.5      # ימים 2-3 - 50%
    else:
        return 1.0      # מיום 4 - 100%
```

---

## צבירה חודשית

### פונקציה: `aggregate_daily_segments_to_monthly()`
**מיקום:** `app_utils.py:2405+`

### מבנה הפלט

```python
{
    # דקות לפי אחוז
    "calc100": 2400,              # 40 שעות ב-100%
    "calc125": 300,               # 5 שעות ב-125%
    "calc150": 180,               # 3 שעות ב-150%
    "calc150_shabbat": 120,       # שבת ב-150%
    "calc150_shabbat_100": 120,   # רכיב בסיס
    "calc150_shabbat_50": 120,    # רכיב תוספת
    "calc150_overtime": 60,       # שעות נוספות 150%
    "calc175": 240,               # 4 שעות ב-175%
    "calc200": 120,               # 2 שעות ב-200%

    # תשלומים לפי אחוז
    "payment_calc100": 1600.0,
    "payment_calc125": 250.0,
    "payment_calc150": 180.0,
    "payment_calc150_overtime": 60.0,
    "payment_calc150_shabbat": 120.0,
    "payment_calc175": 280.0,
    "payment_calc200": 160.0,

    # סיכומים
    "total_hours": 3240,          # סה"כ דקות עבודה
    "payment": 2470.0,            # תשלום עבודה
    "standby": 5,                 # מספר ימי כוננות
    "standby_payment": 350.0,     # תשלום כוננות

    # חופשה
    "vacation_minutes": 480,
    "vacation_payment": 160.0,
    "vacation_days_taken": 1,

    # מחלה
    "sick_minutes": 960,
    "sick_payment": 120.0,
    "sick_days_taken": 2,
    "sick_days_accrued": 1.5,

    # נוספים
    "travel": 100.0,
    "extras": 50.0,
    "actual_work_days": 22,
    "total_payment": 3250.0,      # סה"כ

    # תעריפים משתנים (אם רלוונטי)
    "calc_variable": 0,
    "payment_calc_variable": 0.0,
    "variable_rate_value": 34.40,
    "variable_rates": {}
}
```

---

## נתיבי הקריאה העיקריים

### 1. תצוגת מדריך (Guide View)
```
routes/guide.py
    → core/logic.py:calculate_person_monthly_totals()
        → app_utils.py:get_daily_segments_data()
        → app_utils.py:aggregate_daily_segments_to_monthly()
```

### 2. סיכום כללי (Summary)
```
routes/summary.py
    → core/logic.py:calculate_monthly_summary()
        → לכל עובד: calculate_person_monthly_totals()
```

### 3. ייצוא (Export)
```
routes/export.py
    → services/gesher_exporter.py
        → core/logic.py:calculate_person_monthly_totals()
```

---

## דוגמאות חישוב

### דוגמה 1: יום עבודה רגיל 10 שעות

```
דיווח: 08:00-18:00 (600 דקות)
תעריף שעתי: 35₪

חישוב:
  0-480 דקות (8 שעות) × 100% = 480 × (35/60) × 1.0 = 280₪
  480-600 דקות (2 שעות) × 125% = 120 × (35/60) × 1.25 = 87.5₪

סה"כ: 367.5₪
```

### דוגמה 2: עבודה בשבת

```
דיווח: שישי 16:00 - שבת 08:00 (16 שעות = 960 דקות)
שבת נכנסת: 16:30
תעריף: 35₪

חישוב (בהנחה שכל הזמן בשבת מ-16:30):
  לפני שבת (16:00-16:30): 30 דק' × 100% = 30 × (35/60) × 1.0 = 17.5₪

  בשבת:
    16:30-00:30 (8 שעות): 480 × (35/60) × 1.5 = 420₪   [150% שבת]
    00:30-02:30 (2 שעות): 120 × (35/60) × 1.75 = 122.5₪ [175% שבת]
    02:30-08:00 (5.5 שעות): 330 × (35/60) × 2.0 = 385₪ [200% שבת]

סה"כ: 945₪
```

### דוגמה 3: רצף עם Carryover

```
יום א': 08:00-08:00 למחרת (24 שעות)
יום ב': 08:00-12:00 (4 שעות)

חישוב יום א':
  0-8 שעות: 100%
  8-10 שעות: 125%
  10+ שעות: 150%

  סה"כ: 480@100% + 120@125% + 840@150%

חישוב יום ב' (עם carryover של 1440 דקות):
  דקות 1440-1680 = כל 4 השעות ב-150%!
```

---

## פונקציות עזר

### זיהוי סוג משמרת

```python
# core/constants.py

def is_tagbur_shift(shift_id: int | None) -> bool:
    return shift_id in {108, 109}

def is_night_shift(shift_id: int | None) -> bool:
    return shift_id == 107

def is_shabbat_shift(shift_id: int | None) -> bool:
    return shift_id in {105, 106}

def is_hospital_escort_shift(shift_id: int | None) -> bool:
    return shift_id == 120

def is_medical_escort_shift(shift_id: int | None) -> bool:
    return shift_id == 148
```

### חישוב שעות לילה

```python
# core/constants.py:158-188

def calculate_night_hours_in_segment(start_min: int, end_min: int) -> int:
    """
    מחשב כמה דקות מסגמנט נופלות בטווח 22:00-06:00
    """
```

---

## הפניות לקוד

| נושא | קובץ | שורות |
|------|------|-------|
| קבועים | `core/constants.py` | 1-206 |
| חישוב אחוז שכר | `app_utils.py` | 116-141 |
| חישוב רצף | `app_utils.py` | 148-428 |
| Carryover | `app_utils.py` | 462-735 |
| סגמנטים יומיים | `app_utils.py` | 738-2400 |
| משמרת לילה דינמית | `app_utils.py` | 934-1000 |
| משמרות תגבור | `app_utils.py` | 1001-1055 |
| ביטול כוננות | `app_utils.py` | 1464-1520 |
| ימי מחלה | `core/sick_days.py` | 11-82 |
| זמני שבת | `core/time_utils.py` | כל הקובץ |

---

## גרסה

מסמך זה מתאר את מערכת חישוב השכר בגרסה **2.09** של DiyurCalc.

נכתב: ינואר 2026
