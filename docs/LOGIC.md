# DiyurCalc - לוגיקת חישוב שכר מפורטת

## תוכן עניינים
1. [מבנה יום עבודה](#מבנה-יום-עבודה)
2. [סוגי משמרות](#סוגי-משמרות)
3. [חישוב רצף עבודה (Chain)](#חישוב-רצף-עבודה-chain)
4. [חישוב שעות נוספות](#חישוב-שעות-נוספות)
5. [חישוב שבת וחג](#חישוב-שבת-וחג)
6. [טיפול בכוננות (Standby)](#טיפול-בכוננות-standby)
7. [משמרות תגבור](#משמרות-תגבור)
8. [העברת דקות בין ימים (Carryover)](#העברת-דקות-בין-ימים-carryover)
9. [נרמול זמנים](#נרמול-זמנים)
10. [תרשים זרימה](#תרשים-זרימה)

---

## מבנה יום עבודה

### הגדרה בסיסית
- **יום עבודה** מוגדר מ-**08:00 בבוקר** עד **08:00 בבוקר למחרת**
- זה שונה מיום קלנדרי רגיל (00:00-24:00)
- דיווח שמתחיל ב-22:00 ומסתיים ב-06:30 למחרת שייך **כולו** ליום העבודה של היום הראשון

### דוגמה
```
יום עבודה של יום שלישי 18/11/2025:
├── התחלה: שלישי 18/11 בשעה 08:00
├── חצות: רביעי 19/11 בשעה 00:00 (עדיין יום עבודה שלישי!)
└── סיום: רביעי 19/11 בשעה 08:00
```

### קבועים
```python
MINUTES_PER_DAY = 1440        # דקות ביום (24 * 60)
WORK_DAY_CUTOFF = 480         # 08:00 בדקות מחצות
REGULAR_HOURS_LIMIT = 480     # 8 שעות ראשונות = 100%
OVERTIME_125_LIMIT = 600      # שעות 9-10 = 125%
BREAK_THRESHOLD_MINUTES = 30  # הפסקה מעל 30 דקות שוברת רצף
```

---

## סוגי משמרות

### 1. משמרת רגילה
- עוברת דרך חישוב רצף עבודה מלא
- אחוזי שכר נקבעים לפי זמן עבודה מצטבר (8 שעות ראשונות = 100%, וכו')
- דוגמה: "משמרת בוקר", "משמרת ערב"

### 2. משמרת תגבור
- זיהוי: שם המשמרת מכיל את המילה **"תגבור"**
- דוגמאות: "תגבור שישי/ערב חג", "תגבור שבת/חג"
- **לא עוברת חישוב רצף** - משתמשת באחוזים הקבועים מהגדרת הסגמנטים
- הסגמנטים מוגדרים מראש עם אחוזים קבועים (למשל: 15:00-17:00 = 100%, 17:00-22:00 = 150%)

### 3. משמרת שישי/ערב חג (לא תגבור)
- דוגמה: "משמרת שישי/ערב חג"
- עוברת דרך חישוב רצף רגיל
- כוללת סגמנטים עם אחוזים מוגדרים מראש

### 4. משמרת חופשה/מחלה
- זיהוי: שם המשמרת מכיל "חופשה" או "מחלה"
- **סגמנטים קבועים** - משתמשים בסגמנטים המוגדרים במשמרת בלבד (לא לפי שעות הדיווח)
- תשלום לפי שכר מינימום * שעות הסגמנט המוגדר
- לא משפיעה על רצף עבודה
- **דוגמה**: "יום חופשה" עם סגמנט 16:00-23:30 = 7.5 שעות חופשה (גם אם הדיווח הוא 16:00-08:00)

### 5. משמרת לילה
- זיהוי: שם המשמרת בדיוק **"משמרת לילה"**
- **סגמנטים דינמיים** - נקבעים לפי זמן הכניסה בפועל (לא לפי הגדרת הסגמנטים)
- עוברת דרך חישוב רצף רגיל

#### החוק
1. **2 שעות ראשונות** מזמן הכניסה = **עבודה** (חישוב לפי רצף)
2. **מסוף 2 שעות עד 06:30** = **כוננות** (שוברת רצף)
3. **06:30-08:00** = **עבודה** (רצף חדש)

#### דוגמאות

**דוגמה 1: כניסה ב-20:00**
```
דיווח: 20:00-08:00 (12 שעות)
├── 20:00-22:00: עבודה (2 שעות ראשונות)
├── 22:00-06:30: כוננות (שוברת רצף)
└── 06:30-08:00: עבודה (רצף חדש)
```

**דוגמה 2: כניסה ב-00:00**
```
דיווח: 00:00-08:00 (8 שעות)
├── 00:00-02:00: עבודה (2 שעות ראשונות)
├── 02:00-06:30: כוננות (שוברת רצף)
└── 06:30-08:00: עבודה (רצף חדש)
```

**דוגמה 3: כניסה ב-23:00**
```
דיווח: 23:00-08:00 (9 שעות)
├── 23:00-01:00: עבודה (2 שעות ראשונות)
├── 01:00-06:30: כוננות (שוברת רצף)
└── 06:30-08:00: עבודה (רצף חדש)
```

#### קוד רלוונטי
```python
is_night_shift = (shift_name == "משמרת לילה")
if is_night_shift:
    entry_time = r_start  # זמן הכניסה בדקות

    WORK_FIRST_HOURS = 120      # 2 שעות = 120 דקות
    STANDBY_END = 390           # 06:30 = 390 דקות
    MORNING_WORK_END = 480      # 08:00 = 480 דקות

    # סגמנט 1: 2 שעות ראשונות עבודה
    work1_end = entry_time + WORK_FIRST_HOURS

    # סגמנט 2: כוננות עד 06:30
    standby_end = 390  # או 390+1440 אם נכנס אחרי 12:00

    # סגמנט 3: עבודה 06:30-08:00
    morning_work = (390, 480)
```

---

## חישוב רצף עבודה (Chain)

### מהו רצף?
רצף עבודה הוא סדרה רציפה של זמני עבודה **ללא הפסקה של יותר מ-30 דקות**.

### שבירת רצף
רצף נשבר כאשר:
1. **הפסקה > 30 דקות** בין סגמנטים עוקבים
2. **כוננות** שלא חופפת לעבודה
3. **חופשה/מחלה**

### דוגמה לרצף
```
16:00-22:00 עבודה
22:00-06:30 כוננות (שוברת רצף)
06:30-08:00 עבודה (רצף חדש)
```

### קוד רלוונטי
```python
# שבירת רצף
should_break = False
if current_chain_segments:
    if is_special:  # כוננות/חופשה
        should_break = True
    elif last_end is not None:
        gap = seg_start - last_end
        if gap > BREAK_THRESHOLD_MINUTES:  # > 30 דקות
            should_break = True
```

---

## חישוב שעות נוספות

### מדרגות תעריף (ימי חול)
| דקות מצטברות | אחוז שכר | תיאור |
|--------------|----------|-------|
| 0-480 | 100% | 8 שעות ראשונות |
| 481-600 | 125% | שעות 9-10 |
| 601+ | 150% | משעה 11 והלאה |

### חישוב בפועל
```python
def calculate_overtime_tier(minutes_processed):
    if minutes_processed <= REGULAR_HOURS_LIMIT:  # 480
        return "100%"
    elif minutes_processed <= OVERTIME_125_LIMIT:  # 600
        return "125%"
    else:
        return "150%"
```

### דוגמה
עובד עבד 12 שעות (720 דקות):
- דקות 1-480: 100% = 480 דקות
- דקות 481-600: 125% = 120 דקות
- דקות 601-720: 150% = 120 דקות

---

## חישוב שבת וחג

### זיהוי שבת
- **יום שישי** (weekday=4): מכניסת שבת (~16:20) עד חצות
- **יום שבת** (weekday=5): מחצות עד צאת שבת (~17:20)

### זמני שבת
```python
# ברירת מחדל (אם אין נתונים מהשרת)
DEFAULT_SHABBAT_ENTER = "16:20"  # כניסה
DEFAULT_SHABBAT_EXIT = "17:20"   # יציאה (למחרת)

# המרה לדקות מתחילת יום שישי
shabbat_enter = 16*60 + 20  # = 980 דקות
shabbat_exit = 24*60 + 17*60 + 20  # = 2500 דקות (יום שבת)
```

### תעריפי שבת
| מדרגת שעות נוספות | תעריף רגיל | תעריף שבת |
|-------------------|------------|-----------|
| שעות 1-8 | 100% | 150% |
| שעות 9-10 | 125% | 175% |
| שעה 11+ | 150% | 200% |

### פירוט תשלום שבת 150%
```
150% שבת = 100% (בסיס) + 50% (תוספת שבת)
         = calc150_shabbat_100 + calc150_shabbat_50
```

### נרמול זמנים לבדיקת שבת
```python
# זמנים מנורמלים (לפני 08:00) מקבלים +1440
# צריך להמיר חזרה לזמן אמיתי לפני בדיקת שבת
actual_minute = minute_in_day % MINUTES_PER_DAY

# בדיקה אם בתוך שבת
if abs_start_from_fri >= shabbat_enter and abs_end_from_fri <= shabbat_exit:
    # בתוך שבת - תעריף שבת
```

---

## טיפול בכוננות (Standby)

### מאפיינים
- כוננות **שוברת רצף עבודה** (אלא אם עבודה חופפת לה)
- תשלום קבוע לפי סוג דירה ומצב משפחתי
- כוננות לא נספרת כשעות עבודה לצורך מדרגות

### חישוב תשלום כוננות
```python
def get_standby_rate(segment_id, apartment_type_id, is_married):
    # תעריפים מוגדרים בטבלת standby_rates
    # לפי: סוג דירה (apartment_type_id) + מצב משפחתי (is_married)
    return rate  # סכום קבוע בש"ח
```

### מניעת תשלום כפול
- כוננות שמפוצלת על ידי עבודה באמצע - משלמים רק פעם אחת
- מעקב באמצעות `paid_standby_ids`

### קיזוז כוננות מעבודה
כשיש עבודה בתוך שעות כוננות, מקזזים:
```python
# אם עובד דיווח על עבודה 02:00-04:00 בתוך כוננות 22:00-08:00
# הכוננות מתחלקת ל:
# 22:00-02:00 (כוננות)
# 02:00-04:00 (עבודה - לא כוננות)
# 04:00-08:00 (כוננות)
# אבל משלמים על הכוננות רק פעם אחת!
```

---

## משמרות תגבור

### זיהוי
```python
is_fixed_segments_shift = "תגבור" in shift_name_str
```

### התנהגות מיוחדת
1. **לא מחשבים רצף** - כל סגמנט עומד בפני עצמו
2. **משתמשים באחוזים המוגדרים** - לא במדרגות שעות נוספות
3. **לא מושפע מ-carryover** - כל יום עצמאי

### דוגמה: תגבור שישי/ערב חג
```
הגדרת סגמנטים:
├── 15:00-17:00: work 100%
├── 17:00-22:00: work 150%
└── 22:00-08:00: standby

דיווח: 12:00-08:00 (למחרת)
תוצאה:
├── 15:00-17:00: 120 דקות @ 100%
├── 17:00-22:00: 300 דקות @ 150%
└── 22:00-08:00: כוננות (תשלום קבוע)
```

### עיבוד בקוד
```python
if is_fixed_segments_shift and seg_list:
    entry["is_fixed_segments"] = True
    # מוסיפים סגמנטים ישירות עם האחוזים המוגדרים
    for seg in seg_list:
        # לא מחשבים overlap עם שעות הדיווח
        # משתמשים בסגמנט כמו שהוא מוגדר
```

---

## העברת דקות בין ימים (Carryover)

### מתי מתבצע Carryover?
1. רצף עבודה **מסתיים בדיוק ב-08:00** (1920 מנורמל)
2. **היום הבא מתחיל ב-08:00** (480)
3. **הימים רציפים** (days_diff == 1)

### מה מועבר?
סך הדקות של הרצף האחרון מהיום הקודם.

### דוגמה
```
יום שלישי 18/11:
├── 16:00-22:00: 360 דקות
├── 22:00-06:30: כוננות (שוברת רצף)
└── 06:30-08:00: 90 דקות (רצף חדש, מסתיים ב-08:00)
    └── carryover ליום הבא: 90 דקות

יום רביעי 19/11:
├── 08:00-12:00: מתחיל עם offset של 90 דקות!
│   ├── דקות 91-390 (300 דקות): עדיין 100%
│   ├── דקות 391-480 (90 דקות): עדיין 100%
│   └── דקות 481-...: 125%
```

### איפוס Carryover
```python
# הימים לא רציפים - אין carryover
if prev_day_date is not None:
    days_diff = (day_date - prev_day_date).days
    if days_diff != 1:
        prev_day_carryover_minutes = 0

# משמרת תגבור - אין carryover
if entry.get("is_tagbur"):
    prev_day_carryover_minutes = 0
```

---

## נרמול זמנים

### הבעיה
זמנים לפני 08:00 (כמו 06:30) שייכים ליום העבודה **הקודם**, אבל מספרית הם קטנים יותר מזמנים מאוחרים (כמו 22:00).

### הפתרון
מוסיפים 1440 דקות (יום שלם) לזמנים לפני 08:00:
```python
if time_minutes < WORK_DAY_CUTOFF:  # < 480 (08:00)
    normalized_time = time_minutes + MINUTES_PER_DAY  # + 1440

# דוגמה:
# 06:30 = 390 דקות → 390 + 1440 = 1830 (מנורמל)
# 22:00 = 1320 דקות → נשאר 1320

# עכשיו: 1320 < 1830, כלומר 22:00 לפני 06:30 (נכון!)
```

### שימוש בבדיקת שבת
```python
# כשבודקים אם זמן בתוך שבת, צריך להמיר חזרה:
actual_block_start = block_abs_start % MINUTES_PER_DAY
# 1830 % 1440 = 390 = 06:30 (הזמן האמיתי)
```

---

## תרשים זרימה

### עיבוד דיווח יומי
```
┌─────────────────────────────────────────────────────────────┐
│                    קבלת דיווח                               │
│         (תאריך, שעת התחלה, שעת סיום, סוג משמרת)            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              בדיקה: האם משמרת תגבור?                        │
│              ("תגבור" in shift_name)                        │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │ כן                            │ לא
              ▼                               ▼
┌─────────────────────────┐   ┌─────────────────────────────────┐
│  עיבוד תגבור            │   │  פיצול לימי עבודה              │
│  - אחוזים קבועים        │   │  (08:00-08:00)                  │
│  - ללא חישוב רצף        │   └─────────────────────────────────┘
│  - ללא carryover        │                   │
└─────────────────────────┘                   ▼
              │               ┌─────────────────────────────────┐
              │               │  חישוב overlap עם סגמנטי משמרת  │
              │               └─────────────────────────────────┘
              │                               │
              │                               ▼
              │               ┌─────────────────────────────────┐
              │               │  בניית רצפי עבודה (chains)      │
              │               │  - שבירה בהפסקה > 30 דקות       │
              │               │  - שבירה בכוננות                │
              │               └─────────────────────────────────┘
              │                               │
              │                               ▼
              │               ┌─────────────────────────────────┐
              │               │  חישוב תעריף לכל בלוק           │
              │               │  - בדיקת מדרגת שעות נוספות      │
              │               │  - בדיקת גבולות שבת             │
              │               └─────────────────────────────────┘
              │                               │
              └───────────────┬───────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    עדכון carryover                          │
│         (אם רצף מסתיים ב-08:00 והימים רציפים)              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    חישוב תשלום סופי                         │
│    (סכום כל הבלוקים + כוננויות + חופשה/מחלה)               │
└─────────────────────────────────────────────────────────────┘
```

### חישוב בלוק בודד
```
┌─────────────────────────────────────────────────────────────┐
│                    בלוק עבודה                               │
│            (start_minute, end_minute, day_date)             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│           קביעת מדרגת שעות נוספות                           │
│  minutes_processed <= 480  →  100%                          │
│  minutes_processed <= 600  →  125%                          │
│  minutes_processed > 600   →  150%                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│           בדיקה: האם יום שישי/שבת?                          │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │ לא                            │ כן
              ▼                               ▼
┌─────────────────────────┐   ┌─────────────────────────────────┐
│  תעריף = מדרגה          │   │  נרמול זמנים + בדיקת גבולות     │
│  (100%/125%/150%)       │   │  שבת (כניסה/יציאה)              │
└─────────────────────────┘   └─────────────────────────────────┘
                                              │
                              ┌───────────────┴───────────────┐
                              │ לפני/אחרי שבת │ בתוך שבת      │
                              ▼               ▼
                ┌─────────────────┐ ┌─────────────────────────┐
                │ תעריף = מדרגה   │ │ תעריף = מדרגת שבת       │
                │ רגילה          │ │ (150%/175%/200%)        │
                └─────────────────┘ └─────────────────────────┘
```

---

## קבצים רלוונטיים

| קובץ | תיאור |
|------|-------|
| `logic.py` | פונקציות ליבה: `_calculate_chain_wages`, `_process_daily_map`, `is_shabbat_time` |
| `app_utils.py` | עיבוד נתונים לתצוגה: `get_daily_segments_data` |
| `utils.py` | פונקציות עזר: `overlap_minutes`, `month_range_ts` |
| `config.py` | קבועים: `LOCAL_TZ`, timezone settings |

---

## אזהרה חשובה: שני מקומות חישוב

### הבעיה
יש **2 מקומות נפרדים** שמחשבים את אותם נתונים:

| מיקום | פונקציה | מטרה |
|-------|---------|------|
| `logic.py` | `calculate_person_monthly_totals()` | סיכום חודשי לייצוא שכר |
| `app_utils.py` | `get_daily_segments_data()` | פירוט רצפים יומי לתצוגה |

### למה זה קריטי?
כששינית לוגיקת חישוב, **חובה לעדכן בשני המקומות** - אחרת יהיו פערים בין:
- טאב "פירוט רצפים" (מ-`app_utils.py`)
- טאב "ייצוא שכר" (מ-`logic.py`)

### דוגמה לבאג שקרה (דצמבר 2025)
שעות תגבור בשבת הופיעו נכון בדוח הרצפים אבל **לא** בייצוא שכר.
הסיבה: `_process_daily_map` עדכן `calc150_shabbat` אבל לא `calc150_shabbat_100`/`calc150_shabbat_50`.

### מה לעשות כששינית לוגיקה?
1. עדכן את `logic.py` (`_process_daily_map`, `_calculate_chain_wages`)
2. עדכן את `app_utils.py` (`get_daily_segments_data`) אם רלוונטי
3. בדוק שהמספרים זהים בשני הטאבים!

### משתנים שצריך לסנכרן
```
calc100, calc125, calc150, calc175, calc200
calc150_shabbat, calc150_overtime
calc150_shabbat_100, calc150_shabbat_50  <-- חשוב לפנסיה!
standby_payment, vacation_minutes
```

---

## עדכון אחרון
תאריך: 2025-12-22

### שינויים אחרונים
1. הוספת תמיכה ב**משמרת לילה** עם סגמנטים דינמיים לפי זמן הכניסה
2. תיקון דיווחים עצמאיים 00:00-08:00 (שמירה על תאריך המקורי)
3. תיקון זיהוי שבת לסגמנטים אחרי צאת שבת (06:30-08:00 ביום ראשון)
4. הוספת חישוב תעריף משתנה (variable rate) למשמרות עם תעריף שונה משכר מינימום
5. תיקון rotation של סגמנטים - כשדיווח מתחיל לפני הסגמנט הראשון
6. הוספת תמיכה במשמרות תגבור
7. **תיקון באג**: שעות תגבור בשבת לא נספרו ב-`calc150_shabbat_100`/`calc150_shabbat_50` (ייצוא שכר)
